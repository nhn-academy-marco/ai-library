# ì‹¤ìŠµ ë¯¸ì…˜: Week 5 Function Calling ì‹¤ìŠµ ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” Week 5 í•™ìŠµ ì¤‘ ì‹¤ìŠµí•´ ë³¼ ë¯¸ì…˜ë“¤ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“– ë¬¸ì„œ ì‚¬ìš©ë²•

ì´ ë¬¸ì„œëŠ” **ê° ë ˆë²¨ í•™ìŠµ í›„ ì‹¤ìŠµ**í•  ë•Œ ì°¸ê³ í•©ë‹ˆë‹¤.

```
í•™ìŠµ ìˆœì„œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 01. MCP ì´í•´ (ê°œë… í•™ìŠµ)                                        â”‚
â”‚     â†“                                                           â”‚
â”‚ 02. Level 1: ë‹¨ì¼ Function (í•™ìŠµ)                               â”‚
â”‚     â†“                                                           â”‚
â”‚    â­ ë¯¸ì…˜ 1 ì‹¤ìŠµ â† ì´ ë¬¸ì„œì˜ "ë¯¸ì…˜ 1" ì„¹ì…˜ ì°¸ê³                â”‚
â”‚     â†“                                                           â”‚
â”‚ 03. Level 2: ì™¸ë¶€ API Fallback (í•™ìŠµ)                           â”‚
â”‚     â†“                                                           â”‚
â”‚    â­â­ ë¯¸ì…˜ 2 ì‹¤ìŠµ â† ì´ ë¬¸ì„œì˜ "ë¯¸ì…˜ 2" ì„¹ì…˜ ì°¸ê³              â”‚
â”‚     â†“                                                           â”‚
â”‚ 04. Level 3: ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ (í•™ìŠµ)                             â”‚
â”‚     â†“                                                           â”‚
â”‚    â­â­â­ ë¯¸ì…˜ 3 ì‹¤ìŠµ â† ì´ ë¬¸ì„œì˜ "ë¯¸ì…˜ 3" ì„¹ì…˜ ì°¸ê³            â”‚
â”‚     â†“                                                           â”‚
â”‚    â­â­â­â­ ë¯¸ì…˜ 4 (ì¶”ê°€ ë„ì „)                                  â”‚
â”‚    â­â­â­â­â­ ë¯¸ì…˜ 5 (ì¶”ê°€ ë„ì „)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**í•™ìŠµ íŒ:**
- ê° ë ˆë²¨(02-04)ì˜ í•™ìŠµì„ ë§ˆì¹œ í›„, í•´ë‹¹ ë ˆë²¨ì˜ ë¯¸ì…˜ì„ ì‹¤ìŠµí•˜ì„¸ìš”
- â­~â­â­â­â­ ë¯¸ì…˜ê¹Œì§€ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ë©´ ë‹¨ê³„ë³„ ì‹¤ë ¥ì„ ìŒ“ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ë¯¸ì…˜ 4-5ëŠ” ì¶”ê°€ í•™ìŠµì´ í•„ìš”í•œ ê³ ë‚œì´ë„ ë„ì „ ê³¼ì œì…ë‹ˆë‹¤

---

## ğŸ¯ ë¯¸ì…˜ ë‚œì´ë„ ê°€ì´ë“œ

| ë‚œì´ë„ | ë ˆë²¨ | ì„¤ëª… | ì˜ˆìƒ ì‹œê°„ |
|--------|------|------|----------|
| â­ | ì…ë¬¸ | ë‹¨ì¼ Function í˜¸ì¶œ | 30ë¶„ |
| â­â­ | ì´ˆê¸‰ | 2-3ê°œ Function ì¡°í•© | 1ì‹œê°„ |
| â­â­â­ | ì¤‘ê¸‰ | ì¡°ê±´ë¶€ Function í˜¸ì¶œ + ë¡œì§ | 2ì‹œê°„ |
| â­â­â­â­ | ì¤‘ìƒë‹¨ê³„ | ë³µì¡í•œ ì›Œí¬í”Œë¡œìš° + ì—ëŸ¬ ì²˜ë¦¬ | 3ì‹œê°„ |
| â­â­â­â­â­ | ê³ ê¸‰ | Multi-Agent í˜‘ì—… | 4ì‹œê°„+ |

---

## â­ ë¯¸ì…˜ 1: ë‹¨ì¼ Function í˜¸ì¶œ - ë„ì„œ ê²€ìƒ‰

**ë‚œì´ë„**: ì…ë¬¸ | **ì˜ˆìƒ ì‹œê°„**: 30ë¶„

### ëª©í‘œ
AIê°€ ë‹¨ì¼ Functionì„ í˜¸ì¶œí•˜ì—¬ ë„ì„œë¥¼ ê²€ìƒ‰í•  ìˆ˜ ìˆê²Œ ë§Œë“­ë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
```
ì‚¬ìš©ì: "ìë°” ì±… 5ê¶Œ ì¶”ì²œí•´ì¤˜"

AI ë™ì‘:
1. search_books Function í˜¸ì¶œ
2. ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•˜ê²Œ ì„¤ëª…
```

### êµ¬í˜„ ê°€ì´ë“œ

#### 1ë‹¨ê³„: Function ì •ì˜

```java
@Component
@RequiredArgsConstructor
public class BookSearchFunctions {

    private final BookSearchService bookSearchService;

    @FunctionInfo(name = "search_books",
                  description = "ë„ì„œê´€ ì‹œìŠ¤í…œì—ì„œ ë„ì„œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. " +
                              "ê²€ìƒ‰ì–´(ì œëª©, ì €ì, ì¶œíŒì‚¬ ë“±)ìœ¼ë¡œ ë„ì„œë¥¼ ì°¾ìŠµë‹ˆë‹¤.")
    public List<BookDto> searchBooks(
        @FunctionParam(description = "ê²€ìƒ‰ì–´ (ë„ì„œ ì œëª©, ì €ìëª…, ì¶œíŒì‚¬ ë“±)") String keyword,
        @FunctionParam(description = "ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜ (ê¸°ë³¸ê°’: 10)", defaultValue = "10") int limit
    ) {
        return bookSearchService.search(keyword, limit);
    }
}
```

#### 2ë‹¨ê³„: ChatClientì— Function ë“±ë¡

```java
@Service
@RequiredArgsConstructor
public class AiChatService {

    private final ChatClient.Builder chatClientBuilder;
    private final BookSearchFunctions bookSearchFunctions;

    public String chat(String userMessage) {
        var chatClient = chatClientBuilder
            .defaultFunctions(bookSearchFunctions)  // Function ë“±ë¡
            .build();

        return chatClient.prompt()
            .user(userMessage)
            .call()
            .content();
    }
}
```

#### 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸

```java
@SpringBootTest
class BookSearchFunctionsTest {

    @Autowired
    private AiChatService aiChatService;

    @Test
    void testBookSearch() {
        String response = aiChatService.chat("ìë°” ì±… 5ê¶Œ ì¶”ì²œí•´ì¤˜");

        assertThat(response).contains("ìë°”");
        System.out.println(response);
    }
}
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `@FunctionInfo` ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ Function ì„¤ëª…
- [ ] `@FunctionParam`ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ì„¤ëª…
- [ ] ChatClientì— Function ë“±ë¡
- [ ] AIê°€ Functionì„ ì˜¬ë°”ë¥´ê²Œ í˜¸ì¶œí•˜ëŠ”ì§€ í™•ì¸
- [ ] ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•˜ê²Œ ì„¤ëª…

---

## â­â­ ë¯¸ì…˜ 2: ë³µìˆ˜ Function ì¡°í•© - ë„ì„œ ê²€ìƒ‰ + ë¦¬ë·° ì¡°íšŒ

**ë‚œì´ë„**: ì´ˆê¸‰ | **ì˜ˆìƒ ì‹œê°„**: 1ì‹œê°„

### ëª©í‘œ
AIê°€ 2ê°œ ì´ìƒì˜ Functionì„ ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬ ì¢…í•© ë‹µë³€ì„ ì œê³µí•©ë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
```
ì‚¬ìš©ì: "ì´ì±… ì •ë³´ ì•Œë ¤ì¤˜: ISBN 9788960777331"

AI ë™ì‘:
1. get_book_info Function í˜¸ì¶œ â†’ ë„ì„œ ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
2. get_book_reviews Function í˜¸ì¶œ â†’ í•´ë‹¹ ë„ì„œ ë¦¬ë·° ì¡°íšŒ
3. ë‘ ì •ë³´ë¥¼ ì¢…í•©í•˜ì—¬ ë‹µë³€ ì œê³µ
```

### êµ¬í˜„ ê°€ì´ë“œ

#### 1ë‹¨ê³„: ë„ì„œ ì •ë³´ ì¡°íšŒ Function

```java
@FunctionInfo(name = "get_book_info",
              description = "ISBNìœ¼ë¡œ ë„ì„œ ì •ë³´ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤")
public BookDto getBookInfo(
    @FunctionParam(description = "ISBN ì½”ë“œ (10ìë¦¬ ë˜ëŠ” 13ìë¦¬)") String isbn
) {
    return bookService.findByIsbn(isbn)
        .orElseThrow(() -> new IllegalArgumentException("ë„ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + isbn));
}
```

#### 2ë‹¨ê³„: ë¦¬ë·° ì¡°íšŒ Function

```java
@FunctionInfo(name = "get_book_reviews",
              description = "ISBNìœ¼ë¡œ ë„ì„œ ë¦¬ë·° ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤")
public List<ReviewDto> getBookReviews(
    @FunctionParam(description = "ISBN ì½”ë“œ") String isbn,
    @FunctionParam(description = "ë¦¬ë·° ê°œìˆ˜ (ê¸°ë³¸ê°’: 5)", defaultValue = "5") int limit
) {
    return reviewService.findByIsbn(isbn, Pageable.ofSize(limit));
}
```

#### 3ë‹¨ê³„: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì‘ì„±

```java
@Bean
public ChatClient.Builder chatClientBuilder(ChatModel chatModel,
                                            BookSearchFunctions bookFunctions,
                                            BookFunctions bookFunctions) {
    return ChatClient.builder(chatModel)
        .defaultSystemPrompt("""
            ë‹¹ì‹ ì€ ë„ì„œê´€ ë„ìš°ë¯¸ AIì…ë‹ˆë‹¤.
            ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ì ì ˆí•œ ë„êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”:
            - ë„ì„œ ê²€ìƒ‰: search_books
            - ë„ì„œ ì •ë³´: get_book_info
            - ë¦¬ë·° ì¡°íšŒ: get_book_reviews

            ì—¬ëŸ¬ ë„êµ¬ë¥¼ ì¡°í•©í•˜ì—¬ ì¢…í•©ì ì¸ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.
            ë‹µë³€ì€ ì¹œì ˆí•˜ê³  ìƒì„¸í•˜ê²Œ ì‘ì„±í•˜ì„¸ìš”.
            """)
        .defaultFunctions(bookFunctions, bookFunctions);
}
```

#### 4ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```java
@Test
void testBookInfoWithReviews() {
    String response = aiChatService.chat("ISBN 9788960777331 ì´ì±… ì–´ë–¤ ì±…ì´ì•¼?");

    assertThat(response).contains("ë„ì„œëª…");
    assertThat(response).contains("ë¦¬ë·°");
}
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] 2ê°œ ì´ìƒì˜ Function ì •ì˜
- [ ] ê° Functionì˜ ì„¤ëª…ì´ ëª…í™•í•œì§€ í™•ì¸
- [ ] AIê°€ ë‘ Functionì„ ìˆœì°¨ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ”ì§€ í™•ì¸
- [ ] ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¡œ AI í–‰ë™ ê°€ì´ë“œ
- [ ] ì¢…í•© ë‹µë³€ì´ ìì—°ìŠ¤ëŸ¬ìš´ì§€ í™•ì¸

---

## â­â­â­ ë¯¸ì…˜ 3: ì¡°ê±´ë¶€ Function í˜¸ì¶œ - ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸

**ë‚œì´ë„**: ì¤‘ê¸‰ | **ì˜ˆìƒ ì‹œê°„**: 2ì‹œê°„

### ëª©í‘œ
AIê°€ ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì¡°ê±´ë¶€ë¡œ Functionì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
```
ì‚¬ìš©ì: "ë‚´ ì£¼ë³€ì—ì„œ ë¹Œë¦´ ìˆ˜ ìˆëŠ” ë„ì„œê´€ ì•Œë ¤ì¤˜: ì±… 'ìë°”ì˜ ì •ì„'"

AI ë™ì‘:
1. search_books Functionìœ¼ë¡œ ë„ì„œ ê²€ìƒ‰ â†’ ISBN íšë“
2. get_loan_libraries Functionìœ¼ë¡œ ëŒ€ì¶œ ê°€ëŠ¥ ë„ì„œê´€ ì¡°íšŒ
3. ì§€ì—­ë³„ë¡œ ì •ë ¬í•˜ì—¬ ì œê³µ
```

### êµ¬í˜„ ê°€ì´ë“œ

#### 1ë‹¨ê³„: ëŒ€ì¶œ ê°€ëŠ¥ ë„ì„œê´€ ì¡°íšŒ Function

```java
@FunctionInfo(name = "get_loan_libraries",
              description = "íŠ¹ì • ISBNì˜ ë„ì„œë¥¼ ëŒ€ì¶œí•  ìˆ˜ ìˆëŠ” ë„ì„œê´€ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤")
public List<LoanItemInfo> getLoanLibraries(
    @FunctionParam(description = "ISBN-13 ì½”ë“œ") String isbn13,
    @FunctionParam(description = "ì§€ì—­ ì½”ë“œ (ì˜ˆ: 11=ì„œìš¸, null=ì „êµ­)") String region
) {
    if (region != null && !region.isEmpty()) {
        return libraryInfoNaruApiClient.searchLoanItemsByIsbn(isbn13, region);
    }
    return libraryInfoNaruApiClient.searchLoanItemsByIsbn(isbn13);
}
```

#### 2ë‹¨ê³„: ì§€ì—­ ì½”ë“œ ë§¤í•‘ Function

```java
private static final Map<String, String> REGION_MAP = Map.of(
    "ì„œìš¸", "11",
    "ê²½ê¸°", "41",
    "ë¶€ì‚°", "26",
    "ëŒ€êµ¬", "27",
    "ì¸ì²œ", "28",
    "ê´‘ì£¼", "29",
    "ëŒ€ì „", "30",
    "ìš¸ì‚°", "31"
);

@FunctionInfo(name = "get_region_code",
              description = "ì§€ì—­ëª…ì„ ì§€ì—­ ì½”ë“œë¡œ ë³€í™˜í•©ë‹ˆë‹¤")
public String getRegionCode(
    @FunctionParam(description = "ì§€ì—­ëª… (ì˜ˆ: ì„œìš¸, ê²½ê¸°, ë¶€ì‚° ë“±)") String regionName
) {
    return REGION_MAP.getOrDefault(regionName, "");
}
```

#### 3ë‹¨ê³„: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ê°œì„ 

```java
.defaultSystemPrompt("""
    ë‹¹ì‹ ì€ ë„ì„œê´€ ë„ìš°ë¯¸ AIì…ë‹ˆë‹¤.

    ì‚¬ìš©ìê°€ "ë„ì„œ ëŒ€ì¶œ"ê³¼ ê´€ë ¨ëœ ì§ˆë¬¸ì„ í•˜ë©´:
    1. ë¨¼ì € search_booksë¡œ ë„ì„œë¥¼ ê²€ìƒ‰í•˜ì—¬ ISBNì„ ì°¾ìœ¼ì„¸ìš”
    2. get_loan_librariesë¡œ ëŒ€ì¶œ ê°€ëŠ¥ ë„ì„œê´€ì„ ì¡°íšŒí•˜ì„¸ìš”
    3. ì§€ì—­ë³„ë¡œ ê·¸ë£¹í™”í•˜ì—¬ ì•Œê¸° ì‰½ê²Œ ì •ë¦¬í•˜ì„¸ìš”

    ì§€ì—­ëª…ì´ ì–¸ê¸‰ë˜ë©´ get_region_codeë¡œ ì§€ì—­ ì½”ë“œë¥¼ ë³€í™˜í•˜ì„¸ìš”.

    ë‹µë³€ í˜•ì‹:
    - ë„ì„œ ê¸°ë³¸ ì •ë³´
    - ëŒ€ì¶œ ê°€ëŠ¥ ë„ì„œê´€ ëª©ë¡ (ì§€ì—­ë³„)
    - ë„ì„œê´€ ìœ„ì¹˜/ì—°ë½ì²˜
    """)
```

#### 4ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```java
@Test
void testLoanLibrarySearch() {
    String response = aiChatService.chat("ì„œìš¸ì—ì„œ 'ìë°”ì˜ ì •ì„' ë¹Œë¦´ ìˆ˜ ìˆì–´?");

    assertThat(response).contains("ëŒ€ì¶œ ê°€ëŠ¥");
    assertThat(response).contains("ì„œìš¸");
}

@Test
void testRegionMapping() {
    String response = aiChatService.chat("ê²½ê¸°ë„ì—ì„œ ë¹Œë¦´ ìˆ˜ ìˆì–´?");

    assertThat(response).contains("ê²½ê¸°");
}
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì¡°ê±´ë¶€ Function í˜¸ì¶œ êµ¬í˜„
- [ ] ì§€ì—­ ì½”ë“œ ë§¤í•‘ Function
- [ ] Function ê°„ ë°ì´í„° ì „ë‹¬ (ISBN â†’ ëŒ€ì¶œ ë„ì„œê´€)
- [ ] ë³µì¡í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì‘ì„±
- [ ] ì—ëŸ¬ ì²˜ë¦¬ (ë„ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°)

---

## â­â­â­â­ ë¯¸ì…˜ 4: ë³µì¡í•œ ì›Œí¬í”Œë¡œìš° - ë„ì„œ ë“±ë¡ + ì„ë² ë”©

**ë‚œì´ë„**: ì¤‘ìƒë‹¨ê³„ | **ì˜ˆìƒ ì‹œê°„**: 3ì‹œê°„

### ëª©í‘œ
AIê°€ ì—¬ëŸ¬ Functionì„ ì¡°í•©í•˜ì—¬ ë³µì¡í•œ ì‘ì—… ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
```
ì‚¬ìš©ì: "ë„ì„œê´€ì •ë³´ë‚˜ë£¨ APIì—ì„œ 'ìë°”ì˜ ì •ì„' ê²€ìƒ‰í•´ì„œ ë“±ë¡í•´ì¤˜"

AI ë™ì‘:
1. search_library_books Function (ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API)
2. ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì²« ë²ˆì§¸ ë„ì„œ ì„ íƒ
3. register_book Function (DB ì €ì¥)
4. trigger_embedding Function (ë°±ê·¸ë¼ìš´ë“œ ì„ë² ë”© ìƒì„±)
5. ì§„í–‰ ìƒí™©ì„ ì‚¬ìš©ìì—ê²Œ í”¼ë“œë°±
6. ì™„ë£Œ ë©”ì‹œì§€ ì œê³µ
```

### êµ¬í˜„ ê°€ì´ë“œ

#### 1ë‹¨ê³„: ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ Function

```java
@FunctionInfo(name = "search_library_books",
              description = "ë„ì„œê´€ì •ë³´ë‚˜ë£¨ APIì—ì„œ ë„ì„œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. " +
                          "ì œëª©, ì €ì, ì¶œíŒì‚¬, ISBN ë“±ìœ¼ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
public List<LibraryBookInfo> searchLibraryBooks(
    @FunctionParam(description = "ê²€ìƒ‰ í‚¤ì›Œë“œ") String keyword
) {
    return libraryInfoNaruApiClient.searchBooksByTitle(keyword);
}
```

#### 2ë‹¨ê³„: ë„ì„œ ë“±ë¡ Function

```java
@FunctionInfo(name = "register_book",
              description = "ìƒˆë¡œìš´ ë„ì„œë¥¼ ì‹œìŠ¤í…œì— ë“±ë¡í•©ë‹ˆë‹¤. " +
                          "ISBN, ì œëª©, ì €ì, ì¶œíŒì‚¬ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.")
public BookDto registerBook(
    @FunctionParam(description = "ISBN-13 ì½”ë“œ") String isbn13,
    @FunctionParam(description = "ë„ì„œ ì œëª©") String title,
    @FunctionParam(description = "ì €ìëª…") String authors,
    @FunctionParam(description = "ì¶œíŒì‚¬ëª…") String publisher
) {
    BookDto bookDto = new BookDto(null, isbn13, title, authors, publisher);
    return bookService.save(bookDto);
}
```

#### 3ë‹¨ê³„: ì„ë² ë”© ë°°ì¹˜ ì‹¤í–‰ Function

```java
@FunctionInfo(name = "trigger_embedding",
              description = "ë„ì„œ ì„ë² ë”© ìƒì„± ë°°ì¹˜ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤. " +
                          "ì´ë¯¸ ì„ë² ë”©ì´ ìƒì„±ëœ ë„ì„œëŠ” ê±´ë„ˆëœë‹ˆë‹¤.")
public String triggerEmbedding(
    @FunctionParam(description = "ì„ë² ë”©ì„ ìƒì„±í•  ë„ì„œ ID ëª©ë¡") List<Long> bookIds
) {
    List<Book> books = bookService.findAllById(bookIds);
    int count = embeddingService.createEmbeddings(books);
    return String.format("%dê¶Œì˜ ë„ì„œ ì„ë² ë”© ìƒì„± ì‹œì‘", count);
}
```

#### 4ë‹¨ê³„: ëŒ€í™”í˜• ì§„í–‰ ìƒí™© ì œê³µ

```java
@FunctionInfo(name = "report_progress",
              description = "ì‘ì—… ì§„í–‰ ìƒí™©ì„ ì‚¬ìš©ìì—ê²Œ ë³´ê³ í•©ë‹ˆë‹¤")
public void reportProgress(
    @FunctionParam(description = "í˜„ì¬ ë‹¨ê³„") String step,
    @FunctionParam(description = "ì§„í–‰ ìƒí™©") String status
) {
    // ë¡œê·¸ë¥¼ ë‚¨ê¸°ê±°ë‚˜ ì›¹í›… APIë¡œ ì „ì†¡
    log.info("[ì§„í–‰ ìƒí™©] {} - {}", step, status);
}
```

#### 5ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```java
@Test
void testBookRegistrationWithEmbedding() {
    String response = aiChatService.chat(
        "ë„ì„œê´€ì •ë³´ë‚˜ë£¨ì—ì„œ 'ì´ê²ƒì´ ìë°”ë‹¤' ê²€ìƒ‰í•´ì„œ ë“±ë¡í•´ì£¼ê³  ì„ë² ë”©ë„ ìƒì„±í•´ì¤˜"
    );

    assertThat(response).contains("ë“±ë¡");
    assertThat(response).contains("ì„ë² ë”©");
}
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] 4ê°œ ì´ìƒì˜ Function ì¡°í•©
- [ ] Function ê°„ ë°ì´í„° ì „ë‹¬ (ê²€ìƒ‰ ê²°ê³¼ â†’ ë“±ë¡ â†’ ì„ë² ë”©)
- [ ] ì§„í–‰ ìƒí™© í”¼ë“œë°±
- [ ] ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡¤ë°±
- [ ] ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•œ ì§„í–‰ ìƒí™© ê³µìœ 

---

## â­â­â­â­â­ ë¯¸ì…˜ 5: Multi-Agent í˜‘ì—… - ì‹ ê°„ ìë™ ìˆ˜ì§‘

**ë‚œì´ë„**: ê³ ê¸‰ | **ì˜ˆìƒ ì‹œê°„**: 4ì‹œê°„+

### ëª©í‘œ
ì—¬ëŸ¬ AI Agentê°€ í˜‘ì—…í•˜ì—¬ ë³µì¡í•œ ì‘ì—…ì„ ìë™í™”í•©ë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
```
ì‚¬ìš©ì: "ìµœê·¼ 1ì£¼ì¼ ì‹ ê°„ IT ë„ì„œ ìë™ ìˆ˜ì§‘í•´ì¤˜"

Agent í˜‘ì—…:
1. **Collector Agent**: ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ëª¨ë‹ˆí„°ë§
2. **Filter Agent**: ì¤‘ë³µ ë„ì„œ í•„í„°ë§
3. **Registrar Agent**: ë„ì„œ ë“±ë¡
4. **Embedding Agent**: ì„ë² ë”© ìƒì„±
5. **Notifier Agent**: ì™„ë£Œ ì•Œë¦¼
```

### êµ¬í˜„ ê°€ì´ë“œ

#### 1ë‹¨ê³„: Agentë³„ Function ì •ì˜

**Collector Agent**:
```java
@Component("collectorAgent")
public class CollectorAgentFunctions {

    @FunctionInfo(name = "collect_recent_books",
                  description = "ìµœê·¼ Nì¼ê°„ ë“±ë¡ëœ ì‹ ê°„ ë„ì„œë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤")
    public List<LibraryBookInfo> collectRecentBooks(
        @FunctionParam(description = "ìˆ˜ì§‘í•  ì¹´í…Œê³ ë¦¬", defaultValue = "IT") String category,
        @FunctionParam(description = "ìˆ˜ì§‘í•  ê¸°ê°„(ì¼)", defaultValue = "7") int days
    ) {
        // ë„ì„œê´€ì •ë³´ë‚˜ë£¨ APIì—ì„œ ìµœì‹  ë„ì„œ ìˆ˜ì§‘
        return libraryInfoNaruApiClient.searchBooksByTitle(category);
    }
}
```

**Filter Agent**:
```java
@Component("filterAgent")
public class FilterAgentFunctions {

    @FunctionInfo(name = "filter_duplicate_books",
                  description = "ì´ë¯¸ ë“±ë¡ëœ ë„ì„œë¥¼ í•„í„°ë§í•©ë‹ˆë‹¤")
    public List<LibraryBookInfo> filterDuplicates(
        @FunctionParam(description = "ìˆ˜ì§‘ëœ ë„ì„œ ëª©ë¡") List<LibraryBookInfo> collectedBooks
    ) {
        return collectedBooks.stream()
            .filter(book -> !bookService.existsByIsbn(book.isbn13()))
            .toList();
    }
}
```

**Registrar Agent**:
```java
@Component("registrarAgent")
public class RegistrarAgentFunctions {

    @FunctionInfo(name = "batch_register_books",
                  description = "ì—¬ëŸ¬ ë„ì„œë¥¼ ì¼ê´„ ë“±ë¡í•©ë‹ˆë‹¤")
    public BatchResult batchRegister(
        @FunctionParam(description = "ë“±ë¡í•  ë„ì„œ ëª©ë¡") List<LibraryBookInfo> books
    ) {
        List<BookDto> registered = new ArrayList<>();
        for (LibraryBookInfo book : books) {
            BookDto dto = convertToDto(book);
            registered.add(bookService.save(dto));
        }
        return new BatchResult(registered.size(), books.size());
    }

    record BatchResult(int success, int total) {}
}
```

**Embedding Agent**:
```java
@Component("embeddingAgent")
public class EmbeddingAgentFunctions {

    @FunctionInfo(name = "batch_create_embeddings",
                  description = "ë„ì„œ ì„ë² ë”©ì„ ì¼ê´„ ìƒì„±í•©ë‹ˆë‹¤")
    public String batchCreateEmbeddings(
        @FunctionParam(description = "ë“±ë¡ëœ ë„ì„œ ID ëª©ë¡") List<Long> bookIds
    ) {
        embeddingService.createEmbeddingsByIds(bookIds);
        return String.format("%dê¶Œì˜ ë„ì„œ ì„ë² ë”© ìƒì„± ì™„ë£Œ", bookIds.size());
    }
}
```

**Notifier Agent**:
```java
@Component("notifierAgent")
public class NotifierAgentFunctions {

    @FunctionInfo(name = "send_completion_notification",
                  description = "ì‘ì—… ì™„ë£Œ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤")
    public String notifyCompletion(
        @FunctionParam(description = "ì‘ì—… ìœ í˜•") String taskType,
        @FunctionParam(description = "ì™„ë£Œëœ ì‘ì—… ìˆ˜") int completedCount
    ) {
        return String.format("âœ… %s ì™„ë£Œ: %dê±´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.", taskType, completedCount);
    }
}
```

#### 2ë‹¨ê³„: Orchestrator êµ¬í˜„

```java
@Service
@RequiredArgsConstructor
public class MultiAgentOrchestrator {

    private final CollectorAgentFunctions collectorAgent;
    private final FilterAgentFunctions filterAgent;
    private final RegistrarAgentFunctions registrarAgent;
    private final EmbeddingAgentFunctions embeddingAgent;
    private final NotifierAgentFunctions notifierAgent;

    private final ChatClient.Builder chatClientBuilder;

    public String executeAutoCollection(String category, int days) {
        // ëª¨ë“  Agentì˜ Functionì„ ë“±ë¡
        var chatClient = chatClientBuilder
            .defaultFunctions(
                collectorAgent, filterAgent, registrarAgent,
                embeddingAgent, notifierAgent
            )
            .defaultSystemPrompt("""
                ë‹¹ì‹ ì€ ë„ì„œ ìˆ˜ì§‘ Orchestratorì…ë‹ˆë‹¤.

                ë‹¤ìŒ ìˆœì„œëŒ€ë¡œ Agentë“¤ì„ ì¡°ìœ¨í•˜ì—¬ ì‘ì—…ì„ ì™„ìˆ˜í•˜ì„¸ìš”:
                1. collect_recent_books: ìµœì‹  ë„ì„œ ìˆ˜ì§‘
                2. filter_duplicate_books: ì¤‘ë³µ í•„í„°ë§
                3. batch_register_books: ì¼ê´„ ë“±ë¡
                4. batch_create_embeddings: ì„ë² ë”© ìƒì„±
                5. send_completion_notification: ì™„ë£Œ ì•Œë¦¼

                ê° ë‹¨ê³„ì˜ ê²°ê³¼ë¥¼ ë‹¤ìŒ Agentì—ê²Œ ì „ë‹¬í•˜ê³ ,
                ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì¢…í•© ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•˜ì„¸ìš”.
                """)
            .build();

        String userPrompt = String.format(
            "ìµœê·¼ %dì¼ê°„ '%s' ì¹´í…Œê³ ë¦¬ ì‹ ê°„ ë„ì„œë¥¼ ìë™ ìˆ˜ì§‘í•´ì¤˜",
            days, category
        );

        return chatClient.prompt()
            .user(userPrompt)
            .call()
            .content();
    }
}
```

#### 3ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

```java
@SpringBootTest
class MultiAgentOrchestratorTest {

    @Autowired
    private MultiAgentOrchestrator orchestrator;

    @Test
    void testAutoCollection() {
        String response = orchestrator.executeAutoCollection("IT", 7);

        assertThat(response).contains("ìˆ˜ì§‘");
        assertThat(response).contains("ë“±ë¡");
        assertThat(response).contains("ì„ë² ë”©");
        assertThat(response).contains("ì™„ë£Œ");

        System.out.println(response);
    }
}
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] 5ê°œ ì´ìƒì˜ Agent ì •ì˜
- [ ] ê° Agentì˜ ì±…ì„ê³¼ ì—­í•  ëª…í™•íˆ ë¶„ë¦¬
- [ ] Agent ê°„ ë°ì´í„° ì „ë‹¬ (ìˆ˜ì§‘ â†’ í•„í„°ë§ â†’ ë“±ë¡ â†’ ì„ë² ë”© â†’ ì•Œë¦¼)
- [ ] Orchestratorë¡œ ì „ì²´ ì›Œí¬í”Œë¡œìš° ì œì–´
- [ ] ì—ëŸ¬ ë°œìƒ ì‹œ ë¡¤ë°± ë° ë³µêµ¬ ì „ëµ
- [ ] ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§

---

## ğŸ ë³´ë„ˆìŠ¤ ë¯¸ì…˜: ì‚¬ìš©ì ë§ì¶¤ ì¶”ì²œ ì‹œìŠ¤í…œ

**ë‚œì´ë„**: íŠ¹ë³„ | **ì˜ˆìƒ ì‹œê°„**: 5ì‹œê°„+

### ëª©í‘œ
ì‚¬ìš©ìì˜ ê²€ìƒ‰ ì´ë ¥ê³¼ ë¦¬ë·°ë¥¼ ë¶„ì„í•˜ì—¬ ë§ì¶¤ ë„ì„œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.

### ì‹œë‚˜ë¦¬ì˜¤
```
ì‚¬ìš©ì: "ë‚´ ì·¨í–¥ì— ë§ëŠ” ì±… ì¶”ì²œí•´ì¤˜"

AI ë™ì‘:
1. get_user_history Function: ì‚¬ìš©ì ê²€ìƒ‰ ì´ë ¥ ì¡°íšŒ
2. analyze_preferences Function: ì‚¬ìš©ì ì·¨í–¥ ë¶„ì„
3. recommend_books Function: ë§ì¶¤ ë„ì„œ ì¶”ì²œ
4. check_loan_availability Function: ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
5. explain_recommendation Function: ì¶”ì²œ ì´ìœ  ì„¤ëª…
```

### êµ¬í˜„ ê°€ì´ë“œ

#### 1ë‹¨ê³„: ì‚¬ìš©ì ì´ë ¥ ì¡°íšŒ Function

```java
@FunctionInfo(name = "get_user_history",
              description = "ì‚¬ìš©ìì˜ ìµœê·¼ ê²€ìƒ‰ ì´ë ¥ì„ ì¡°íšŒí•©ë‹ˆë‹¤")
public List<SearchHistoryDto> getUserHistory(
    @FunctionParam(description = "ì‚¬ìš©ì ID") String userId,
    @FunctionParam(description = "ì¡°íšŒí•  ê¸°ê°„(ì¼)", defaultValue = "30") int days
) {
    LocalDateTime since = LocalDateTime.now().minusDays(days);
    return searchHistoryService.findByUserIdSince(userId, since);
}
```

#### 2ë‹¨ê³„: ì„ í˜¸ë„ ë¶„ì„ Function

```java
@FunctionInfo(name = "analyze_preferences",
              description = "ì‚¬ìš©ìì˜ ê²€ìƒ‰ ì´ë ¥ì„ ë¶„ì„í•˜ì—¬ ì„ í˜¸ ë„ì„œ ì¥ë¥´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤")
public UserPreferences analyzePreferences(
    @FunctionParam(description = "ê²€ìƒ‰ ì´ë ¥") List<SearchHistoryDto> history
) {
    // ê²€ìƒ‰ì–´ ë¹ˆë„ ë¶„ì„
    Map<String, Long> keywordFrequency = history.stream()
        .flatMap(h -> Arrays.stream(h.getKeyword().split(" ")))
        .collect(Collectors.groupingBy(
            Function.identity(),
            Collectors.counting()
        ));

    // ìƒìœ„ 3ê°œ í‚¤ì›Œë“œ ì¶”ì¶œ
    List<String> topKeywords = keywordFrequency.entrySet().stream()
        .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
        .limit(3)
        .map(Map.Entry::getKey)
        .toList();

    return new UserPreferences(topKeywords, "IT");
}

record UserPreferences(List<String> preferredGenres, String mainCategory) {}
```

#### 3ë‹¨ê³„: ì¶”ì²œ Function

```java
@FunctionInfo(name = "recommend_books",
              description = "ì‚¬ìš©ìì˜ ì„ í˜¸ë„ì— ë§ëŠ” ë„ì„œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤")
public List<BookDto> recommendBooks(
    @FunctionParam(description = "ì‚¬ìš©ì ì„ í˜¸ë„") UserPreferences preferences
) {
    // ì„ í˜¸ ì¥ë¥´ë¡œ ê²€ìƒ‰
    String query = String.join(" ", preferences.preferredGenres());
    return bookSearchService.search(query, 10);
}
```

#### 4ë‹¨ê³„: ì¶”ì²œ ì´ìœ  ì„¤ëª… Function

```java
@FunctionInfo(name = "explain_recommendation",
              description = "ì¶”ì²œ ì´ìœ ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤")
public String explainRecommendation(
    @FunctionParam(description = "ì¶”ì²œëœ ë„ì„œ") BookDto book,
    @FunctionParam(description = "ì‚¬ìš©ì ì„ í˜¸ë„") UserPreferences preferences
) {
    return String.format(
        "'%s'ì„(ë¥¼) ì¶”ì²œí•˜ëŠ” ì´ìœ : ìµœê·¼ '%s' ì¹´í…Œê³ ë¦¬ë¥¼ ë§ì´ ê²€ìƒ‰í•˜ì…¨ìŠµë‹ˆë‹¤. " +
        "ì´ ì±…ì€ '%s'ì™€ ê´€ë ¨ëœ ë‚´ìš©ì„ ë‹¤ë£¹ë‹ˆë‹¤.",
        book.getTitle(),
        preferences.mainCategory(),
        String.join(", ", preferences.preferredGenres())
    );
}
```

### ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ì‚¬ìš©ì ë°ì´í„° ìˆ˜ì§‘ Function
- [ ] ë¶„ì„ ë° ì¶”ì²œ Function
- [ ] ì¶”ì²œ ì´ìœ  ì„¤ëª… Function
- [ ] ê°œì¸í™”ëœ ê²½í—˜ ì œê³µ
- [ ] ì¶”ì²œ í’ˆì§ˆ í‰ê°€ ë°©ë²•

---

## ğŸ“ ë¯¸ì…˜ ì™„ë£Œ ê¸°ì¤€

### ê¸°ëŠ¥ ì™„ì„±ë„
- [ ] ëª¨ë“  Functionì´ ì •ìƒ ì‘ë™
- [ ] AIê°€ Functionì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒ
- [ ] ì—ëŸ¬ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì–´ ìˆìŒ
- [ ] ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ í”¼ë“œë°± ì œê³µ

### ì½”ë“œ í’ˆì§ˆ
- [ ] Function ì„¤ëª…ì´ ëª…í™•í•¨
- [ ] íŒŒë¼ë¯¸í„° ê²€ì¦ì´ ì™„ë£Œë¨
- [ ] ë¡œê·¸ê°€ ì ì ˆíˆ ê¸°ë¡ë¨
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì‘ì„±ë¨

### ì‚¬ìš©ì ê²½í—˜
- [ ] ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ê°€ëŠ¥
- [ ] ì‘ë‹µ ì‹œê°„ì´ ì ì ˆí•¨
- [ ] ì˜¤ë¥˜ ìƒí™©ì—ì„œë„ ìš°ì•„í•œ ì²˜ë¦¬

---

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

ëª¨ë“  ë¯¸ì…˜ì„ ì™„ë£Œí•œ í›„:
1. **MCP ì„œë²„ êµ¬í˜„** (ë‹¤ìŒ ë¬¸ì„œ)
2. **ë„êµ¬ ìµœì í™”** (Function ì„¤ê³„ ê°œì„ )
3. **A2A í†µì‹ ** (Agent ê°„ í˜‘ì—…)
4. **í”„ë¡œë•ì…˜ ë°°í¬** (ëª¨ë‹ˆí„°ë§, ë¡œê¹…)

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Spring AI Function Calling](https://docs.spring.io/spring-ai/reference/api/guide.html)
- [MCP ê³µì‹ ë¬¸ì„œ](https://modelcontextprotocol.io/)
- [í”„ë¡œì íŠ¸ ì½”ë“œ ë² ì´ìŠ¤](https://github.com/nhn-academy-ai-library)
