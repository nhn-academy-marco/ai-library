# Telegramì„ í†µí•œ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰

## ê°œìš”

Step 2ì—ì„œ êµ¬í˜„í•œ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ê¸°ëŠ¥ì„ Telegram Botì„ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì—°ë™í•©ë‹ˆë‹¤.

## í•™ìŠµ ëª©í‘œ

- ì™¸ë¶€ Service ì—°ë™ ê²½í—˜
- ê²€ìƒ‰ ê²°ê³¼ í¬ë§·íŒ…
- ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì„¤ê³„

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram   â”‚ â”€â”€â–¶ â”‚    Bot      â”‚ â”€â”€â–¶ â”‚  Hybrid     â”‚
â”‚    User     â”‚     â”‚  Handler    â”‚     â”‚  Search     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                    â”‚
                            â–¼                    â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Response   â”‚ â—€â”€  â”‚  Book       â”‚
                     â”‚  Formatter  â”‚     â”‚  Service    â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ê°œë…

### 1. ê²€ìƒ‰ íë¦„

```
ì‚¬ìš©ì ì…ë ¥ â†’ Bot ìˆ˜ì‹  â†’ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ â†’ ìºì‹œ í™•ì¸ â†’ ê²°ê³¼ í¬ë§·íŒ… â†’ ì‘ë‹µ ì „ì†¡
                        â†“
                 BookSearchService
                 (SearchType.HYBRID)
                        â†“
                 SemanticCacheService
                 (ì¶”ì²œ ë„ì„œ ìºì‹œ í™•ì¸)
```

### 2. ìºì‹±ëœ ì¶”ì²œ ë„ì„œ ì²˜ë¦¬

**ì‹œë‚˜ë¦¬ì˜¤:**
1. ì‚¬ìš©ìê°€ "í•´ë¦¬í¬í„°" ê²€ìƒ‰
2. í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì‹¤í–‰ â†’ ìƒìœ„ 5ê°œ ê²°ê³¼
3. **ìºì‹œ í™•ì¸**: ë¹„ìŠ·í•œ ê²€ìƒ‰ì–´ì˜ ì¶”ì²œ ë„ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
4. **ì‘ë‹µ êµ¬ì„±**:
   - ìºì‹œ ìˆìŒ: "AI ì¶”ì²œ ë„ì„œ (ìºì‹œ)" + ê²€ìƒ‰ëœ ë„ì„œ ìƒìœ„ 5ê°œ
   - ìºì‹œ ì—†ìŒ: ê²€ìƒ‰ëœ ë„ì„œ ìƒìœ„ 5ê°œë§Œ

```java
// ê²€ìƒ‰ ì²˜ë¦¬ ë¡œì§ íë¦„
BookSearchResult result = bookSearchService.searchBooks(pageable, request);

// ìºì‹±ëœ ì¶”ì²œ ë„ì„œ í™•ì¸
boolean hasCache = semanticCacheService.findSimilarResult(ragRequest).isPresent();

// ì‘ë‹µ í¬ë§·íŒ… (ìºì‹œ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥¸ ë©”ì‹œì§€)
String response = formatSearchResult(keyword, result, hasCache);
```

### 3. ë©”ì‹œì§€ í¬ë§·íŒ… ì „ëµ

Telegram ë©”ì‹œì§€ëŠ” **4096ì ì œí•œ**ì´ ìˆìŠµë‹ˆë‹¤.

**ì „ëµ:**
- ìµœëŒ€ 5ê°œ ê²°ê³¼ í‘œì‹œ
- ì œëª©, ì €ì, ì¶œíŒì‚¬ ì •ë³´
- ìºì‹œ ì—¬ë¶€ ì•ˆë‚´ (âœ¨ AI ì¶”ì²œ ë„ì„œ í‘œì‹œ)
- Markdown ì‚¬ìš©ìœ¼ë¡œ ê°€ë…ì„± í–¥ìƒ

### 4. Command vs ì¼ë°˜ í…ìŠ¤íŠ¸

**Command (`/`ë¡œ ì‹œì‘):**
- `/search í•´ë¦¬í¬í„°`
- ëª…ì‹œì ì¸ ê²€ìƒ‰ ì˜ë„

**ì¼ë°˜ í…ìŠ¤íŠ¸:**
- `í•´ë¦¬í¬í„°`
- ìì—°ìŠ¤ëŸ¬ìš´ ê²€ìƒ‰ ê²½í—˜ (ë³„ë„ Command ë¶ˆí•„ìš”)

**êµ¬í˜„:**
```java
if (messageText.startsWith("/")) {
    handleCommand(update, messageText);  // /search, /start, /help
} else {
    handleSearch(update, messageText);   // ì¼ë°˜ í…ìŠ¤íŠ¸ë„ ê²€ìƒ‰ ì²˜ë¦¬
}
```

---

## êµ¬í˜„ ê°€ì´ë“œ

### 1. ê²€ìƒ‰ Command Handler ì¸í„°í˜ì´ìŠ¤

```java
/**
 * ê²€ìƒ‰ Command Handler
 *
 * <p>ì‚¬ìš©ì ê²€ìƒ‰ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  ê²°ê³¼ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 */
public interface SearchCommandHandler {
    /**
     * ê²€ìƒ‰ Command ì²˜ë¦¬
     *
     * @param update Telegram Update ê°ì²´
     * @param query ê²€ìƒ‰ì–´
     */
    void handleSearchCommand(Update update, String query);
}
```

**êµ¬í˜„ í¬ì¸íŠ¸:**
```java
@Slf4j
@Component
@RequiredArgsConstructor
public class SearchCommandHandlerImpl implements SearchCommandHandler {

    private final BookSearchService bookSearchService;
    private final TelegramResponseFormatter responseFormatter;
    private final TelegramClient telegramClient;

    private static final int DEFAULT_RESULT_SIZE = 10;

    @Override
    public void handleSearchCommand(Update update, String query) {
        Long chatId = update.getMessage().getChatId();

        try {
            // 1. ê²€ìƒ‰ ì‹¤í–‰
            List<SearchResult> results = bookSearchService.hybridSearch(query, DEFAULT_RESULT_SIZE);

            // 2. ê²°ê³¼ í¬ë§·íŒ…
            SendMessage response = responseFormatter.formatSearchResults(chatId, query, results);

            // 3. ì‘ë‹µ ì „ì†¡
            telegramClient.execute(response);

            log.info("Search completed: {} results", results.size());

        } catch (Exception e) {
            log.error("Search failed for query: {}", query, e);
            sendErrorMessage(chatId, "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    private void sendErrorMessage(Long chatId, String message) {
        // TODO: ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡ êµ¬í˜„
    }
}
```

### 2. ì‘ë‹µ í¬ë§·í„°

```java
/**
 * Telegram ì‘ë‹µ í¬ë§·í„°
 *
 * <p>ê²€ìƒ‰ ê²°ê³¼ë¥¼ Telegram ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 */
public interface TelegramResponseFormatter {
    /**
     * ê²€ìƒ‰ ê²°ê³¼ í¬ë§·íŒ…
     *
     * @param chatId Telegram Chat ID
     * @param query ê²€ìƒ‰ì–´
     * @param results ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡
     * @return í¬ë§·íŒ…ëœ SendMessage
     */
    SendMessage formatSearchResults(Long chatId, String query, List<SearchResult> results);
}
```

**êµ¬í˜„ ê°€ì´ë“œ:**

```java
@Component
public class TelegramResponseFormatterImpl implements TelegramResponseFormatter {

    private static final int MAX_RESULTS_PER_MESSAGE = 5;
    private static final int MAX_TITLE_LENGTH = 50;
    private static final int MAX_DESCRIPTION_LENGTH = 100;

    @Override
    public SendMessage formatSearchResults(Long chatId, String query, List<SearchResult> results) {
        StringBuilder message = new StringBuilder();

        // í—¤ë”
        message.append("ğŸ“š **ê²€ìƒ‰ ê²°ê³¼**\n");
        message.append("í‚¤ì›Œë“œ: ").append(query).append("\n");
        message.append("ì´ ").append(results.size()).append("ê±´ ì°¾ìŒ\n\n");

        // ê²°ê³¼ í¬ë§·íŒ…
        int displayCount = Math.min(results.size(), MAX_RESULTS_PER_MESSAGE);

        for (int i = 0; i < displayCount; i++) {
            SearchResult result = results.get(i);

            // TODO: ê° ê²°ê³¼ í¬ë§·íŒ…
            // - ì œëª© (truncate ì²˜ë¦¬)
            // - ì €ì (ìˆëŠ” ê²½ìš°)
            // - ì¤„ê±°ë¦¬ (ìˆëŠ” ê²½ìš°)

            message.append(String.format("**%d.** %s\n", i + 1, result.getTitle()));
            message.append("\n");
        }

        // ë‚˜ë¨¸ì§€ ê²°ê³¼ ì•ˆë‚´
        if (results.size() > MAX_RESULTS_PER_MESSAGE) {
            message.append(String.format("_...ê·¸ ì™¸ %dê±´_\n", results.size() - MAX_RESULTS_PER_MESSAGE));
        }

        return SendMessage.builder()
            .chatId(chatId)
            .text(message.toString())
            .parseMode("Markdown")
            .build();
    }

    private String truncate(String text, int maxLength) {
        // TODO: í…ìŠ¤íŠ¸ ì˜ë¼ë‚´ê¸° êµ¬í˜„
        return text;
    }
}
```

### 3. Bot Update ì²˜ë¦¬ ê°œì„ 

```java
@Override
public void consume(Update update) {
    if (update.hasMessage() && update.getMessage().hasText()) {
        String messageText = update.getMessage().getText();
        Long chatId = update.getMessage().getChatId();

        log.info("Received: {} from {}", messageText, chatId);

        // Command ë¶„ê¸° ì²˜ë¦¬
        if (messageText.startsWith("/")) {
            handleCommand(update, messageText);
        } else {
            // ì¼ë°˜ í…ìŠ¤íŠ¸ëŠ” ê²€ìƒ‰ìœ¼ë¡œ ì²˜ë¦¬
            searchCommandHandler.handleSearchCommand(update, messageText);
        }
    }
}

private void handleCommand(Update update, String command) {
    Long chatId = update.getMessage().getChatId();

    // TODO: Command ì²˜ë¦¬ ë¡œì§
    // 1. switch ë˜ëŠ” ì „ëµ íŒ¨í„´ìœ¼ë¡œ Command ë¶„ê¸°
    // 2. ê° Commandì— ë§ëŠ” Handler í˜¸ì¶œ

    switch (command) {
        case "/start":
            // í™˜ì˜ ë©”ì‹œì§€ ì „ì†¡
            break;
        case "/help":
            // ë„ì›€ë§ ì „ì†¡
            break;
        default:
            if (command.startsWith("/search ")) {
                String query = command.substring(8);
                searchCommandHandler.handleSearchCommand(update, query);
            }
            break;
    }
}
```

### 4. ë©”ì‹œì§€ í¬ë§· ì •ì˜

**ê²€ìƒ‰ ê²°ê³¼ (ìºì‹œ ìˆìŒ):**

```
ğŸ“š **"í•´ë¦¬í¬í„°"** ê²€ìƒ‰ ê²°ê³¼

âœ¨ **AI ì¶”ì²œ ë„ì„œ** (ìºì‹œ)
ğŸ’¡ ë¹„ìŠ·í•œ ê²€ìƒ‰ì–´ì— ëŒ€í•œ ì¶”ì²œ ë„ì„œê°€ ìˆìŠµë‹ˆë‹¤.

**ê²€ìƒ‰ëœ ë„ì„œ (ìƒìœ„ 5ê°œ)**

**1.** í•´ë¦¬í¬í„°ì™€ ë§ˆë²•ì‚¬ì˜ ëŒ
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì²©

**2.** í•´ë¦¬í¬í„°ì™€ ë¹„ë°€ì˜ ë°©
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì²©

**3.** í•´ë¦¬í¬í„°ì™€ ì•„ì¦ˆì¹´ë°˜ì˜ ì£„ìˆ˜
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì²©
```

**ê²€ìƒ‰ ê²°ê³¼ (ìºì‹œ ì—†ìŒ):**

```
ğŸ“š **"í•´ë¦¬í¬í„°"** ê²€ìƒ‰ ê²°ê³¼

**ê²€ìƒ‰ëœ ë„ì„œ (ìƒìœ„ 5ê°œ)**

**1.** í•´ë¦¬í¬í„°ì™€ ë§ˆë²•ì‚¬ì˜ ëŒ
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì²©

**2.** í•´ë¦¬í¬í„°ì™€ ë¹„ë°€ì˜ ë°©
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì²©
```

**ë„ì›€ë§:**

```
ğŸ“– **ë„ì›€ë§**

**Command:**
/start - Bot ì‹œì‘
/search <í‚¤ì›Œë“œ> - ë„ì„œ ê²€ìƒ‰
/help - ë„ì›€ë§

**ê²€ìƒ‰ ë°©ë²•:**
â€¢ ë„ì„œëª…ì´ë‚˜ í‚¤ì›Œë“œ ì…ë ¥ (ì˜ˆ: í•´ë¦¬í¬í„°)
â€¢ /search í‚¤ì›Œë“œ (ì˜ˆ: /search ì£¼ì‹ íˆ¬ì)
â€¢ ìì—°ì–´ ê²€ìƒ‰ (ì˜ˆ: ë§ˆë²•ì‚¬ì™€ ê´€ë ¨ëœ ì±…)

**ê²€ìƒ‰ ê¸°ëŠ¥:**
â€¢ AI ê¸°ë°˜ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì§€ì›
â€¢ ìºì‹±ëœ ì¶”ì²œ ë„ì„œê°€ ìˆìœ¼ë©´ í•¨ê»˜ í‘œì‹œ
â€¢ ìƒìœ„ 5ê°œ ê²°ê³¼ë¥¼ ë¹ ë¥´ê²Œ ë°˜í™˜
```

---

## êµ¬í˜„ ìˆœì„œ

### Phase 1: ê¸°ë³¸ ê²€ìƒ‰ ì—°ë™

1. `SearchCommandHandler` ì¸í„°í˜ì´ìŠ¤ ì •ì˜
2. `BookSearchService` ì—°ë™
3. ê²€ìƒ‰ ê²°ê³¼ ì „ì†¡ í…ŒìŠ¤íŠ¸

### Phase 2: ê²°ê³¼ í¬ë§·íŒ…

1. `TelegramResponseFormatter` êµ¬í˜„
2. Markdown í˜•ì‹ ì ìš©
3. í…ìŠ¤íŠ¸ ì˜ë¼ë‚´ê¸° ì²˜ë¦¬

### Phase 3: Command ì²˜ë¦¬

1. Command ë¶„ê¸° ë¡œì§ êµ¬í˜„
2. ì¼ë°˜ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì²˜ë¦¬
3. ì—ëŸ¬ ë©”ì‹œì§€ ì •ì˜

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ê¸°ë³¸ í‚¤ì›Œë“œ ê²€ìƒ‰

```
User: í•´ë¦¬í¬í„°
Bot: ğŸ“š **ê²€ìƒ‰ ê²°ê³¼**
     í‚¤ì›Œë“œ: í•´ë¦¬í¬í„°
     ì´ 3ê±´ ì°¾ìŒ
     ...
```

### 2. ìì—°ì–´ ê²€ìƒ‰

```
User: ë§ˆë²•ì‚¬ì™€ ê´€ë ¨ëœ ì±…
Bot: ğŸ“š **ê²€ìƒ‰ ê²°ê³¼**
     í‚¤ì›Œë“œ: ë§ˆë²•ì‚¬ì™€ ê´€ë ¨ëœ ì±…
     ì´ 5ê±´ ì°¾ìŒ
     ...
```

### 3. Command ê²€ìƒ‰

```
User: /search ì£¼ì‹ íˆ¬ì
Bot: ğŸ“š **ê²€ìƒ‰ ê²°ê³¼**
     í‚¤ì›Œë“œ: ì£¼ì‹ íˆ¬ì
     ...
```

---

## í•™ìŠµ ê³¼ì œ

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

1. [ ] `SearchCommandHandler` ì¸í„°í˜ì´ìŠ¤ ë° êµ¬í˜„
2. [ ] `TelegramResponseFormatter` êµ¬í˜„
3. [ ] í…ìŠ¤íŠ¸ ì˜ë¼ë‚´ê¸° (truncate) ë©”ì„œë“œ
4. [ ] Markdown í˜•ì‹ìœ¼ë¡œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
5. [ ] `/search <í‚¤ì›Œë“œ>` Command ì²˜ë¦¬

### ë„ì „ ê³¼ì œ

1. [ ] Command ì „ëµ íŒ¨í„´ ì ìš©
2. [ ] ê²€ìƒ‰ ê²°ê³¼ í˜ì´ì§• ì²˜ë¦¬
3. [ ] ê²€ìƒ‰ ê²°ê³¼ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ ì •ì˜
4. [ ] ìì—°ì–´ ê²€ìƒ‰ ì²˜ë¦¬ ê°œì„ 

---

## ì°¸ê³  ìë£Œ

- [Telegram Bot API: SendMessage](https://core.telegram.org/bots/api#sendmessage)
- [MarkdownV2 ìŠ¤íƒ€ì¼ ê°€ì´ë“œ](https://core.telegram.org/bots/api#markdownv2-style)

---

## ë‹¤ìŒ ë‹¨ê³„

- [Step 5-3: ëŒ€í™” ê´€ë¦¬](./03.conversation-management.md)
