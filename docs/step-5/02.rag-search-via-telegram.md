# Telegramì„ í†µí•œ RAG ê²€ìƒ‰

## ê°œìš”

Step 2ì—ì„œ êµ¬í˜„í•œ RAG(Retrieval-Augmented Generation) ê²€ìƒ‰ ê¸°ëŠ¥ì„ Telegram Botì„ í†µí•´ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì—°ë™í•©ë‹ˆë‹¤.

## í•™ìŠµ ëª©í‘œ

- ì™¸ë¶€ Service ì—°ë™ ê²½í—˜
- ê²€ìƒ‰ ê²°ê³¼ í¬ë§·íŒ…
- ì‚¬ìš©ì ì¸í„°ë™ì…˜ ì„¤ê³„
- ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬ ì´í•´

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram   â”‚ â”€â”€â–¶ â”‚    Bot      â”‚ â”€â”€â–¶ â”‚   RAG       â”‚ â”€â”€â–¶ â”‚   Event     â”‚
â”‚    User     â”‚     â”‚  Handler    â”‚     â”‚  Strategy   â”‚     â”‚  Listener   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                    â”‚                    â”‚
                            â–¼                    â–¼                    â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Response   â”‚ â—€â”€  â”‚  Book       â”‚ â—€â”€  â”‚    LLM      â”‚
                     â”‚  Formatter  â”‚     â”‚  Service    â”‚     â”‚  (Ollama)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ê°œë…

### 1. RAG ê²€ìƒ‰ íë¦„

```
ì‚¬ìš©ì ì…ë ¥ â†’ Bot ìˆ˜ì‹  â†’ RAG ê²€ìƒ‰ ìš”ì²­ â†’ ìºì‹œ í™•ì¸ â†’ ê²°ê³¼ í¬ë§·íŒ… â†’ ì‘ë‹µ ì „ì†¡
                        â†“              â†“
                 BookSearchService  â† ì´ë²¤íŠ¸ ë°œí–‰
                 (SearchType.RAG)      â†“
                        â†‘         Async Task
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ LLM ê²€ì¦ ë° ìºì‹±
```

### 2. Strategic Caching íŒ¨í„´

**ìµœì´ˆ ê²€ìƒ‰ (ìºì‹œ ë¯¸ìŠ¤):**
1. ì‚¬ìš©ìê°€ "í•´ë¦¬í¬í„°" ê²€ìƒ‰
2. ì‹œë§¨í‹± ìºì‹œ í™•ì¸ â†’ ì—†ìŒ
3. í•˜ì´ë¸Œë¦¬ë“œ ê²°ê³¼ ì¦‰ì‹œ ë°˜í™˜ (ë¹ ë¥¸ ì‘ë‹µ)
4. BookSearchEvent ë°œí–‰
5. ë°±ê·¸ë¼ìš´ë“œì—ì„œ LLM ê²€ì¦ + ìºì‹±

**ë‘ ë²ˆì§¸ ê²€ìƒ‰ (ìºì‹œ íˆíŠ¸):**
1. ì‚¬ìš©ìê°€ "í•´ë¦¬í¬í„°" ì¬ê²€ìƒ‰ ë˜ëŠ” ìœ ì‚¬í•œ í‚¤ì›Œë“œ ê²€ìƒ‰
2. ì‹œë§¨í‹± ìºì‹œ í™•ì¸ â†’ ìˆìŒ!
3. LLM ê²€ì¦ëœ ê²°ê³¼ ì¦‰ì‹œ ë°˜í™˜

### 3. ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬

**BookSearchEvent ë°œí–‰:**
```java
// RagSearchStrategy.java
if (!request.isWarmUp()) {
    Optional<BookSearchResult> cachedResult = semanticCacheService.findSimilarResult(request);
    if (cachedResult.isPresent()) {
        return cachedResult.get();  // ìºì‹œ ìˆìŒ â†’ ì¦‰ì‹œ ë°˜í™˜
    }

    // ìºì‹œ ì—†ìŒ â†’ ë¹ ë¥¸ ì‘ë‹µ + ë°±ê·¸ë¼ìš´ë“œ ì²˜ë¦¬
    eventPublisher.publishEvent(new BookSearchEvent(this, request.keyword()));
    return hybridSearchStrategy.search(pageable, request);
}
```

**BookSearchEventListener ì²˜ë¦¬:**
```java
@Async
@EventListener
public void handleBookSearchEvent(BookSearchEvent event) {
    // ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ LLM ê²€ì¦ ì‹¤í–‰
    bookSearchCacheService.warmUpRagCache(event.getKeyword());
}
```

### 4. LLM ê²€ì¦ ê²°ê³¼ ë°˜ì˜

**ê²€ì¦ ê³¼ì •:**
1. í›„ë³´êµ° 100ê°œ ì¶”ì¶œ (RRF â‰¥ 0.02 í•„í„°ë§)
2. LLMì—ê²Œ relevance ì ìˆ˜ (0~100) ë¶€ì—¬ ìš”ì²­
3. relevance â‰¥ 50ì¸ ë„ì„œë§Œ ìŠ¹ì¸
4. relevance ê¸°ë°˜ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬

**ì½”ë“œ ì˜ˆì‹œ:**
```java
// relevance â‰¥ 50 í•„í„°ë§
List<Long> llmApprovedIds = aiResponse.stream()
    .filter(r -> r.getRelevance() != null && r.getRelevance() >= 50)
    .map(BookAiRecommendationResponse::getId)
    .toList();

// relevance ê¸°ë°˜ ì •ë ¬
List<BookSearchResponse> llmApprovedBooks = retrievalResult.getBooks().getContent()
    .stream()
    .filter(b -> llmApprovedIds.contains(b.getId()))
    .sorted((b1, b2) -> {
        Integer r1 = relevanceMap.getOrDefault(b1.getId(), 0);
        Integer r2 = relevanceMap.getOrDefault(b2.getId(), 0);
        return r2.compareTo(r1);  // ë‚´ë¦¼ì°¨ìˆœ
    })
    .toList();
```

### 5. ë©”ì‹œì§€ í¬ë§·íŒ… ì „ëµ

Telegram ë©”ì‹œì§€ëŠ” **4096ì ì œí•œ**ì´ ìˆìŠµë‹ˆë‹¤.

**ì „ëµ:**
- ìµœëŒ€ 5ê°œ ê²°ê³¼ í‘œì‹œ
- ì œëª©, ì €ì, ì¶œíŒì‚¬, ì´ë¯¸ì§€ ì •ë³´
- AI ì¶”ì²œ ì‚¬ìœ  (ì—†ìœ¼ë©´ "-" í‘œì‹œ)
- ìœ ì‚¬ë„, RRF ì ìˆ˜ í‘œì‹œ
- Markdown ì‚¬ìš©ìœ¼ë¡œ ê°€ë…ì„± í–¥ìƒ

### 6. Command vs ì¼ë°˜ í…ìŠ¤íŠ¸

**Command (`/`ë¡œ ì‹œì‘):**
- `/search í•´ë¦¬í¬í„°`
- ëª…ì‹œì ì¸ ê²€ìƒ‰ ì˜ë„

**ì¼ë°˜ í…ìŠ¤íŠ¸:**
- `í•´ë¦¬í¬í„°`
- ìì—°ìŠ¤ëŸ¬ìš´ ê²€ìƒ‰ ê²½í—˜ (ë³„ë„ Command ë¶ˆí•„ìš”)

**êµ¬í˜„:**
```java
if (messageText.startsWith("/")) {
    handleCommand(update, messageText);  // /search, /start, /help
} else {
    handleSearch(update, messageText);   // ì¼ë°˜ í…ìŠ¤íŠ¸ë„ ê²€ìƒ‰ ì²˜ë¦¬
}
```

---

## êµ¬í˜„ ê°€ì´ë“œ

### 1. RAG ê²€ìƒ‰ ì²˜ë¦¬

```java
/**
 * ë„ì„œ ê²€ìƒ‰ ì²˜ë¦¬ (RAG)
 *
 * <p>RAG ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ì—¬ AI ì¶”ì²œ ì‚¬ìœ ì™€ í•¨ê»˜ ë„ì„œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.
 * ìºì‹±ëœ ì¶”ì²œ ë„ì„œê°€ ìˆìœ¼ë©´ ë¨¼ì € ë³´ì—¬ì£¼ê³ , ê²€ìƒ‰ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
 */
private void handleSearch(Update update, String keyword) {
    Long chatId = update.getMessage().getChatId();

    try {
        // 1. RAG ê²€ìƒ‰ ì‹¤í–‰ (ìºì‹œ í™•ì¸, LLM ì¶”ì²œ ì‚¬ìœ  ìƒì„± í¬í•¨)
        Pageable pageable = PageRequest.of(0, 5);
        BookSearchRequest request = new BookSearchRequest(keyword, null, SearchType.RAG, null, false);
        BookSearchResult result = bookSearchService.searchBooks(pageable, request);

        // 2. ì‘ë‹µ ì „ì†¡ (ì´ë¯¸ì§€, ì ìˆ˜, AI ì¶”ì²œ ì‚¬ìœ  í¬í•¨)
        sendSearchResult(chatId, keyword, result);

    } catch (Exception e) {
        log.error("[Telegram] Search failed for keyword: {}", keyword, e);
        sendSimpleMessage(chatId, "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
}
```

### 2. ê²€ìƒ‰ ê²°ê³¼ í¬ë§·íŒ…

```java
private void sendSearchResult(Long chatId, String keyword, BookSearchResult result) {
    // í—¤ë” ë©”ì‹œì§€
    StringBuilder header = new StringBuilder();
    header.append("ğŸ“š **\"").append(keyword).append("\"** ê²€ìƒ‰ ê²°ê³¼\n\n");

    // AI ì¶”ì²œ ì‚¬ìœ ê°€ ìˆìœ¼ë©´ í‘œì‹œ
    if (result.getAiResponse() != null && !result.getAiResponse().isEmpty()) {
        header.append("ğŸ¤– **AI ì¶”ì²œ ì‚¬ìœ **\n");
        String aiReason = result.getAiResponse().get(0).getWhy();
        if (aiReason == null || aiReason.isBlank()) {
            aiReason = "-";
        } else if (aiReason.length() > 300) {
            aiReason = aiReason.substring(0, 300) + "...";
        }
        header.append("ğŸ’¬ ").append(aiReason).append("\n\n");
    }

    sendSimpleMessage(chatId, header.toString());

    // ì¶”ì²œ ë„ì„œ ëª©ë¡
    List<BookSearchResponse> books = result.getBooks().getContent();
    // ... ë„ì„œë³„ í¬ë§·íŒ…
}
```

### 3. ë„ì„œ ì •ë³´ í¬ë§·íŒ…

```java
private void sendBookWithScore(Long chatId, int index, BookSearchResponse book) {
    StringBuilder bookInfo = new StringBuilder();

    // ìˆœë²ˆê³¼ ì œëª©
    bookInfo.append(index).append(". **").append(book.getTitle()).append("**\n");
    bookInfo.append("ğŸ“– ").append(book.getAuthorName()).append("\n");

    // ì¶œíŒì‚¬
    if (book.getPublisherName() != null) {
        bookInfo.append("ğŸ¢ ").append(book.getPublisherName()).append("\n");
    }

    // ê²€ìƒ‰ ì ìˆ˜ ì •ë³´
    if (book.getSimilarity() != null && book.getSimilarity() > 0) {
        bookInfo.append(String.format("ğŸ¯ ìœ ì‚¬ë„: %.2f%%\n", book.getSimilarity() * 100));
    }
    if (book.getRrfScore() != null && book.getRrfScore() > 0) {
        bookInfo.append(String.format("ğŸ“Š RRF ì ìˆ˜: %.2f\n", book.getRrfScore()));
    }

    // ë„ì„œ ìƒì„¸ ë§í¬
    bookInfo.append("ğŸ”— [ìƒì„¸ ë³´ê¸°](http://localhost:8080/books/").append(book.getId()).append(")\n");

    // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ ì „ì†¡, ì•„ë‹ˆë©´ í…ìŠ¤íŠ¸ë§Œ ì „ì†¡
    if (book.getImageUrl() != null && !book.getImageUrl().isBlank()) {
        sendBookImage(chatId, book.getImageUrl(), bookInfo.toString());
    } else {
        sendSimpleMessage(chatId, bookInfo.toString());
    }
}
```

### 4. ì´ë¯¸ì§€ ì „ì†¡

```java
private void sendBookImage(Long chatId, String imageUrl, String caption) {
    try {
        SendPhoto photo = SendPhoto.builder()
            .chatId(chatId)
            .photo(new InputFile(imageUrl))
            .caption(caption)
            .parseMode("Markdown")
            .build();

        this.execute(photo);
    } catch (TelegramApiException e) {
        log.error("[Telegram] Failed to send image, sending text instead", chatId, e);
        // ì´ë¯¸ì§€ ì „ì†¡ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ë¡œ ëŒ€ì²´
        sendSimpleMessage(chatId, caption);
    }
}
```

---

## ë©”ì‹œì§€ í¬ë§· ì˜ˆì‹œ

### ê²€ìƒ‰ ê²°ê³¼ (AI ì¶”ì²œ ìˆìŒ)

```
ğŸ“š **"í•´ë¦¬í¬í„°"** ê²€ìƒ‰ ê²°ê³¼

ğŸ¤– **AI ì¶”ì²œ ì‚¬ìœ **
ğŸ’¬ í•´ë¦¬í¬í„° ì‹œë¦¬ì¦ˆëŠ” ë§ˆë²• ì„¸ê³„ë¥¼ ë°°ê²½ìœ¼ë¡œ í•œ íŒíƒ€ì§€ ì†Œì„¤ë¡œ, í•´ë¦¬ê°€ í˜¸ê·¸ì™€íŠ¸ ë§ˆë²•í•™êµì—ì„œ ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ë‹¤ì–‘í•œ ëª¨í—˜ì„ í•˜ë©° ì„±ì¥í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ ë‹´ê³  ìˆìŠµë‹ˆë‹¤. ì˜ì›…ì˜ ì—¬ì •, ìš°ì •, ëª¨í—˜, ìš©ê¸° ë“±ì˜ ì£¼ì œë¥¼ ë‹¤ë£¨ê³  ìˆìŠµë‹ˆë‹¤.

**ê²€ìƒ‰ëœ ë„ì„œ (3ê°œ)**

1. **í•´ë¦¬í¬í„°ì™€ ë§ˆë²•ì‚¬ì˜ ëŒ**
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì¹¨
   ğŸ¯ ìœ ì‚¬ë„: 85.00%
   ğŸ“Š RRF ì ìˆ˜: 0.0350
   ğŸ”— [ìƒì„¸ ë³´ê¸°](http://localhost:8080/books/1)

2. **í•´ë¦¬í¬í„°ì™€ ë¹„ë°€ì˜ ë°©**
   ğŸ“– ì¡°ì•¤ K. ë¡¤ë§
   ğŸ¢ ë¬¸í•™ìˆ˜ì¹¨
   ğŸ¯ ìœ ì‚¬ë„: 82.50%
   ğŸ“Š RRF ì ìˆ˜: 0.0330
   ğŸ”— [ìƒì„¸ ë³´ê¸°](http://localhost:8080/books/2)
```

### ê²€ìƒ‰ ê²°ê³¼ (AI ì¶”ì²œ ì—†ìŒ)

```
ğŸ“š **"ì£¼ì‹ íˆ¬ì"** ê²€ìƒ‰ ê²°ê³¼

ğŸ¤– **AI ì¶”ì²œ ì‚¬ìœ **
ğŸ’¬ -

**ê²€ìƒ‰ëœ ë„ì„œ (5ê°œ)**

1. **ì£¼ì‹ íˆ¬ìì˜ ì •ì„**
   ğŸ“– í”¼í„° ë¦°ì¹˜
   ğŸ¢ í•œë¹›ë¹„ì•„
   ğŸ¯ ìœ ì‚¬ë„: 78.00%
   ğŸ“Š RRF ì ìˆ˜: 0.0280
   ğŸ”— [ìƒì„¸ ë³´ê¸°](http://localhost:8080/books/10)
```

---

## êµ¬í˜„ ìˆœì„œ

### Phase 1: ê¸°ë³¸ RAG ê²€ìƒ‰ ì—°ë™

1. `LibraryTelegramBot` í´ë˜ìŠ¤ ìƒì„±
2. `BookSearchService` ì—°ë™ (SearchType.RAG)
3. ê²€ìƒ‰ ê²°ê³¼ ì „ì†¡ í…ŒìŠ¤íŠ¸

### Phase 2: ê²°ê³¼ í¬ë§·íŒ…

1. AI ì¶”ì²œ ì‚¬ìœ  í¬ë§·íŒ…
2. ë„ì„œ ì •ë³´ í¬ë§·íŒ… (ì œëª©, ì €ì, ì¶œíŒì‚¬, ì ìˆ˜)
3. ì´ë¯¸ì§€ ì „ì†¡

### Phase 3: Command ì²˜ë¦¬

1. Command ë¶„ê¸° ë¡œì§ êµ¬í˜„
2. ì¼ë°˜ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì²˜ë¦¬
3. ì—ëŸ¬ ë©”ì‹œì§€ ì •ì˜

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ê¸°ë³¸ í‚¤ì›Œë“œ ê²€ìƒ‰

```
User: í•´ë¦¬í¬í„°
Bot: ğŸ“š **"í•´ë¦¬í¬í„°"** ê²€ìƒ‰ ê²°ê³¼
     ğŸ¤– AI ì¶”ì²œ ì‚¬ìœ : ...
     **ê²€ìƒ‰ëœ ë„ì„œ (3ê°œ)**
     ...
```

### 2. ìì—°ì–´ ê²€ìƒ‰

```
User: ë§ˆë²•ì‚¬ì™€ ê´€ë ¨ëœ ì±…
Bot: ğŸ“š **"ë§ˆë²•ì‚¬ì™€ ê´€ë ¨ëœ ì±…"** ê²€ìƒ‰ ê²°ê³¼
     ...
```

### 3. Command ê²€ìƒ‰

```
User: /search ì£¼ì‹ íˆ¬ì
Bot: ğŸ“š **"ì£¼ì‹ íˆ¬ì"** ê²€ìƒ‰ ê²°ê³¼
     ...
```

---

## í•™ìŠµ ê³¼ì œ

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

1. [ ] `LibraryTelegramBot` RAG ê²€ìƒ‰ ì—°ë™
2. [ ] AI ì¶”ì²œ ì‚¬ìœ  í¬ë§·íŒ…
3. [ ] ë„ì„œ ì •ë³´ í¬ë§·íŒ… (ì´ë¯¸ì§€, ì ìˆ˜, ë§í¬)
4. [ ] `/search <í‚¤ì›Œë“œ>` Command ì²˜ë¦¬
5. [ ] ì¼ë°˜ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì²˜ë¦¬

### ë„ì „ ê³¼ì œ

1. [ ] ê²€ìƒ‰ ê²°ê³¼ ì—†ì„ ê²½ìš° ë©”ì‹œì§€ ì •ì˜
2. [ ] ìì—°ì–´ ê²€ìƒ‰ ì²˜ë¦¬ ê°œì„ 
3. [ ] ì—ëŸ¬ ë©”ì‹œì§€ í¬ë§· ì •ì˜

---

## ì°¸ê³  ìë£Œ

- [Telegram Bot API: SendMessage](https://core.telegram.org/bots/api#sendmessage)
- [Telegram Bot API: SendPhoto](https://core.telegram.org/bots/api#sendphoto)
- [MarkdownV2 ìŠ¤íƒ€ì¼ ê°€ì´ë“œ](https://core.telegram.org/bots/api#markdownv2-style)

---

## ë‹¤ìŒ ë‹¨ê³„

- [Step 5-3: ëŒ€í™” ê´€ë¦¬](./03.conversation-management.md)
