# ëŒ€í™” ê´€ë¦¬

## ê°œìš”

ì‚¬ìš©ìì™€ì˜ ì—°ì†ì ì¸ ëŒ€í™”ë¥¼ ê´€ë¦¬í•˜ê³ , ì´ì „ ê²€ìƒ‰ ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ í•œ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€ ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

## í•™ìŠµ ëª©í‘œ

- ì„¸ì…˜ ê´€ë¦¬ ê¸°ì´ˆ ì´í•´
- ì €ì¥ì†Œ ì¶”ìƒí™” ì„¤ê³„ ê²½í—˜
- í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜ ì„¤ê³„

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram   â”‚ â”€â”€â–¶ â”‚ Conversationâ”‚ â”€â”€â–¶ â”‚ Session Repoâ”‚
â”‚    User     â”‚     â”‚   Service   â”‚     â”‚  (Interface)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                     â”‚
       â–¼                   â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Context   â”‚ â—€â”€  â”‚  Search     â”‚     â”‚  Impl:      â”‚
â”‚   Builder   â”‚     â”‚  History    â”‚     â”‚  â€¢ Map      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â€¢ Redis    â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ê°œë…

### 1. ì„¸ì…˜ì´ë€?

ì‚¬ìš©ìì˜ ëŒ€í™” ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ì •ë³´ì…ë‹ˆë‹¤.

**êµ¬ì„± ìš”ì†Œ:**
- Chat ID: ì‚¬ìš©ì ì‹ë³„ì
- ê²€ìƒ‰ ê¸°ë¡: ìµœê·¼ ê²€ìƒ‰ ì¿¼ë¦¬ì™€ ê²°ê³¼
- ë§ˆì§€ë§‰ í™œë™ ì‹œê°„
- ë§ˆì§€ë§‰ ê²€ìƒ‰ì–´

### 2. í›„ì† ì§ˆë¬¸ ì²˜ë¦¬

ì‚¬ìš©ìê°€ "ë”", "ë˜" ê°™ì€ ë‹¨ì–´ë¡œ ê²€ìƒ‰í•˜ë©´ ì´ì „ ì¿¼ë¦¬ì™€ ì—°ê²°í•©ë‹ˆë‹¤.

**ì˜ˆì‹œ:**
```
User: í•´ë¦¬í¬í„°
Bot: 3ê±´ ì°¾ìŒ

User: ë”
Bot: "í•´ë¦¬í¬í„° ë”"ë¡œ ê²€ìƒ‰í•˜ì—¬ ì¶”ê°€ ê²°ê³¼ ë°˜í™˜
```

### 3. ì €ì¥ì†Œ ì¶”ìƒí™”

ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ êµ¬í˜„ì„ êµì²´ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

**ì¥ì :**
- ê°œë°œ ì´ˆê¸°: Map ì‚¬ìš© (ë¹ ë¥¸ êµ¬í˜„)
- ìš´ì˜ í™˜ê²½: Redis ì‚¬ìš© (ì˜ì† ì €ì¥, ë¶„ì‚°)

---

## êµ¬í˜„ ê°€ì´ë“œ

### 1. ëŒ€í™” ì„¸ì…˜ Entity

```java
/**
 * ëŒ€í™” ì„¸ì…˜
 *
 * <p>ì‚¬ìš©ìë³„ ê²€ìƒ‰ ê¸°ë¡ê³¼ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.
 */
public class ConversationSession {
    private final Long chatId;
    private final List<SearchInteraction> history;
    private LocalDateTime lastActivity;
    private String lastQuery;

    // ê²€ìƒ‰ ê¸°ë¡ ì¶”ê°€
    public void addInteraction(String query, List<SearchResult> results) {
        // TODO: ê²€ìƒ‰ ê¸°ë¡ ì¶”ê°€ ë¡œì§
        // - ìµœëŒ€ 10ê°œ ê¸°ë¡ ìœ ì§€
        // - lastQuery, lastActivity ì—…ë°ì´íŠ¸
    }

    // í›„ì† ì§ˆë¬¸ ì—¬ë¶€ í™•ì¸
    public boolean isExpired() {
        // TODO: 30ë¶„ ì´ìƒ ë¹„í™œë™ ì‹œ ë§Œë£Œ
        return false;
    }

    // ê²€ìƒ‰ ê¸°ë¡ ì¡°íšŒ
    public List<SearchInteraction> getRecentHistory(int count) {
        // TODO: ìµœê·¼ Nê°œ ê¸°ë¡ ë°˜í™˜
        return List.of();
    }

    public record SearchInteraction(
        LocalDateTime timestamp,
        String query,
        List<SearchResult> results
    ) {}
}
```

### 2. ì„¸ì…˜ ì €ì¥ì†Œ ì¸í„°í˜ì´ìŠ¤

```java
/**
 * ëŒ€í™” ì„¸ì…˜ ì €ì¥ì†Œ ì¸í„°í˜ì´ìŠ¤
 *
 * <p>êµ¬í˜„ì²´:
 * - MapConversationSessionRepository: ì¸ë©”ëª¨ë¦¬ Map ê¸°ë°˜ (ê°œë°œìš©)
 * - RedisConversationSessionRepository: Redis ê¸°ë°˜ (ìš´ì˜ìš©)
 */
public interface ConversationSessionRepository {

    /**
     * ì„¸ì…˜ ì¡°íšŒ ë˜ëŠ” ìƒì„±
     *
     * @param chatId Telegram Chat ID
     * @return ëŒ€í™” ì„¸ì…˜
     */
    ConversationSession getOrCreateSession(Long chatId);

    /**
     * ê²€ìƒ‰ ê²°ê³¼ ê¸°ë¡
     *
     * @param chatId Telegram Chat ID
     * @param query ê²€ìƒ‰ì–´
     * @param results ê²€ìƒ‰ ê²°ê³¼
     */
    void addInteraction(Long chatId, String query, List<SearchResult> results);

    /**
     * ì„¸ì…˜ ì‚­ì œ
     *
     * @param chatId Telegram Chat ID
     */
    void clearSession(Long chatId);

    /**
     * ë§Œë£Œëœ ì„¸ì…˜ ì •ë¦¬
     */
    void cleanupExpiredSessions();
}
```

### 3. Phase 1: Map ê¸°ë°˜ êµ¬í˜„ (ê°œë°œìš©)

**êµ¬í˜„ í¬ì¸íŠ¸:**
- `ConcurrentHashMap` ì‚¬ìš© (Thread-safe)
- `@ConditionalOnProperty`ë¡œ í™œì„±í™” ì œì–´

```java
@Slf4j
@Repository
@ConditionalOnProperty(
    name = "telegram.session.store",
    havingValue = "map",
    matchIfMissing = true  // ê¸°ë³¸ê°’
)
public class MapConversationSessionRepository implements ConversationSessionRepository {

    private final ConcurrentHashMap<Long, ConversationSession> sessions = new ConcurrentHashMap<>();

    @Override
    public ConversationSession getOrCreateSession(Long chatId) {
        return sessions.compute(chatId, (id, session) -> {
            if (session == null || session.isExpired()) {
                log.debug("Creating new session for chatId: {}", chatId);
                return new ConversationSession(chatId);
            }
            return session;
        });
    }

    @Override
    public void addInteraction(Long chatId, String query, List<SearchResult> results) {
        // TODO: ì„¸ì…˜ì— ê²€ìƒ‰ ê¸°ë¡ ì¶”ê°€
    }

    @Override
    public void clearSession(Long chatId) {
        sessions.remove(chatId);
        log.debug("Cleared session for chatId: {}", chatId);
    }

    @Override
    public void cleanupExpiredSessions() {
        // TODO: ë§Œë£Œëœ ì„¸ì…˜ ì œê±°
        // íŒíŠ¸: entrySet().removeIf() ì‚¬ìš©
    }
}
```

### 4. Phase 2: Redis ê¸°ë°˜ êµ¬í˜„ (ìš´ì˜ìš©)

**ì˜ì¡´ì„± ì¶”ê°€:**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

**ì„¤ì •:**

```properties
telegram.session.store=redis
spring.data.redis.host=localhost
spring.data.redis.port=6379
```

**êµ¬í˜„ í¬ì¸íŠ¸:**
- `RedisTemplate` ì‚¬ìš©
- TTL ìë™ ë§Œë£Œ ì²˜ë¦¬
- JSON ì§ë ¬í™”

```java
@Slf4j
@Repository
@ConditionalOnProperty(name = "telegram.session.store", havingValue = "redis")
public class RedisConversationSessionRepository implements ConversationSessionRepository {

    private static final String SESSION_KEY_PREFIX = "telegram:session:";
    private static final long SESSION_TTL_MINUTES = 30;

    private final RedisTemplate<String, Object> redisTemplate;

    @Override
    public ConversationSession getOrCreateSession(Long chatId) {
        // TODO: Redisì—ì„œ ì„¸ì…˜ ì¡°íšŒ
        // - í‚¤: telegram:session:{chatId}
        // - ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        // - TTL ì„¤ì •
        return null;
    }

    @Override
    public void addInteraction(Long chatId, String query, List<SearchResult> results) {
        // TODO: ì„¸ì…˜ ì—…ë°ì´íŠ¸ ë° Redis ì €ì¥
        // - JSON ì§ë ¬í™”
        // - TTL ê°±ì‹ 
    }

    @Override
    public void clearSession(Long chatId) {
        // TODO: Redisì—ì„œ ì„¸ì…˜ ì‚­ì œ
    }

    @Override
    public void cleanupExpiredSessions() {
        // Redisê°€ TTLì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ ì •ë¦¬ ë¶ˆí•„ìš”
        log.debug("Redis handles TTL automatically");
    }
}
```

### 5. ì»¨í…ìŠ¤íŠ¸ ë¹Œë”

```java
/**
 * ê²€ìƒ‰ ì»¨í…ìŠ¤íŠ¸ ë¹Œë”
 *
 * <p>ì´ì „ ê²€ìƒ‰ ê¸°ë¡ì„ ê¸°ë°˜ìœ¼ë¡œ ê²€ìƒ‰ì–´ë¥¼ ê°œì„ í•©ë‹ˆë‹¤.
 */
public interface ContextBuilder {

    /**
     * ê²€ìƒ‰ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
     *
     * @param session ëŒ€í™” ì„¸ì…˜
     * @return ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´
     */
    String buildSearchContext(ConversationSession session);

    /**
     * í›„ì† ì§ˆë¬¸ì— ë”°ë¥¸ ì¿¼ë¦¬ ê°œì„ 
     *
     * @param currentQuery í˜„ì¬ ê²€ìƒ‰ì–´
     * @param session ëŒ€í™” ì„¸ì…˜
     * @return ê°œì„ ëœ ê²€ìƒ‰ì–´
     */
    String refineQueryWithHistory(String currentQuery, ConversationSession session);
}
```

**êµ¬í˜„ ê°€ì´ë“œ:**

```java
@Service
public class ContextBuilderImpl implements ContextBuilder {

    private static final List<String> FOLLOW_UP_PATTERNS = List.of(
        "ë”", "ë˜", "ê·¸ì™¸", "ë‹¤ë¥¸", "ë‹¤ìŒ"
    );

    @Override
    public String refineQueryWithHistory(String currentQuery, ConversationSession session) {
        String lastQuery = session.getLastQuery();

        // í›„ì† ì§ˆë¬¸ íŒë‹¨
        if (isFollowUpQuestion(currentQuery)) {
            log.debug("Follow-up question detected. Last query: {}", lastQuery);

            // ì´ì „ ì¿¼ë¦¬ì™€ ê²°í•©
            if (lastQuery != null) {
                return String.format("%s %s", lastQuery, currentQuery);
            }
        }

        return currentQuery;
    }

    private boolean isFollowUpQuestion(String query) {
        // TODO: í›„ì† ì§ˆë¬¸ íŒ¨í„´ ë§¤ì¹­
        // íŒíŠ¸: toLowerCase().startsWith() ì‚¬ìš©
        return false;
    }

    @Override
    public String buildSearchContext(ConversationSession session) {
        // TODO: ì´ì „ ê²€ìƒ‰ ê¸°ë¡ ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ìƒì„±
        return "";
    }
}
```

### 6. ëŒ€í™” ê´€ë¦¬ Service

```java
/**
 * ëŒ€í™” ê´€ë¦¬ Service
 */
public interface ConversationService {
    /**
     * ì„¸ì…˜ ì¡°íšŒ
     */
    ConversationSession getSession(Long chatId);

    /**
     * ê²€ìƒ‰ ê¸°ë¡ ì €ì¥
     */
    void recordSearch(Long chatId, String query, List<SearchResult> results);

    /**
     * ê°œì„ ëœ ê²€ìƒ‰ì–´ ìƒì„±
     */
    String getEnhancedQuery(Long chatId, String userQuery);

    /**
     * ëŒ€í™” ê¸°ë¡ ì‚­ì œ
     */
    void clearConversation(Long chatId);
}
```

---

## ì €ì¥ì†Œë³„ íŠ¹ì„± ë¹„êµ

| íŠ¹ì„± | Map | Redis |
|------|-----|-------|
| **êµ¬í˜„ ë‚œì´ë„** | â­ ì‰¬ì›€ | â­â­ ë³´í†µ |
| **ì™¸ë¶€ ì˜ì¡´ì„±** | ì—†ìŒ | Redis ì„œë²„ |
| **ì˜êµ¬ ì €ì¥** | âŒ | âœ… |
| **ë‹¤ì¤‘ ì„œë²„** | âŒ | âœ… |
| **TTL ì§€ì›** | ìˆ˜ë™ | âœ… ìë™ |
| **ì ìš© í™˜ê²½** | ê°œë°œ, í”„ë¡œí† íƒ€ì… | ìš´ì˜, í™•ì¥ í•„ìš” ì‹œ |

---

## êµ¬í˜„ ìˆœì„œ

### Phase 1: ì¸ë©”ëª¨ë¦¬ Map (ê°œë°œìš©)

1. `ConversationSession` Entity ì‘ì„±
2. `ConversationSessionRepository` ì¸í„°í˜ì´ìŠ¤ ì •ì˜
3. `MapConversationSessionRepository` êµ¬í˜„
4. `ContextBuilder` êµ¬í˜„
5. ëŒ€í™” ê¸°ë¡ Command ì¶”ê°€ (`/history`, `/clear`)

### Phase 2: Redis ì „í™˜ (ìš´ì˜ìš©)

1. Redis ì˜ì¡´ì„± ì¶”ê°€
2. `RedisConversationSessionRepository` êµ¬í˜„
3. ì„¤ì •ìœ¼ë¡œ ì €ì¥ì†Œ ì „í™˜ í…ŒìŠ¤íŠ¸
4. ë¶„ì‚° í™˜ê²½ í…ŒìŠ¤íŠ¸

---

## Command ì¶”ê°€

### 1. ê²€ìƒ‰ ê¸°ë¡ ì¡°íšŒ

```
User: /history
Bot: ğŸ“‹ **ìµœê·¼ ê²€ìƒ‰ ê¸°ë¡**

     1. í•´ë¦¬í¬í„° (3ê±´)
     2. ë§ˆë²•ì‚¬ (5ê±´)
     3. ì£¼ì‹ íˆ¬ì (8ê±´)
```

### 2. ëŒ€í™” ì´ˆê¸°í™”

```
User: /clear
Bot: ğŸ—‘ï¸ ëŒ€í™” ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
```

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. í›„ì† ì§ˆë¬¸ ìë™ ì²˜ë¦¬

```
User: í•´ë¦¬í¬í„°
Bot: 3ê±´ ì°¾ìŒ

User: ë”
Bot: ğŸ’¡ ì´ì „ ê²€ìƒ‰ê³¼ ì—°ê²°í•˜ì—¬ "í•´ë¦¬í¬í„° ë”"ë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
     ì¶”ê°€ ê²°ê³¼ ë°˜í™˜
```

---

## í•™ìŠµ ê³¼ì œ

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

1. [ ] `ConversationSession` Entity ì‘ì„±
2. [ ] `ConversationSessionRepository` ì¸í„°í˜ì´ìŠ¤ ì •ì˜
3. [ ] `MapConversationSessionRepository` êµ¬í˜„
4. [ ] `ContextBuilder` í›„ì† ì§ˆë¬¸ ì²˜ë¦¬
5. [ ] `/history`, `/clear` Command êµ¬í˜„

### ë„ì „ ê³¼ì œ

1. [ ] `RedisConversationSessionRepository` êµ¬í˜„
2. [ ] `@ConditionalOnProperty`ë¡œ êµ¬í˜„ì²´ ë¶„ë¦¬
3. [ ] Redis TTL ì„¤ì •
4. [ ] ì„¸ì…˜ ë§Œë£Œ ì •ì±… ì •ì˜

---

## ë‹¤ìŒ ë‹¨ê³„

- [Step 5-4: ì‚¬ìš©ì í”¼ë“œë°±](./04.user-feedback.md)
