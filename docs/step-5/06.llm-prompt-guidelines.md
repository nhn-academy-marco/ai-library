# 피드백 기반 검색 개선

## 개요

Step 5에서 수집한 피드백 데이터를 실제 검색 결과에 반영하여 AI 추천 품질을 개선하는 방법을 설명합니다.

## 학습 목표

- 피드백 점수 계산 알고리즘 이해
- 검색 결과에 피드백 보너스 적용 방법
- LLM 프롬프트에 피드백 정보 통합 전략
- Relevance 우선, 피드백 보조의 올바른 접근법

---

## 피드백 점수 계산 알고리즘

### 1. 개별 도서 피드백 점수

```
피드백 점수 = (긍정 피드백 수 - 부정 피드백 수) / 총 피드백 수

예시:
도서 1: 👍 15건, 👎 2건 → (15 - 2) / 17 = +0.76
도서 2: 👍 5건,  👎 5건 → (5 - 5) / 10 =   0.00
도서 3: 👍 2건, 👎 8건 → (2 - 8) / 10 = -0.60
```

### 2. 보너스 점수 범위

| 피드백 점수 | 보너스 | 최종 점수 변화 |
|------------|-------|---------------|
| +1.0 (100% 긍정) | +0.5 | 75점 → 75.5점 |
| +0.5 (50% 긍정)  | +0.25 | 70점 → 70.25점 |
| 0.0 (긍정=부정) | 0 | 65점 → 65점 |
| -0.5 (50% 부정) | -0.25 | 60점 → 59.75점 |
| -1.0 (100% 부정) | -0.5 | 55점 → 54.5점 |

**이유:** 너무 큰 보너스는 원래 검색 결과를 왜곡할 수 있음

### 3. 최소 피드백 수 기준

```
피드백이 5건 미만인 도서는 반영하지 않음
이유: 통계적으로 유의미한 데이터가 부족함
```

---

## 전체 검색 흐름

```
1. 사용자 검색 ("해리포터")
   ↓
2. 하이브리드 검색 (Vector + Keyword + RRF)
   결과: [A: 75점, B: 70점, C: 65점, D: 60점]
   ↓
3. 피드백 점수 계산 (각 도서별)
   - 도서 A: +0.3점 (피드백 88%)
   - 도서 B: +0.0점 (피드백 50%)
   - 도서 C: -0.2점 (피드백 20%)
   - 도서 D: 피드백 없음 (반영 안함)
   ↓
4. 최종 점수 합산
   결과: [A: 75.3점, B: 70.0점, C: 64.8점, D: 60.0점]
   ↓
5. 재정렬: [A, B, C, D]
   ↓
6. LLM 추천 (피드백 정보 포함)
```

---

## LLM 프롬프트에 피드백 통합

### 핵심 원칙: Relevance 우선, 피드백 보조

**⚠️ 중요:** 피드백 점수가 높다고 해서 LLM이 무조건 상위에 배치하면 안 됩니다!

```
❌ 나쁜 예시:
"피드백이 높은 도서를 무조건 상위에 배치하세요."
→ LLM이 relevance 판단을 포기하고 피드백 순서대로 반환
→ 신간 도서(피드백 없음)는 영원히 기회를 얻지 못함
→ 피드백 편향(Bias)이 강화되어 검색 품질 저하

✅ 좋은 예시:
"피드백 정보를 참고하여 추천하되, relevance(관련성)을 최우선으로 고려하세요."
→ LLM이 피드백을 하나의 참고 자료로 활용
→ 여전히 relevance를 기반으로 지능적으로 판단
→ 피드백이 없는 신간 도서도 기회를 얻을 수 있음
```

---

### 프롬프트 템플릿

```java
String template = """
    [규칙 - 기본]
    - 사용자 query와 가장 관련 있는 도서를 선별하세요.
    - 각 도서에 relevance 점수(0~100)를 부여하세요.
    - **relevance를 점수의 최우선 기준으로 삼으세요.**
    - relevance가 50 미만인 도서는 출력에서 제외하세요.

    [규칙 - 피드백 정보 활용]
    - 피드백 정보는 **참고 자료**로 활용하세요.
    - 피드백이 있는 도서는 **검증된 도서**로 판단할 수 있습니다.
    - 하지만 피드백이 없다고 해서 relevance가 높은 도서를 배제하지 마세요.
    - 특히 신간 도서는 피드백이 없더라도 내용의 관련성을 중요하게 평가하세요.

    [피드백 정보 해석 가이드]
    - 긍정 피드백 80% 이상: "사용자들이 만족한 검증된 도서"
    - 긍정 피드백 50~79%: "대체로 긍정적인 평가"
    - 긍정 피드백 20~49%: "평가가 엇갈리는 도서"
    - 긍정 피드백 20% 미만: "부정적인 평가가 많음"

    [규칙 - 피드백 유의사항]
    - 피드백이 너무 적은 도서(5건 미만)는 "데이터 부족"으로 간주하세요.
    - 피드백 없는 도서는 "신간 또는 리뷰가 적은 도서"로 간주하세요.
    - 피드백 수가 적더라도 relevance가 높으면 추천하세요.

    [도서 데이터]
    %s

    query: %s
    """;
```

---

### 실제 프롬프트 예시 (검색어: "해리포터")

```
[규칙 - 기본]
- 사용자 query와 가장 관련 있는 도서를 선별하세요.
- 각 도서에 relevance 점수(0~100)를 부여하세요.
- **relevance를 점수의 최우선 기준으로 삼으세요.**
- relevance가 50 미만인 도서는 출력에서 제외하세요.

[규칙 - 피드백 정보 활용]
- 피드백 정보는 **참고 자료**로 활용하세요.
- 피드백이 있는 도서는 **검증된 도서**로 판단할 수 있습니다.
- 하지만 피드백이 없다고 해서 relevance가 높은 도서를 배제하지 마세요.
- 특히 신간 도서는 피드백이 없더라도 내용의 관련성을 중요하게 평가하세요.

[피드백 정보 해석 가이드]
- 긍정 피드백 80% 이상: "사용자들이 만족한 검증된 도서"
- 긍정 피드백 50~79%: "대체로 긍정적인 평가"
- 긍정 피드백 20~49%: "평가가 엇갈리는 도서"
- 긍정 피드백 20% 미만: "부정적인 평가가 많음"

[규칙 - 피드백 유의사항]
- 피드백이 너무 적은 도서(5건 미만)는 "데이터 부족"으로 간주하세요.
- 피드백 없는 도서는 "신간 또는 리뷰가 적은 도서"로 간주하세요.
- 피드백 수가 적더라도 relevance가 높으면 추천하세요.

query: 해리포터

도서 데이터:
ID: 101, 제목: 해리포터와 마법사의 돌, 저자: J.K. 롤링, 평점: 4.8/5.0(127개 리뷰), 피드백: 긍정 92건/부정 8건(92%), 출판일: 2020-01-01
ID: 102, 제목: 해리포터와 비밀의 방, 저자: J.K. 롤링, 평점: 4.6/5.0(89개 리뷰), 출판일: 2020-05-01
ID: 103, 제목: 해리포터와 아즈카반의 죄수, 저자: J.K. 롤링, 피드백: 긍정 2건/부정 1건(67%), 출판일: 2021-03-01
ID: 104, 제목: 해리포터 완결판 세트, 저자: J.K. 롤링, 출판일: 2024-01-15
```

---

## 데이터 포맷팅 구현

```java
/**
 * 도서 정보를 LLM 프롬프트용으로 포맷팅
 */
private String buildBookContext(BookSearchResponse book) {
    StringBuilder bookContext = new StringBuilder();

    // 1. 기본 정보 (항상 포함)
    bookContext.append(String.format("ID: %d, 제목: %s, 저자: %s",
        book.getId(), book.getTitle(), book.getAuthorName()));

    // 2. 평점 정보 (조건부 포함)
    String ratingInfo = formatRatingInfo(book);
    if (!ratingInfo.isEmpty()) {
        bookContext.append(", ").append(ratingInfo);
    }

    // 3. 피드백 정보 (조건부 포함, 5건 이상일 때만)
    String feedbackInfo = formatFeedbackInfo(book);
    if (!feedbackInfo.isEmpty()) {
        bookContext.append(", ").append(feedbackInfo);
    }

    // 4. 출판일
    bookContext.append(String.format(", 출판일: %s",
        book.getEditionPublishDate() != null ? book.getEditionPublishDate().toString() : "알 수 없음"));

    return bookContext.toString();
}

/**
 * 피드백 정보 포맷팅
 * @return "피드백: 긍정 92건/부정 8건(92%)" 또는 빈 문자열 (5건 미만일 때)
 */
private String formatFeedbackInfo(BookSearchResponse book) {
    if (book.getFeedbackStats() != null
            && book.getFeedbackStats().getTotalCount() >= 5) {
        return String.format("피드백: 긍정 %d건/부정 %d건(%.0f%%)",
            book.getFeedbackStats().getGoodCount(),
            book.getFeedbackStats().getBadCount(),
            book.getFeedbackStats().getGoodRatio() * 100);
    }
    return "";  // 5건 미만이면 빈 문자열
}
```

---

## 프롬프트 작성 시 주의사항

| 항목 | ❌ 피해야 할 것 | ✅ 권장하는 것 |
|------|----------------|---------------|
| **목표 설정** | "피드백 순으로 추천" | "Relevance 우선, 피드백 참고" |
| **피드백 없는 도서** | "제외" 또는 "최하위 배치" | "내용 기반으로 평가, 신간 우려" |
| **피드백 해석** | "점수가 높으면 무조건 상위" | "검증된 도서로 신뢰도 가중" |
| **강조 정도** | "무조건", "반드시", "항상" | "참고", "고려", "가능하면" |

---

## 학습 포인트

1. **피드백은 보조 수단**: 원래 검색 결과를 완전히 뒤집지 않음
2. **점수 범위 제한**: 너무 큰 영향을 주지 않도록 최대 ±0.5점
3. **최소 데이터 기준**: 5건 미만은 프롬프트에 포함하지 않아 신뢰성 확보
4. **단계별 반영**: 1차 검색 → 피드백 보너스 → LLM 프롬프트 통합

---

## 참고 자료

- [OpenAI Prompt Engineering Guide](https://platform.openai.com/docs/guides/prompt-engineering)
- [Anthropic Prompt Library](https://docs.anthropic.com/claude/prompt-library)
- [Learning to Rank (Wikipedia)](https://en.wikipedia.org/wiki/Learning_to_rank)

---

## 다음 단계

- [Step 6: MCP 및 외부 서비스 연계](../step-6/01.understanding-mcp.md)
