# ì‚¬ìš©ì í”¼ë“œë°±

## ê°œìš”

ì‚¬ìš©ìë¡œë¶€í„° ê²€ìƒ‰ ê²°ê³¼ì— ëŒ€í•œ í”¼ë“œë°±ì„ ìˆ˜ì§‘í•˜ê³ , ì´ë¥¼ í†µí•´ ê²€ìƒ‰ í’ˆì§ˆì„ ê°œì„ í•©ë‹ˆë‹¤.

## í•™ìŠµ ëª©í‘œ

- JPA Entity ì„¤ê³„ ê²½í—˜
- Controller â†’ Service â†’ Repository ê³„ì¸µ êµ¬ì¡° ì´í•´
- ì‚¬ìš©ì ì¸í„°ë™ì…˜ (Inline Keyboard) ì´í•´
- DTOì™€ Validation í™œìš©

## ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram   â”‚ â”€â”€â–¶ â”‚  Callback   â”‚ â”€â”€â–¶ â”‚  Feedback   â”‚
â”‚    User     â”‚     â”‚   Handler   â”‚     â”‚  Service    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                     â”‚
                            â–¼                     â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚  Inline     â”‚     â”‚  Feedback   â”‚
                     â”‚  Keyboard   â”‚     â”‚  Repository â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## í•µì‹¬ ê°œë…

### 1. í”¼ë“œë°±ì´ë€?

ì‚¬ìš©ìê°€ ê²€ìƒ‰ ê²°ê³¼ì˜ í’ˆì§ˆì„ í‰ê°€í•˜ëŠ” ì •ë³´ì…ë‹ˆë‹¤.

**í”¼ë“œë°± íƒ€ì…:**
- ğŸ‘ ë„ì›€ì´ ë¨ / ğŸ‘ ë„ì›€ì´ ì•ˆë¨
- âœ… ê´€ë ¨ ìˆìŒ / âŒ ê´€ë ¨ ì—†ìŒ

### 2. Inline Keyboard

Telegramì˜ ë²„íŠ¼ í˜•íƒœ UIì…ë‹ˆë‹¤.

**íŠ¹ì§•:**
- Callback ë°ì´í„°ë¡œ ë²„íŠ¼ ì‹ë³„
- ë©”ì‹œì§€ ìˆ˜ì • ê°€ëŠ¥
- ì‚¬ìš©ì ì¹œí™”ì 

### 3. í”¼ë“œë°± í™œìš©

- ê²€ìƒ‰ í’ˆì§ˆ ë¶„ì„
- ì•Œê³ ë¦¬ì¦˜ ê°œì„ 
- ì‚¬ìš©ì ì„ í˜¸ íŒŒì•…

---

## êµ¬í˜„ ê°€ì´ë“œ

### 1. í”¼ë“œë°± Entity

**êµ¬í˜„ í¬ì¸íŠ¸:**
- JPA ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš©
- Enum íƒ€ì… í™œìš©
- JPA ê¸°ë³¸ ìƒì„±ì

```java
/**
 * ê²€ìƒ‰ í”¼ë“œë°± Entity
 */
@Entity
@Table(name = "search_feedbacks")
public class SearchFeedback {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private Long chatId;

    @Column(nullable = false, length = 500)
    private String query;

    @Column(name = "book_id")
    private Long bookId;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private FeedbackType type;

    @Column(nullable = false)
    private LocalDateTime timestamp;

    /**
     * í”¼ë“œë°± íƒ€ì…
     */
    public enum FeedbackType {
        HELPFUL,      // ğŸ‘ ë„ì›€ì´ ë¨
        NOT_HELPFUL,  // ğŸ‘ ë„ì›€ì´ ì•ˆë¨
        RELEVANT,     // âœ… ê´€ë ¨ ìˆìŒ
        NOT_RELEVANT  // âŒ ê´€ë ¨ ì—†ìŒ
    }

    // TODO: ìƒì„±ì, Getters ì‘ì„±
    // íŒíŠ¸: Lombok @AllArgsConstructor, @Getter ì‚¬ìš© ê°€ëŠ¥
}
```

### 2. í”¼ë“œë°± Repository

```java
/**
 * ê²€ìƒ‰ í”¼ë“œë°± Repository
 *
 * <p>í”¼ë“œë°± ë°ì´í„° ì¡°íšŒ ë° ì €ì¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.
 */
public interface SearchFeedbackRepository extends JpaRepository<SearchFeedback, Long> {

    /**
     * Chat IDë³„ í”¼ë“œë°± ì¡°íšŒ (ìµœì‹ ìˆœ)
     */
    List<SearchFeedback> findByChatIdOrderByTimestampDesc(Long chatId);

    /**
     * ì¿¼ë¦¬ê°€ í¬í•¨ëœ í”¼ë“œë°± ì¡°íšŒ
     */
    List<SearchFeedback> findByQueryContaining(String query);

    /**
     * íŠ¹ì • ì‹œê°„ ì´í›„ í”¼ë“œë°± ì¡°íšŒ
     */
    List<SearchFeedback> findByTimestampAfter(LocalDateTime timestamp);
}
```

### 3. í”¼ë“œë°± DTO

**ìš”ì²­ DTO:**

```java
/**
 * í”¼ë“œë°± ë“±ë¡ ìš”ì²­ DTO
 *
 * <p>Validation ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 */
public record FeedbackRequest(
    @NotBlank(message = "ê²€ìƒ‰ì–´ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    String query,

    @NotNull(message = "ë„ì„œ IDëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤")
    Long bookId,

    @NotNull(message = "í”¼ë“œë°± íƒ€ì…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤")
    SearchFeedback.FeedbackType type
) {
}
```

**ì‘ë‹µ DTO:**

```java
/**
 * í”¼ë“œë°± í†µê³„ DTO
 *
 * <p>ê²€ìƒ‰ì–´ë³„ í”¼ë“œë°± í†µê³„ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */
public record FeedbackStats(
    long helpful,
    long notHelpful,
    long relevant,
    long notRelevant
) {
    public double getHelpfulRatio() {
        long total = helpful + notHelpful;
        return total > 0 ? (double) helpful / total : 0;
    }
}
```

### 4. í”¼ë“œë°± Service

```java
/**
 * í”¼ë“œë°± ê´€ë¦¬ Service
 */
public interface FeedbackService {

    /**
     * í”¼ë“œë°± ê¸°ë¡
     *
     * @param chatId Telegram Chat ID
     * @param request í”¼ë“œë°± ìš”ì²­
     */
    void recordFeedback(Long chatId, FeedbackRequest request);

    /**
     * ì‚¬ìš©ì í”¼ë“œë°± ì¡°íšŒ
     *
     * @param chatId Telegram Chat ID
     * @return í”¼ë“œë°± ëª©ë¡
     */
    List<SearchFeedback> getUserFeedback(Long chatId);

    /**
     * í”¼ë“œë°± í†µê³„ ì¡°íšŒ
     *
     * @param query ê²€ìƒ‰ì–´
     * @return í”¼ë“œë°± í†µê³„
     */
    FeedbackStats getFeedbackStats(String query);
}
```

**êµ¬í˜„ ê°€ì´ë“œ:**

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class FeedbackServiceImpl implements FeedbackService {

    private final SearchFeedbackRepository feedbackRepository;

    @Transactional
    @Override
    public void recordFeedback(Long chatId, FeedbackRequest request) {
        // TODO: í”¼ë“œë°± ì €ì¥
        // 1. SearchFeedback Entity ìƒì„±
        // 2. Repository ì €ì¥
        // 3. ë¡œê¹…

        log.info("Feedback recorded: chatId={}, type={}", chatId, request.type());
    }

    @Override
    public List<SearchFeedback> getUserFeedback(Long chatId) {
        // TODO: ì‚¬ìš©ìë³„ í”¼ë“œë°± ì¡°íšŒ
        return List.of();
    }

    @Override
    public FeedbackStats getFeedbackStats(String query) {
        // TODO: í”¼ë“œë°± í†µê³„ ê³„ì‚°
        // 1. ì¿¼ë¦¬ê°€ í¬í•¨ëœ í”¼ë“œë°± ì¡°íšŒ
        // 2. íƒ€ì…ë³„ ê°œìˆ˜ ì§‘ê³„
        // 3. FeedbackStats ìƒì„±
        return null;
    }
}
```

### 5. Inline Keyboard ìƒì„±

```java
/**
 * Telegram Inline Keyboard ìƒì„± Factory
 *
 * <p>ë²„íŠ¼ í˜•íƒœì˜ ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 */
@Component
public class TelegramKeyboardFactory {

    private static final String CALLBACK_PREFIX = "feedback:";

    /**
     * í”¼ë“œë°± Keyboard ìƒì„±
     *
     * @param query ê²€ìƒ‰ì–´
     * @param bookId ë„ì„œ ID
     * @return Inline Keyboard Markup
     */
    public InlineKeyboardMarkup createFeedbackKeyboard(String query, Long bookId) {
        // TODO: Inline Keyboard ìƒì„±
        // íŒíŠ¸:
        // 1. List<List<InlineKeyboardButton>> ìƒì„±
        // 2. ì²« ë²ˆì§¸ í–‰: ë„ì›€ì´ ë¨/ì•ˆë¨
        // 3. ë‘ ë²ˆì§¸ í–‰: ê´€ë ¨ ìˆìŒ/ì—†ìŒ
        // 4. InlineKeyboardMarkup.builder() ì‚¬ìš©

        return null;
    }
}
```

**Callback ë°ì´í„° í¬ë§·:**
```
feedback:{query}:{bookId}:{type}

ì˜ˆ: feedback:í•´ë¦¬í¬í„°:123:HELPFUL
```

### 6. Callback Query Handler

```java
/**
 * Telegram Callback Query Handler
 *
 * <p>Inline Keyboard ë²„íŠ¼ í´ë¦­ ë“±ì˜ Callbackì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class CallbackQueryHandler {

    private final FeedbackService feedbackService;
    private final TelegramClient telegramClient;

    /**
     * Callback ì²˜ë¦¬
     *
     * @param update Telegram Update ê°ì²´
     */
    public void handleCallback(Update update) {
        if (update.hasCallbackQuery()) {
            var callbackQuery = update.getCallbackQuery();
            String data = callbackQuery.getData();
            Long chatId = callbackQuery.getMessage().getChatId();
            Integer messageId = callbackQuery.getMessage().getMessageId();

            log.debug("Callback received: {} from chatId {}", data, chatId);

            // TODO: Callback ë¶„ê¸° ì²˜ë¦¬
            if (data.startsWith("feedback:")) {
                handleFeedback(data, chatId, messageId);
            }
        }
    }

    /**
     * í”¼ë“œë°± Callback ì²˜ë¦¬
     *
     * @param data Callback ë°ì´í„°
     * @param chatId Telegram Chat ID
     * @param messageId ë©”ì‹œì§€ ID
     */
    private void handleFeedback(String data, Long chatId, Integer messageId) {
        try {
            // TODO: í”¼ë“œë°± ì²˜ë¦¬
            // 1. ë°ì´í„° íŒŒì‹± (split(":"))
            // 2. FeedbackRequest ìƒì„±
            // 3. í”¼ë“œë°± ì €ì¥
            // 4. ê°ì‚¬ ë©”ì‹œì§€ ì „ì†¡ (EditMessageText)

            log.info("Feedback recorded from chatId {}", chatId);

        } catch (Exception e) {
            log.error("Failed to handle feedback callback", e);
            sendErrorMessage(chatId, messageId);
        }
    }

    private void sendErrorMessage(Long chatId, Integer messageId) {
        // TODO: ì—ëŸ¬ ë©”ì‹œì§€ ì „ì†¡
    }
}
```

### 7. Bot ì—…ë°ì´íŠ¸ ì²˜ë¦¬

```java
@Override
public void consume(Update update) {
    // Callback Query ì²˜ë¦¬ ìš°ì„ 
    if (update.hasCallbackQuery()) {
        callbackQueryHandler.handleCallback(update);
        return;
    }

    // ê¸°ì¡´ ë©”ì‹œì§€ ì²˜ë¦¬
    if (update.hasMessage() && update.getMessage().hasText()) {
        // ... ê¸°ì¡´ ì½”ë“œ
    }
}
```

---

## ê´€ë¦¬ììš© API

### Feedback Admin Controller

```java
/**
 * í”¼ë“œë°± ê´€ë¦¬ì API Controller
 *
 * <p>í”¼ë“œë°± ì¡°íšŒ ë° í†µê³„ APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 */
@RestController
@RequestMapping("/api/admin/feedback")
@RequiredArgsConstructor
public class FeedbackAdminController {

    private final FeedbackService feedbackService;

    /**
     * í”¼ë“œë°± í†µê³„ ì¡°íšŒ
     *
     * @param query ê²€ìƒ‰ì–´
     * @return í”¼ë“œë°± í†µê³„
     */
    @GetMapping("/stats")
    public ResponseEntity<FeedbackStats> getStats(@RequestParam String query) {
        return ResponseEntity.ok(feedbackService.getFeedbackStats(query));
    }

    /**
     * ìµœê·¼ í”¼ë“œë°± ì¡°íšŒ
     *
     * @param days ê¸°ê°„ (ì¼)
     * @return í”¼ë“œë°± ëª©ë¡
     */
    @GetMapping("/recent")
    public ResponseEntity<List<SearchFeedback>> getRecentFeedback(
            @RequestParam(defaultValue = "7") int days) {
        // TODO: ìµœê·¼ í”¼ë“œë°± ì¡°íšŒ
        return ResponseEntity.ok(List.of());
    }

    /**
     * ì‚¬ìš©ìë³„ í”¼ë“œë°± ì¡°íšŒ
     *
     * @param chatId Telegram Chat ID
     * @return í”¼ë“œë°± ëª©ë¡
     */
    @GetMapping("/user/{chatId}")
    public ResponseEntity<List<SearchFeedback>> getUserFeedback(@PathVariable Long chatId) {
        return ResponseEntity.ok(feedbackService.getUserFeedback(chatId));
    }
}
```

---

## ì‚¬ìš© ì˜ˆì‹œ

### 1. í”¼ë“œë°± ìš”ì²­

```
Bot: ğŸ“š **ê²€ìƒ‰ ê²°ê³¼**
     í‚¤ì›Œë“œ: í•´ë¦¬í¬í„°
     ì´ 3ê±´ ì°¾ìŒ

     **1.** í•´ë¦¬í¬í„°ì™€ ë§ˆë²•ì‚¬ì˜ ëŒ
        ğŸ‘¤ ì¡°ì•¤ K. ë¡¤ë§
        ğŸ“– ëŒ€ë¦° í•™êµì— ì…í•™í•œ í•´ë¦¬í¬í„°ëŠ”...

     ğŸ’¡ ê²€ìƒ‰ ê²°ê³¼ê°€ ë„ì›€ì´ ë˜ì…¨ë‚˜ìš”?
     ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ í”¼ë“œë°±ì„ ì£¼ì‹œë©´ ê²€ìƒ‰ í’ˆì§ˆ ê°œì„ ì— ì°¸ê³ í•˜ê² ìŠµë‹ˆë‹¤!

     [ğŸ‘ ë„ì›€ì´ ë¨] [ğŸ‘ ë„ì›€ì´ ì•ˆë¨]
     [âœ… ê´€ë ¨ ìˆìŒ] [âŒ ê´€ë ¨ ì—†ìŒ]
```

### 2. í”¼ë“œë°± í™•ì¸

```
User: [ğŸ‘ ë„ì›€ì´ ë¨] í´ë¦­
Bot: âœ… ì†Œì¤‘í•œ í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤!

     ê²€ìƒ‰ í’ˆì§ˆ ê°œì„ ì— í™œìš©í•˜ê² ìŠµë‹ˆë‹¤.
```

---

## êµ¬í˜„ ìˆœì„œ

### Phase 1: Entityì™€ Repository

1. `SearchFeedback` Entity ì‘ì„±
2. `SearchFeedbackRepository` ì •ì˜
3. JPA DDL ì„¤ì • (validate)

### Phase 2: Serviceì™€ DTO

1. `FeedbackRequest`, `FeedbackStats` DTO ì‘ì„±
2. `FeedbackService` ì¸í„°í˜ì´ìŠ¤ ë° êµ¬í˜„
3. Validation ì¶”ê°€

### Phase 3: UI ì—°ë™

1. `TelegramKeyboardFactory` êµ¬í˜„
2. `CallbackQueryHandler` êµ¬í˜„
3. Bot ì—…ë°ì´íŠ¸ ì²˜ë¦¬ ê°œì„ 

### Phase 4: ê´€ë¦¬ì API

1. `FeedbackAdminController` êµ¬í˜„
2. í†µê³„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

---

## í•™ìŠµ ê³¼ì œ

### í•„ìˆ˜ êµ¬í˜„ ì‚¬í•­

1. [ ] `SearchFeedback` Entity ì‘ì„±
2. [ ] `SearchFeedbackRepository` ì •ì˜
3. [ ] `FeedbackRequest`, `FeedbackStats` DTO ì‘ì„±
4. [ ] `FeedbackService` êµ¬í˜„
5. [ ] Inline Keyboard ìƒì„±

### ë„ì „ ê³¼ì œ

1. [ ] Validation ì–´ë…¸í…Œì´ì…˜ ì ìš©
2. [ ] í”¼ë“œë°± í†µê³„ ëŒ€ì‹œë³´ë“œ
3. [ ] í”¼ë“œë°± ê¸°ë°˜ ê²€ìƒ‰ ìˆœìœ„ ê°œì„ 
4. [ ] í”¼ë“œë°± ë‚´ë³´ë‚´ê¸° (CSV)

---

## Step 5 ì™„ë£Œ

ì´ì œ ë‹¤ìŒ ê¸°ëŠ¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤:

- âœ… Telegram Bot ê¸°ë³¸ ì„¤ì •
- âœ… í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì—°ë™
- âœ… ëŒ€í™” ê´€ë¦¬
- âœ… ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘

**ì¶•í•˜í•©ë‹ˆë‹¤!** AI ê¸°ë°˜ ê²€ìƒ‰ ì‹œìŠ¤í…œì— ëŒ€í™”í˜• UIë¥¼ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

---

## ë‹¤ìŒ ë‹¨ê³„

- [Step 6: MCP ë° ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê³„](../step-6/01.understanding-mcp.md)
