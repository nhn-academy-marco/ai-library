# 02. 컨텍스트 구축: 검색 결과를 AI에게 전달하기

## 학습 전제조건

이 문서를 학습하기 전에 다음 내용을 알고 있으면 도움이 됩니다:
- Week 3의 01 문서 내용 (RAG 기초)
- Java StringBuilder, String 기본 개념
- Markdown 형식 이해
- JSON 데이터 형식 이해

---

## 1. 개요

벡터 검색 결과는 Java 객체 리스트입니다. 하지만 AI는 텍스트를 읽지 객체를 읽지 못합니다. 검색된 도서 정보를 AI가 이해할 수 있는 텍스트로 변환해야 합니다.

**이 문서에서 배울 내용:**
- 컨텍스트(Context)가 무엇인지
- 검색 결과를 텍스트로 변환하는 방법
- 효과적인 프롬프트 작성법
- AI 응답을 Java DTO로 변환하는 방법
- 토큰 제한(Top-K) 이해하기

> **중요: 컨텍스트의 중요성**
>
> 좋은 검색 결과를 엉망으로 전달하면:
> - AI: "뭐야, 이해가 안 돼"
>
> 깔끔하게 정리해서 전달하면:
> - AI: "그럼, 이렇게 답변할게!"

---

## 2. 핵심 개념 이해

### 2.1. 컨텍스트(Context)

AI가 답변을 생성할 때 참고하는 배경 지식입니다.

**비유로 이해하기:**
```
시험을 보는 상황을 상상해 보세요.

[컨텍스트 없음]
학생: (기억력으로만 답을 쓰기)
→ 틀릴 수 있음

[컨텍스트 있음]
학생: (교과서 옆에 펴두고 답을 쓰기)
→ 정답 확률 높음

여기서 교과서가 "컨텍스트"입니다!
```

**RAG에서의 컨텍스트:**
```
사용자 질문: "초보자를 위한 자바 책"

[컨텍스트]
도서 1: 자바의 정석
- 저자: 남궁성
- 내용: 초보자도 쉽게...

도서 2: 이것이 자바다
- 저자: 신용권
- 내용: 실무 예제...

→ AI가 이 정보를 참고하여 답변 생성
```

### 2.2. 토큰 제한 (Token Limit)

AI는 한 번에 처리할 수 있는 텍스트 길이에 제한이 있습니다.

**비유로 이해하기:**
```
사람의 기억력과 비슷해요.

[한 번에 기억할 수 있는 양]
짧은 문장: "안녕하세요" ✅
중간 문장: "안녕하세요, 오늘 날씨가 좋네요" ✅
긴 문장: "안녕하세요, 오늘 날씨가 좋네요, 저는..." ❌ (잊어버림)

AI도 마찬가지예요:
- 토큰이 너무 많으면 내용을 못 읽어요 ❌
- 적절한 길이로 잘라서 전달해야 해요 ✅
```

**토큰 수 예시:**
```
1 토큰 ≈ 한글 1~2글자 ≈ 영어 3~4글자

[100토큰]
안녕하세요, 초보자를 위한 자바 책을 추천해 드릴게요...

[1000토큰]
도서 소개, 저자 정보, 출판사 정보 등 상세한 내용...

[10000토큰]
너무 많음! AI가 처리 못 할 수 있음
```

### 2.3. 프롬프트 엔지니어링

AI에게 질문을 할 때 역할과 제약 조건을 설계하는 기술입니다.

**비유로 이해하기:**
```
[나쁜 프롬프트]
"책 추천해줘"
→ AI: "어떤 책? 요리책? 만화책?"

[좋은 프롬프트]
"당신은 도서관 사서입니다.
초보자를 위한 자바 책 3권을 추천해주세요.
각 책마다 추천 이유를 설명해주세요."
→ AI: "네, 자바의 정석, 이것이 자바다..."
```

**프롬프트의 구성 요소:**
```
1. 역할 (Persona)
   "당신은 도서관 사서입니다."

2. 배경 (Context)
   "다음 도서 정보를 참고하세요..."

3. 질문 (Question)
   "초보자를 위한 자바 책을 추천해주세요."

4. 제약 (Constraints)
   "최대 5권까지 추천해주세요."
   "반드시 참고 도서 정보를 바탕으로 답변하세요."

5. 출력 형식 (Output Format)
   "JSON 형식으로 답변해주세요."
```

---

## 3. 구현 가이드 (Step-by-Step)

### STEP 1: 검색 결과 정제

검색 결과에서 AI 답변에 필요한 필드만 추출합니다.

**BookSearchResponse → Context 변환:**
```java
/**
 * 검색 결과를 컨텍스트로 변환
 *
 * @param books 검색된 도서 목록
 * @return AI에게 전달할 컨텍스트 텍스트
 */
private String buildContext(List<BookSearchResponse> books) {
    StringBuilder sb = new StringBuilder();

    sb.append("## 도서 정보\n\n");

    for (int i = 0; i < books.size(); i++) {
        BookSearchResponse book = books.get(i);

        // 도서 번호
        sb.append("### 도서 ").append(i + 1).append("\n");

        // 제목 (필수)
        sb.append("- 제목: ").append(book.title()).append("\n");

        // 저자 (필수)
        sb.append("- 저자: ").append(book.authorName()).append("\n");

        // 출판사 (선택)
        sb.append("- 출판사: ").append(book.publisherName()).append("\n");

        // 내용 (필수, 길이 제한)
        if (book.bookContent() != null) {
            String content = book.bookContent();

            // 너무 길면 자르기 (300자 제한)
            if (content.length() > 300) {
                content = content.substring(0, 300) + "...";
            }

            sb.append("- 내용: ").append(content).append("\n");
        }

        // 유사도 점수 (선택)
        if (book.similarity() != null) {
            sb.append("- 유사도: ")
              .append(book.getSimilarityPercent()).append("\n");
        }

        sb.append("\n");
    }

    return sb.toString();
}
```

### STEP 2: 프롬프트 템플릿 작성

기본 프롬프트 템플릿을 만듭니다.

**PromptTemplate.java**
```java
/**
 * RAG 프롬프트 템플릿
 *
 * AI에게 전달할 프롬프트를 생성합니다.
 */
public class PromptTemplate {

    /**
     * 기본 프롬프트 생성
     *
     * @param question 사용자 질문
     * @param context 컨텍스트
     * @return 프롬프트
     */
    public static String createBasicPrompt(
            String question,
            String context
    ) {
        return String.format("""
                당신은 경험 많은 도서관 사서입니다.
                사용자의 질문에 친절하고 상세하게 답변해주세요.

                ## 답변 규칙
                1. 반드시 참고 도서 정보를 바탕으로 답변하세요.
                2. 리스트에 없는 책은 절대로 추천하지 마세요.
                3. 각 도서마다 왜 추천하는지 명확한 이유를 제시하세요.
                4. 최대 5권까지 추천해주세요.
                5. 친절하고 전문적인 어조를 사용하세요.

                ## 질문
                %s

                ## 참고 도서 정보
                %s

                ## 답변
                """,
                question,
                context
        );
    }

    /**
     * JSON 출력 프롬프트 생성
     *
     * @param question 사용자 질문
     * @param context 컨텍스트
     * @return 프롬프트
     */
    public static String createJsonPrompt(
            String question,
            String context
    ) {
        return String.format("""
                [규칙]
                - 사용자의 query와 가장 관련 있는 도서를 선별하세요.
                - 각 도서에 대해 relevance 점수(0~100)를 부여하세요:
                  * 90-100: query와 직접적으로 강하게 연관
                  * 70-89: query와 밀접하게 관련
                  * 50-69: query와 간접적으로 관련
                  * 50 미만: 관련성이 낮으므로 제외
                - 추천 사유("why")에는 순수하게 이유만 설명하세요.
                - 최신 출간일과 query와의 직접적인 관련성을 고려하세요.

                [출력 형식]
                - 반드시 순수 JSON만 출력하세요.
                - 마크다운 코드 블록이나 추가 설명은 절대 포함하지 마세요.
                - 언어는 반드시 한국어를 사용하세요.

                [JSON 구조]
                [
                  {
                    "id": 도서 ID (숫자),
                    "relevance": 연관성 점수 (0-100),
                    "why": "추천 사유"
                  }
                ]

                - 결과는 relevance 기준 내림차순으로 정렬하세요.
                - 입력 데이터에 없는 필드는 추측하지 마세요.

                query: %s

                도서 데이터:
                %s
                """,
                question,
                context
        );
    }
}
```

### STEP 3: AI 응답 역직렬화

AI의 JSON 응답을 Java DTO로 변환합니다.

**BookAiRecommendationResponse.java**
```java
package com.nhnacademy.library.core.book.dto;

/**
 * AI 추천 응답 DTO
 *
 * AI가 생성한 추천 결과를 담습니다.
 */
public record BookAiRecommendationResponse(
        long id,            // 도서 ID
        int relevance,      // 연관성 점수 (0-100)
        String why          // 추천 사유
) {
}
```

**JsonParser.java**
```java
package com.nhnacademy.library.core.book.util;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.nhnacademy.library.core.book.dto.BookAiRecommendationResponse;
import lombok.extern.slf4j.Slf4j;

import java.util.List;

/**
 * JSON 파싱 유틸리티
 *
 * AI 응답을 DTO로 변환합니다.
 */
@Slf4j
public class JsonParser {

    private static final ObjectMapper objectMapper = new ObjectMapper();

    /**
     * AI 응답을 DTO 리스트로 변환
     *
     * @param rawResponse AI의 원본 응답
     * @return 추천 도서 리스트
     */
    public static List<BookAiRecommendationResponse> parseRecommendations(
            String rawResponse
    ) {
        try {
            // 1. JSON 부분 추출 (마크다운 코드 블록 제거)
            String jsonPart = extractJson(rawResponse);

            // 2. JSON 파싱
            return objectMapper.readValue(
                    jsonPart,
                    new TypeReference<List<BookAiRecommendationResponse>>() {}
            );
        } catch (Exception e) {
            log.error("JSON 파싱 실패: {}", rawResponse, e);
            throw new RuntimeException("AI 응답 파싱에 실패했습니다.", e);
        }
    }

    /**
     * 응답에서 JSON 부분만 추출
     *
     * AI가 ```json ... ``` 형식으로 응답할 수 있음
     */
    private static String extractJson(String response) {
        String cleaned = response;

        // 마크다운 코드 블록 제거
        cleaned = cleaned.replaceAll("```json", "");
        cleaned = cleaned.replaceAll("```", "");

        // 앞뒤 공백 제거
        return cleaned.trim();
    }
}
```

### STEP 4: 전체 RAG 서비스 구현

모든 요소를 합쳐서 완전한 RAG 서비스를 만듭니다.

**BookRagService.java**
```java
package com.nhnacademy.library.core.book.service.rag;

import com.nhnacademy.library.core.book.dto.BookAiRecommendationResponse;
import com.nhnacademy.library.core.book.dto.BookSearchResponse;
import com.nhnacademy.library.core.book.util.JsonParser;
import com.nhnacademy.library.core.book.util.PromptTemplate;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * RAG 기반 도서 추천 서비스
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class BookRagService {

    private final BookSearchService bookSearchService;
    private final ChatModel chatModel;

    /**
     * RAG 기반 도서 추천
     *
     * @param question 사용자 질문
     * @return 추천 결과 리스트
     */
    public List<BookAiRecommendationResponse> recommendBooks(String question) {
        // 1. 검색 (Retrieval)
        log.info("질문: {}", question);
        List<BookSearchResponse> books = searchRelevantBooks(question);

        // 2. 컨텍스트 구축
        String context = buildContext(books);
        log.debug("컨텍스트 길이: {} 자", context.length());

        // 3. 프롬프트 생성
        String prompt = PromptTemplate.createJsonPrompt(question, context);
        log.debug("프롬프트:\n{}", prompt);

        // 4. AI 호출 (Generation)
        String rawResponse = callAI(prompt);
        log.debug("AI 응답:\n{}", rawResponse);

        // 5. 역직렬화
        List<BookAiRecommendationResponse> recommendations =
                JsonParser.parseRecommendations(rawResponse);

        log.info("추천 도서 수: {}", recommendations.size());
        return recommendations;
    }

    /**
     * 관련 도서 검색
     */
    private List<BookSearchResponse> searchRelevantBooks(String question) {
        // 상위 10권 검색 (Top-K = 10)
        return bookSearchService.searchBooks(
                SearchType.HYBRID,
                question,
                0,
                10
        );
    }

    /**
     * 컨텍스트 구축
     */
    private String buildContext(List<BookSearchResponse> books) {
        StringBuilder sb = new StringBuilder();

        for (int i = 0; i < books.size(); i++) {
            BookSearchResponse book = books.get(i);

            sb.append("### 도서 ").append(i + 1).append("\n");
            sb.append("- ID: ").append(book.id()).append("\n");
            sb.append("- 제목: ").append(book.title()).append("\n");
            sb.append("- 저자: ").append(book.authorName()).append("\n");

            if (book.bookContent() != null) {
                String content = book.bookContent();
                // 내용 길이 제한 (300자)
                if (content.length() > 300) {
                    content = content.substring(0, 300) + "...";
                }
                sb.append("- 내용: ").append(content).append("\n");
            }

            sb.append("\n");
        }

        return sb.toString();
    }

    /**
     * AI 호출
     */
    private String callAI(String prompt) {
        return chatModel.call(prompt);
    }
}
```

---

## 4. 컨텍스트 최적화

### 4.1. Top-K 전략

너무 많은 도서를 컨텍스트에 포함하면 토큰이 낭비됩니다.

**비교:**
```
[Top-K = 100]
- 장점: 많은 정보
- 단점: 토큰 초과, 응답 느림

[Top-K = 10]
- 장점: 적절한 정보, 빠른 응답
- 단점: 일부 정보 누락 가능

[Top-K = 3]
- 장점: 매우 빠름
- 단점: 정보 부족 가능

→ 보통 5~10권을 추천
```

### 4.2. 내용 요약

도서 소개가 너무 길면 잘라서 전달합니다.

**전처리 예시:**
```java
// 원본
String content = "이 책은 자바의 기초부터 시작해서...
   (500자)"

// 300자로 제한
if (content.length() > 300) {
    content = content.substring(0, 300) + "...";
}

// 결과
"이 책은 자바의 기초부터 시작해서... (300자)..."
```

### 4.3. 필수 필드만 포함

불필요한 정보는 제외합니다.

**포함할 필드:**
- 제목
- 저자
- 내용 요약

**선택적 필드:**
- 유사도 점수
- 출판사
- 출판일

**제외할 필드:**
- ISBN
- 이미지 URL
- 전체 내용

---

## 5. 실습 미션

### 미션 1: 컨텍스트 빌더 테스트

```java
@Test
void testBuildContext() {
    List<BookSearchResponse> books = List.of(
        new BookSearchResponse(1L, "1234567890",
            "자바의 정석", "남궁성", "도우출판",
            "url", "초보자를 위한 자바 책 입문서입니다. " +
                   "기초부터 심화까지 다룹니다.",
            null, null)
    );

    String context = buildContext(books);

    // 확인
    assertTrue(context.contains("자바의 정석"));
    assertTrue(context.contains("남궁성"));
    assertTrue(context.contains("초보자를 위한"));

    System.out.println(context);
}
```

### 미션 2: 프롬프트 생성 테스트

```java
@Test
void testPromptTemplate() {
    String question = "초보자를 위한 자바 책";
    String context = "## 도서 정보\n\n### 도서 1\n...";

    String prompt = PromptTemplate.createBasicPrompt(question, context);

    // 확인
    assertTrue(prompt.contains(question));
    assertTrue(prompt.contains(context));
    assertTrue(prompt.contains("도서관 사서"));
    assertTrue(prompt.contains("최대 5권"));

    System.out.println(prompt);
}
```

### 미션 3: JSON 파싱 테스트

```java
@Test
void testJsonParsing() {
    String rawResponse = """
            ```json
            [
              {"id": 1, "relevance": 95, "why": "초보자에게 적합"},
              {"id": 2, "relevance": 85, "why": "기초부터 다름"}
            ]
            ```
            """;

    List<BookAiRecommendationResponse> recommendations =
        JsonParser.parseRecommendations(rawResponse);

    assertEquals(2, recommendations.size());
    assertEquals(1, recommendations.get(0).id());
    assertEquals(95, recommendations.get(0).relevance());
}
```

---

## 6. 학습 체크리스트

다음 내용을 이해했는지 확인해 보세요:

- [ ] 컨텍스트가 무엇인지 설명할 수 있다
- [ ] 토큰 제한을 이해한다
- [ ] 검색 결과를 텍스트로 변환할 수 있다
- [ ] 프롬프트 엔지니어링 기초를 안다
- [ ] 효과적인 프롬프트를 작성할 수 있다
- [ ] AI 응답을 JSON으로 받을 수 있다
- [ ] JSON을 Java DTO로 변환할 수 있다
- [ ] Top-K 전략을 이해한다

---

## 7. 다음 단계

다음 문서에서는 **LLM 호출과 응답 처리**를 배웁니다:
- Spring AI ChatModel 사용법
- AI 응답 처리 및 에러 핸들링
- 추천 결과를 화면에 표시하기

[다음: 03. LLM 호출과 응답 →](03.llm-invocation-and-response.md)
