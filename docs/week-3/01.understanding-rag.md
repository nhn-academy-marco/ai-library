# 01. RAG 이해: AI가 답변을 생성하는 원리

## 학습 전제조건

이 문서를 학습하기 전에 다음 내용을 알고 있으면 도움이 됩니다:
- Week 1, Week 2의 검색 기능 구현 경험
- AI(인공지능) 기초 개념
- Spring Boot REST API 이해
- JSON 데이터 형식 이해

---

## 1. 개요

AI에게 질문을 하면, AI는 자신이 학습한 지식만으로 답변합니다. 하지만 AI가 모르는 최신 정보나 우리 시스템에만 있는 데이터에 대해서는 엉뚱한 답변을 할 수 있습니다.

**이 문서에서 배울 내용:**
- AI의 환각(Hallucination) 현상이란 무엇인지
- RAG(Retrieval-Augmented Generation)가 무엇인지
- 왜 RAG가 필요한지
- RAG가 작동하는 원리
- Spring AI로 RAG 구현하기

> **중요: RAG의 핵심**
>
> 일반적인 AI:
> - "2024년에 나온 자바 책 추천해줘"
> - "미안하지만, 2021년까지만 알아요"
>
> RAG를 사용한 AI:
> - "2024년에 나온 자바 책 추천해줘"
> - DB에서 최신 도서 정보를 검색 → 그 정보를 바탕으로 답변

---

## 2. 핵심 개념 이해

### 2.1. 환각(Hallucination) 현상

AI가 그럴듯해 보이지만, 사실과 다른 정보를 지어내는 현상입니다.

**비유로 이해하기:**
```
시험을 보는데 교과서를 안 보고 기억력으로만 답하는 상황:

[정상적인 답변]
Q: "한국의 수도는?"
A: "서울입니다"

[환각 현상]
Q: "2024년에 나온 자바 책은?"
A: "2024년에 '자바 마스터'라는 책이 나왔습니다"
→ 실제로는 그런 책이 없음
→ AI가 그럴듯하게 지어냄
```

**환각이 발생하는 이유:**
```
1. 학습 데이터에 없는 정보
   - AI는 학습된 데이터까지만 알아요
   - 그 이후의 정보는 모름

2. 지식의 유효기간 만료
   - 2021년까지 학습된 AI
   - 2024년의 정보를 모름

3. 복잡한 논리 구조
   - 여러 가지 사실을 조합해야 할 때
   - AI가 엉뚱하게 연결할 수 있음
```

### 2.2. RAG (Retrieval-Augmented Generation)

**검색 증강 생성**이라고 합니다. 답변을 생성하기 전에 신뢰할 수 있는 정보를 먼저 찾아서 그 정보를 바탕으로 답변하는 방식입니다.

**비유로 이해하기:**
```
[일반적인 AI - 폐책 테스트]
시험을 볼 때 아무 자료도 없이 기억력으로만 답하기
- 기억나는 대로 답함
- 틀릴 수 있음

[RAG를 사용한 AI - 열린책 테스트]
시험을 볼 때 참고서를 옆에 펼쳐두고 답하기
- 정확한 정보를 찾아서 답음
- 틀릴 확률이 낮음
```

**RAG 작동 원리:**
```
1. 사용자 질문
   "2024년에 나온 자바 책 추천해줘"
      ↓
2. 검색 (Retrieval)
   DB에서 2024년 자바 책 검색
      ↓
3. 검색된 정보 제공
   "2024년에 나온 자바 책 10권 발견"
   - 자바의 정석 (2024.01)
   - 이것이 자바다 (2024.03)
   ...
      ↓
4. AI가 정보를 바탕으로 답변 생성 (Generation)
   "검색한 결과를 바탕으로 2024년에 나온 자바 책을 추천해드릴게요..."
```

### 2.3. RAG의 장점

| 장점 | 설명 | 예시 |
|------|------|------|
| 신뢰성 | 실제 데이터를 근거로 답변 | 도서관에 실제로 있는 책만 추천 |
| 최신성 | 최신 정보를 즉시 반영 | 2024년 책도 바로 검색 가능 |
| 투명성 | 출처를 명확히 제시 | "어떤 도서에서 찾았는지" 알 수 있음 |

**비유로 이해하기:**
```
[신뢰성]
AI: "이 책을 추천해요"
사용자: "정말 그 책이 있어요?"
AI: "네, 도서관 DB에 있어요"

[최신성]
AI: "어제 나온 신간 책이에요"
사용자: "어떻게 알아요?"
AI: "실시간으로 DB를 검색했어요"

[투명성]
AI: "이 책을 추천해요 (출처: 도서관 DB 검색 결과)"
사용자: "어떤 근거로 추천했어?"
AI: "3권의 책을 참고했어요"
```

---

## 3. RAG 구현 흐름

### 3.1. 전체 시스템 흐름

```
[사용자]                      [시스템]                     [AI 모델]
    │                           │                            │
    │  1. 질문 입력               │                            │
    │  "초보자를 위한 자바 책"    │                            │
    ├──────────────────────────>│                            │
    │                           │                            │
    │                           │  2. 임베딩 생성              │
    │                           │  "초보자를 위한 자바 책"     │
    │                           │  → [0.1, 0.2, ...]          │
    │                           │                            │
    │                           │  3. 하이브리드 검색          │
    │                           ├─────────────────────────>│
    │                           │  (DB)                       │
    │                           │<─────────────────────────┤
    │                           │  10권 검색됨                 │
    │                           │                            │
    │                           │  4. 컨텍스트 구축           │
    │                           │  (검색 결과를 텍스트로 변환)  │
    │                           │                            │
    │                           │  5. 프롬프트 생성            │
    │                           │  (질문 + 검색 결과)          │
    │                           │                            │
    │                           │  6. AI 호출                 │
    │                           ├─────────────────────────>│
    │                           │  "다음 책들을 추천해줘..."   │
    │                           │                            │
    │                           │  7. AI 답변                 │
    │                           │<─────────────────────────┤
    │                           │  "초보자에게 추천하는 책..." │
    │                           │                            │
    │  8. 결과 표시               │                            │
    │<──────────────────────────┤                            │
    │  1. 자바의 정석             │                            │
    │  2. 이것이 자바다           │                            │
```

### 3.2. 상세 단계

**STEP 1: 사용자 질문 수신**
```
사용자: "초보자를 위한 자바 책 추천해줘"
검색 방식: "AI 도서 추천 (RAG)"
```

**STEP 2: 임베딩 생성**
```
질문: "초보자를 위한 자바 책"
      ↓
AI 모델 (임베딩)
      ↓
벡터: [0.12, -0.5, 0.88, 0.23, ..., 0.45]
      ↑ 총 1024개의 숫자
```

**STEP 3: 하이브리드 검색**
```
[키워드 검색]
"자바" + "초보자" → 제목에 포함된 책

[벡터 검색]
벡터 유사도 → 의미가 비슷한 책

[RRF 결합]
두 결과를 합쳐서 최상위 10권 선택
```

**STEP 4: 컨텍스트 구축**
```
검색 결과 → Markdown 텍스트

## 도서 1
제목: 자바의 정석
저자: 남궁성
내용: 초보자도 쉽게...

## 도서 2
제목: 이것이 자바다
저자: 신용권
내용: 실무 예제 중심...
```

**STEP 5: 프롬프트 생성**
```
당신은 도서관 사서입니다.
다음 도서 정보를 참고하여 질문에 답변해주세요.

[질문]
초보자를 위한 자바 책 추천해줘

[참고 도서]
## 도서 1
제목: 자바의 정석
...

[출력 형식]
JSON 형식으로 답변해주세요.
```

**STEP 6: LLM 호출**
```
프롬프트 → AI 모델 (Gemini)
      ↓
AI 분석 및 답변 생성
      ↓
JSON 응답
{
  "recommendations": [
    {
      "title": "자바의 정석",
      "reason": "초보자를 위해...",
      "relevance": 95
    }
  ]
}
```

**STEP 7: 응답 표시**
```
JSON → Java DTO → 화면 표시

AI 추천 도서

1. 자바의 정석
   추천 이유: 초보자를 위해 기초부터...
   일치율: 95%
```

---

## 4. 구현 가이드 (Step-by-Step)

### STEP 1: 의존성 추가

Spring AI를 사용하여 Google Gemini를 연동합니다.

**pom.xml**
```xml
<dependencies>
    <!-- Google Gemini 모델 -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-starter-model-google-genai</artifactId>
    </dependency>

    <!-- OpenAI Embedding 모델 -->
    <dependency>
        <groupId>org.springframework.ai</groupId>
        <artifactId>spring-ai-openai</artifactId>
    </dependency>
</dependencies>
```

### STEP 2: Gemini 설정

**application.properties**
```properties
# Google Gemini API
spring.ai.genai.api-key=${GEMINI_API_KEY}
spring.ai.genai.chat.options.model=gemini-2.0-flash
spring.ai.genai.chat.options.temperature=0.7
```

### STEP 3: RAG Service 구현

**BookRagService.java**
```java
package com.nhnacademy.library.core.book.service.rag;

import com.nhnacademy.library.core.book.dto.BookSearchRequest;
import com.nhnacademy.library.core.book.dto.BookSearchResponse;
import com.nhnacademy.library.core.book.service.search.BookSearchService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.ai.chat.prompt.Prompt;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * RAG 기반 도서 추천 서비스
 *
 * AI를 사용하여 도서를 추천합니다.
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class BookRagService {

    private final BookSearchService bookSearchService;
    private final ChatModel chatModel;

    /**
     * RAG 기반 도서 추천
     *
     * @param question 사용자 질문
     * @return 추천 결과
     */
    public String recommendBooks(String question) {
        // 1. 검색 (Retrieval)
        List<BookSearchResponse> books = bookSearchService.searchBooks(
                question,
                SearchType.HYBRID
        );

        log.info("검색된 도서 수: {}", books.size());

        // 2. 컨텍스트 구축
        String context = buildContext(books);

        // 3. 프롬프트 생성
        String prompt = buildPrompt(question, context);

        // 4. AI 호출 (Generation)
        String response = chatModel.call(prompt);

        return response;
    }

    /**
     * 검색 결과를 컨텍스트로 변환
     */
    private String buildContext(List<BookSearchResponse> books) {
        StringBuilder sb = new StringBuilder();

        sb.append("## 도서 정보\n\n");

        for (int i = 0; i < books.size(); i++) {
            BookSearchResponse book = books.get(i);

            sb.append("### 도서 ").append(i + 1).append("\n");
            sb.append("- 제목: ").append(book.title()).append("\n");
            sb.append("- 저자: ").append(book.authorName()).append("\n");
            sb.append("- 출판사: ").append(book.publisherName()).append("\n");

            if (book.bookContent() != null) {
                String content = book.bookContent();
                if (content.length() > 200) {
                    content = content.substring(0, 200) + "...";
                }
                sb.append("- 내용: ").append(content).append("\n");
            }

            sb.append("\n");
        }

        return sb.toString();
    }

    /**
     * 프롬프트 생성
     */
    private String buildPrompt(String question, String context) {
        return String.format("""
                당신은 경험 많은 도서관 사서입니다.
                사용자의 질문에 친절하고 상세하게 답변해주세요.

                ## 질문
                %s

                ## 참고 도서 정보
                %s

                ## 답변 규칙
                1. 반드시 참고 도서 정보를 바탕으로 답변하세요.
                2. 각 도서마다 왜 추천하는지 명확한 이유를 제시하세요.
                3. 최대 5권까지 추천해주세요.
                4. 친절하고 전문적인 어조를 사용하세요.
                """,
                question,
                context
        );
    }
}
```

---

## 5. 데이터 지표 이해

RAG 시스템에서 사용하는 주요 지표들입니다.

### 5.1. AI 추천 % (Relevance)

AI가 사용자 질문과 도서의 관련성을 분석해서 부여한 점수입니다.

**예시:**
```
질문: "초보자를 위한 자바 책"

도서 1: "자바의 정석"
→ AI 추천 95%
→ 질문과 매우 관련 있음 ✅

도서 2: "파이썬 프로그래밍"
→ AI 추천 20%
→ 질문과 거의 관련 없음 ❌
```

### 5.2. 일치율 (Similarity)

벡터 임베딩으로 계산된 수치적 유사도입니다.

**예시:**
```
질문 벡터: [0.1, 0.2, 0.3, ...]
도서 벡터: [0.12, 0.18, 0.28, ...]

유사도: 98% → 매우 비슷함
```

### 5.3. RRF 점수

키워드 검색과 벡터 검색 순위를 결합한 점수입니다.

**예시:**
```
[키워드 검색] 1위 + [벡터 검색] 2위
= 높은 RRF 점수
→ 최종 상위 노출
```

---

## 6. 실습 미션

### 미션 1: 컨텍스트 빌더 테스트

```java
@Test
void testBuildContext() {
    List<BookSearchResponse> books = List.of(
        new BookSearchResponse(1L, "1234567890",
            "자바의 정석", "남궁성", "도우출판",
            "url", "초보자를 위한 자바 책", null, null)
    );

    String context = buildContext(books);

    System.out.println(context);
    // 예상: "## 도서 정보\n\n### 도서 1\n- 제목: 자바의 정석..."
}
```

### 미션 2: 프롬프트 생성 테스트

```java
@Test
void testBuildPrompt() {
    String question = "초보자를 위한 자바 책";
    String context = "## 도서 정보\n\n### 도서 1\n...";

    String prompt = buildPrompt(question, context);

    assertTrue(prompt.contains(question));
    assertTrue(prompt.contains(context));
    assertTrue(prompt.contains("도서관 사서"));
}
```

### 미션 3: RAG 질문 테스트

```java
@Test
void testRagRecommendation() {
    String question = "초보자를 위한 자바 책";

    String response = bookRagService.recommendBooks(question);

    assertNotNull(response);
    assertFalse(response.isEmpty());
    System.out.println(response);
}
```

---

## 7. 학습 체크리스트

다음 내용을 이해했는지 확인해 보세요:

- [ ] 환각(Hallucination) 현상이 무엇인지 안다
- [ ] RAG가 무엇인지 설명할 수 있다
- [ ] 왜 RAG가 필요한지 이해한다
- [ ] RAG의 작동 원리를 안다
- [ ] 컨텍스트를 구축할 수 있다
- [ ] 프롬프트를 생성할 수 있다
- [ ] Spring AI로 RAG를 구현할 수 있다
- [ ] AI 추천%, 일치율, RRF 점수의 차이를 안다

---

## 8. 다음 단계

다음 문서에서는 **컨텍스트 구축**을 배웁니다:
- 검색 결과를 AI에게 전달하는 방법
- 컨텍스트 크기 최적화
- 효과적인 프롬프트 작성법

[다음: 02. 컨텍스트 구축 →](02.context-construction.md)

---

## ❓ FAQ (자주 묻는 질문)

### Q1: RAG와 Fine-tuning의 차이는 무엇인가요?

**A:** 모델을 수정하지 않고 외부 지식을 추가하는 것이 RAG입니다.

| 특징 | Fine-tuning | RAG |
|------|-------------|-----|
| 모델 수정 | 필요 (학습) | 불필요 |
| 최신 정보 | 어려움 | 쉬움 (DB만 업데이트) |
| 비용 | 높음 | 낮음 |
| 구현 난이도 | 어려움 | 쉬움 |
| 환각 현상 | 줄어들음 | 훨씬 줄어듦 |

**결론:** 대부분의 경우 RAG가 더 실용적입니다.

### Q2: 컨텍스트가 너무 길면 어떻게 하나요?

**A:** AI의 토큰 한도를 초과하면 에러가 발생합니다.

해결 방법:
1. **Top-K 제한:** 상위 K개만 사용 (예: 상위 5개)
2. **컨텍스트 길이 제한:** 일정 길이로 자르기
3. **청킹 후 요약:** 긴 문서를 요약해서 포함

### Q3: 검색 결과가 없으면 어떻게 하나요?

**A:** AI에게 "찾는 내용이 없음"을 알리고 일반적인 답변을 하게 합니다.

프롬프트 예시:
```
참고 도서 정보가 없다면, 일반적인 지식으로 답변하고
"정확한 답변을 위해 도서 정보가 부족합니다"라고 덧붙여세요.
```

### Q4: AI가 거짓 정보를 만들어내면 어떻게 하나요?

**A:** 프롬프트에 "정보가 없으면 모른다고 답변하세요"라고 명시합니다.

```
## 답변 규칙
1. 참고 도서 정보에 없는 내용은 "모른다"고 답변하세요.
2. 추측하지 마세요.
3. 확실하지 않은 정보는 포함하지 마세요.
```

### Q5: 여러 사용자가 동시에 RAG를 호출하면 어떻게 하나요?

**A:** 각 요청이 독립적으로 처리됩니다.

주의사항:
- API 호출 한도 확인 (OpenAI 등)
- 동시 요청이 많으면 캐싱 고려
- 비용 발생 유의

---

## 🔧 트러블슈팅

### 문제 1: AI 응답이 너무 느립니다

**증상:** RAG 요청 후 응답까지 10초 이상 걸립니다.

**원인:**
1. 검색이 느림
2. 컨텍스트가 너무 김
3. AI API 속도 문제

**해결:**
1. 검색 최적화 (인덱스 확인)
2. Top-K 줄이기 (10 → 5)
3. 더 빠른 모델 사용 (gemini-2.0-flash 추천)

### 문제 2: AI 응답이 부정확합니다

**증상:** 검색 결과와 관련 없는 답변을 합니다.

**원인:**
- 프롬프트가 명확하지 않음
- 컨텍스트의 순서가 나쁨 수 있음
- Temperature가 너무 높음

**해결:**
1. 프롬프트 개선 ("반드시 참고 도서 정보를 바탕으로" 강조)
2. 관련성 순으로 정렬
3. Temperature 낮추기 (0.7 → 0.3)

### 문제 3: API 키 오류

**증상:**
```
spring.ai.genai.api-key is not defined
```

**원인:** API 키가 설정되지 않음

**해결:**
1. `application.properties`에 키 설정
2. 또는 환경 변수로 설정: `export GEMINI_API_KEY=xxx`

### 문제 4: 검색 결과가 컨텍스트에 포함되지 않음

**증상:** AI 답변에 검색 결과가 반영되지 않음

**원인:** 컨텍스트 빌더 로직 오류

**해결:**
```java
// 테스트로 컨텍스트 확인
@Test
void debugContext() {
    String context = buildContext(books);
    log.info("Context:\n{}", context);
}
```

---

## 📖 참고자료

### 공식 문서
- [Spring AI Documentation](https://docs.spring.io/spring-ai/reference/)
- [LangChain RAG Tutorial](https://python.langchain.com/docs/tutorials/rag)
