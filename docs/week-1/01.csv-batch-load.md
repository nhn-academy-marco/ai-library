# 01. ë°ì´í„° ì ì¬: ê³µê³µ ë„ì„œ CSV Batch Load

## í•™ìŠµ ì „ì œì¡°ê±´

ì´ ë¬¸ì„œë¥¼ í•™ìŠµí•˜ê¸° ì „ì— ë‹¤ìŒ ë‚´ìš©ì„ ì•Œê³  ìˆìœ¼ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤:
- Java ê¸°ì´ˆ ë¬¸ë²• (í´ë˜ìŠ¤, ì¸í„°í˜ì´ìŠ¤, ë¦¬ìŠ¤íŠ¸)
- Spring Boot ê¸°ì´ˆ (@Component, @Service ì–´ë…¸í…Œì´ì…˜)
- ë°ì´í„°ë² ì´ìŠ¤ ê¸°ì´ˆ (INSERT, íŠ¸ëœì­ì…˜ ê°œë…)

---

## 1. ê°œìš”

ì™¸ë¶€ ê³µê³µ ë„ì„œ ë°ì´í„°(CSV)ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ëŒ€ëŸ‰ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ë°°ì¹˜(Batch) ì²˜ë¦¬ë¥¼ êµ¬í˜„í•´ ë´…ë‹ˆë‹¤.

**ì´ ë¬¸ì„œì—ì„œ ë°°ìš¸ ë‚´ìš©:**
- ë°°ì¹˜(Batch) ì²˜ë¦¬ê°€ ë¬´ì—‡ì´ê³  ì™œ í•„ìš”í•œì§€
- ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ë¡œ ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ëŠ” ë°©ë²•
- ëŒ€ëŸ‰ ë°ì´í„°ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì €ì¥í•˜ëŠ” ë°©ë²•
- CSV íŒŒì¼ì„ ì½ì–´ì„œ DBì— ì €ì¥í•˜ëŠ” ì „ì²´ ê³¼ì •

> **ì¤‘ìš”: ì™œ ë°°ì¹˜ ì²˜ë¦¬ê°€ ì¤‘ìš”í• ê¹Œìš”?**
>
> ë„ì„œê´€ì— ìƒˆë¡œ ì±… 10ë§Œ ê¶Œì´ ë“¤ì–´ì™”ë‹¤ê³  ìƒìƒí•´ ë³´ì„¸ìš”.
>
> - **í•˜ë‚˜ì”© ì €ì¥**: 1ê¶Œì”© ë„ì„œê´€ì— ê°€ì ¸ê°€ë©´ 10ë§Œ ë²ˆ ì™”ë‹¤ ê°”ë‹¤ í•´ì•¼ í•©ë‹ˆë‹¤.
> - **ë°°ì¹˜ ì²˜ë¦¬**: 1,000ê¶Œì”© ë°•ìŠ¤ì— ë‹´ì•„ì„œ ê°€ì ¸ê°€ë©´ 100ë²ˆë§Œ ì˜¤ë©´ ë©ë‹ˆë‹¤!
>
> ì´ê²ƒì´ ë°°ì¹˜ ì²˜ë¦¬ì˜ í•µì‹¬ì…ë‹ˆë‹¤. **ëª¨ì•„ì„œ í•œ ë²ˆì— ì²˜ë¦¬**í•˜ëŠ” ê²ƒì´ì£ .

---

## 2. í•µì‹¬ ê°œë… ì´í•´

### 2.1. ë°°ì¹˜(Batch) ì²˜ë¦¬ë€?

**ë°°ì¹˜(Batch)**ëŠ” ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ ëª¨ì•„ì„œ í•œ ë²ˆì— ì²˜ë¦¬í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

**ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°:**
```
í¸ì§€ 100í†µì„ ë³´ë‚´ëŠ” ìƒí™©ì„ ìƒìƒí•´ ë³´ì„¸ìš”.

í•˜ë‚˜ì”© ë³´ë‚´ê¸°:
- í¸ì§€ 1í†µ ì“°ê¸° â†’ ìš°ì²´êµ­ ê°€ê¸° â†’ ë°œì†¡
- í¸ì§€ 1í†µ ì“°ê¸° â†’ ìš°ì²´êµ­ ê°€ê¸° â†’ ë°œì†¡
... (100ë²ˆ ë°˜ë³µ)

ë°°ì¹˜ ì²˜ë¦¬:
- í¸ì§€ 100í†µ ì“°ê¸° â†’ í•œ ë²ˆì— ìš°ì²´êµ­ ê°€ê¸° â†’ ë°œì†¡

ì–´ë–¤ ë°©ë²•ì´ ë” íš¨ìœ¨ì ì¼ê¹Œìš”?
ë‹¹ì—°íˆ ë°°ì¹˜ ì²˜ë¦¬ì…ë‹ˆë‹¤!
```

**ë°°ì¹˜ ì²˜ë¦¬ì˜ íŠ¹ì§•:**
- ëŒ€ëŸ‰ ë°ì´í„°ë¥¼ ë¹ ë¥´ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- ë„¤íŠ¸ì›Œí¬/DB ì—°ê²° íšŸìˆ˜ë¥¼ ì¤„ì…ë‹ˆë‹¤
- íŠ¸ëœì­ì…˜ ê´€ë¦¬ê°€ ì‰½ìŠµë‹ˆë‹¤
- ì‹¤ì‹œê°„ ì²˜ë¦¬ëŠ” ì–´ë µìŠµë‹ˆë‹¤

### 2.2. CSV íŒŒì¼ì´ë€?

**CSV**ëŠ” Comma-Separated Valuesì˜ ì•½ìë¡œ, ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„ëœ í…ìŠ¤íŠ¸ íŒŒì¼ì…ë‹ˆë‹¤.

**ì˜ˆì‹œ:**
```csv
ISBN,TITLE,AUTHOR_NAME,PUBLISHER_NAME
9791165930377,Javaì˜ì •ì„,ë‚¨ê¶ì„±,ë„ìš°ì¶œíŒ
9791162233968,ìë°”ì½”ë”©ì˜ë²•ì¹™,ê¹€ë™í˜„,ê¸¸ë²—
```

> **ì°¸ê³ : ì™œ CSVì¸ê°€ìš”?**
>
> CSVëŠ” ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ëŠ” ê°€ì¥ ê¸°ë³¸ì ì¸ í˜•ì‹ì…ë‹ˆë‹¤.
> - ì—‘ì…€ì—ì„œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤
> - ë©”ëª¨ì¥ì—ì„œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
> - ëª¨ë“  í”„ë¡œê·¸ë˜ë° ì–¸ì–´ê°€ ì§€ì›í•©ë‹ˆë‹¤

### 2.3. ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ë€?

**ì´ë²¤íŠ¸(Event)**ëŠ” "ë¬´ì–¸ê°€ ì¼ì–´ë‚¬ìŒ"ì„ ì•Œë¦¬ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤.

**ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°:**
```
ì‹ë‹¹ì„ ìƒìƒí•´ ë³´ì„¸ìš”.

[ì†ë‹˜] --"ì£¼ë¬¸í•´ìš”"--> [ì¢…ì—…ì›] --"ì£¼ë¬¸ì„œ ì „ë‹¬"--> [ì£¼ë°©]

ì´ ê³¼ì •ì—ì„œ:
- ì†ë‹˜ê³¼ ì£¼ë°©ì€ ì„œë¡œ ì§ì ‘ ëŒ€í™”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- ì¢…ì—…ì›ì´ ì¤‘ê°„ì—ì„œ ì—°ê²°í•´ ì¤ë‹ˆë‹¤
- ì£¼ë¬¸ì„œ(ì´ë²¤íŠ¸)ë¡œ ì •ë³´ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤

ì´ê²ƒì´ ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì˜ í•µì‹¬ì…ë‹ˆë‹¤!
```

**ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì˜ ì¥ì :**
- **ë¶„ë¦¬**: ì½”ë“œë¼ë¦¬ ì„œë¡œë¥¼ ëª°ë¼ë„ ë©ë‹ˆë‹¤
- **í™•ì¥**: ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ ì‰½ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- **ìœ ì§€ë³´ìˆ˜**: í•œ ë¶€ë¶„ì„ ê³ ì³ë„ ë‹¤ë¥¸ ë¶€ë¶„ì— ì˜í–¥ì´ ì—†ìŠµë‹ˆë‹¤

### 2.4. íŠ¸ëœì­ì…˜(Transaction)ì´ë€?

**íŠ¸ëœì­ì…˜**ì€ "ëª¨ë‘ ì„±ê³µí•˜ê±°ë‚˜, ëª¨ë‘ ì‹¤íŒ¨í•˜ê±°ë‚˜"ë¥¼ ë³´ì¥í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

**ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°:**
```
ì€í–‰ ì´ì²´ë¥¼ ìƒìƒí•´ ë³´ì„¸ìš”.

1. ë‚´ ê³„ì •ì—ì„œ 10,000ì› ì¶œê¸ˆ (ì„±ê³µ)
2. ìƒëŒ€ë°© ê³„ì •ìœ¼ë¡œ 10,000ì› ì…ê¸ˆ (ì‹¤íŒ¨!)

ì—¬ê¸°ì„œ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤:
- ë‚´ ëˆì€ ë¹ ì¡ŒëŠ”ë°
- ìƒëŒ€ë°©ì—ê²ŒëŠ” ì•ˆ ë“¤ì–´ê°”ìŠµë‹ˆë‹¤

íŠ¸ëœì­ì…˜ì€ ì´ëŸ° ìƒí™©ì„ ë°©ì§€í•©ë‹ˆë‹¤:
"2ë²ˆ ê³¼ì •ì´ ì‹¤íŒ¨í•˜ë©´, 1ë²ˆë„ ì·¨ì†Œí•´!"
```

### 2.5. ì—”í‹°í‹°(Entity) vs DTO

**ì—”í‹°í‹°(Entity)**: ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ 1:1ë¡œ ë§¤í•‘ë˜ëŠ” í´ë˜ìŠ¤

**DTO (Data Transfer Object)**: ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤

**ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°:**
```
ë„ì„œê´€ ì‹œìŠ¤í…œì„ ìƒìƒí•´ ë³´ì„¸ìš”.

[ì‹¤ì œ ì±… (Entity)]
- ë„ì„œê´€ì˜ ì±…ì¥ì— ê½‚íŒ ì§„ì§œ ì±…
- ISBN, ì œëª©, ì €ì ë“±ì´ ì íŒ ë„ì„œ ì¹´ë“œ
- ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ëŠ” ì‹¤ì œ ë°ì´í„°

[ì£¼ë¬¸ì„œ (DTO)]
- ì±…ì„ ì£¼ë¬¸í•  ë•Œ ì‘ì„±í•˜ëŠ” ì¢…ì´
- ì£¼ë¬¸í•  ì±…ì˜ ISBNê³¼ ìˆ˜ëŸ‰ì´ ì í˜€ ìˆìŒ
- ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” ìš©ë„ë¡œë§Œ ì‚¬ìš©

CSVì—ì„œ ì½ì€ ë°ì´í„°ëŠ” ì£¼ë¬¸ì„œ(DTO)ì™€ ê°™ê³ ,
ì´ë¥¼ ì‹¤ì œ ì±…(Entity)ìœ¼ë¡œ ë³€í™˜í•´ì„œ ì €ì¥í•©ë‹ˆë‹¤.
```

---

## 3. ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì¡°

### 3.1. ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°

```
CSV íŒŒì¼
   â†“
[CSV Parser]      â† íŒŒì¼ì„ ì½ì–´ì„œ íŒŒì‹±
   â†“ (ì´ë²¤íŠ¸ ë°œí–‰)
[Event Listener]  â† ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ ë²„í¼ì— ì €ì¥
   â†“
[Batch Service]   â† ë°°ì¹˜ ë‹¨ìœ„ë¡œ DBì— ì €ì¥
   â†“
  Database
```

### 3.2. ì´ë²¤íŠ¸ íë¦„ ë‹¤ì´ì–´ê·¸ë¨

```
[CSV íŒŒì¼]
    â”‚
    â”‚  1. íŒŒì¼ ì—´ê¸°
    â†“
[CsvBookParser]
    â”‚
    â”‚  2. í•œ ì¤„ì”© ì½ê¸°
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                             â”‚
    â†“                             â†“
[BookParsedEvent]            [ë‹¤ìŒ ì¤„ ì½ê¸°]
    â”‚                             â”‚
    â”‚  3. ì´ë²¤íŠ¸ ë°œí–‰              â”‚
    â†“                             â”‚
[BookParsingEventListener]         â”‚
    â”‚                             â”‚
    â”‚  4. ë²„í¼ì— ì €ì¥              â”‚
    â†“                             â”‚
 [ë²„í¼(List)]                      â”‚
    â”‚                             â”‚
    â”‚                        (ë°˜ë³µ)
    â†“
[íŒŒì‹± ì™„ë£Œ]
    â”‚
    â”‚  5. BookParsingCompleteEvent ë°œí–‰
    â†“
[BookBatchService]
    â”‚
    â”‚  6. ë°°ì¹˜ ë‹¨ìœ„ë¡œ DB ì €ì¥
    â†“
[Database]
```

---

## 4. êµ¬í˜„ ê°€ì´ë“œ (Step-by-Step)

### STEP 1: ì´ë²¤íŠ¸ ì •ì˜í•˜ê¸°

ë¨¼ì € ì‹œìŠ¤í…œì—ì„œ ì‚¬ìš©í•  ì´ë²¤íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

**BookParsedEvent.java** (ì±… í•œ ê¶Œ íŒŒì‹± ì™„ë£Œ)
```java
package com.nhnacademy.library.batch.init.event;

import com.nhnacademy.library.batch.init.dto.BookRawData;
import lombok.Getter;

/**
 * ë„ì„œ íŒŒì‹± ì™„ë£Œ ì´ë²¤íŠ¸
 *
 * CSV íŒŒì¼ì—ì„œ í•œ ê¶Œì˜ ë„ì„œë¥¼ íŒŒì‹±í•  ë•Œë§ˆë‹¤ ë°œí–‰ë©ë‹ˆë‹¤.
 */
@Getter
public class BookParsedEvent {

    /** íŒŒì‹±ëœ ë„ì„œ ë°ì´í„° */
    private final BookRawData bookRawData;

    public BookParsedEvent(BookRawData bookRawData) {
        this.bookRawData = bookRawData;
    }
}
```

**BookParsingCompleteEvent.java** (íŒŒì‹± ì „ì²´ ì™„ë£Œ)
```java
package com.nhnacademy.library.batch.init.event;

/**
 * ë„ì„œ íŒŒì‹± ì „ì²´ ì™„ë£Œ ì´ë²¤íŠ¸
 *
 * CSV íŒŒì¼ì˜ ëª¨ë“  ë„ì„œë¥¼ íŒŒì‹±í•˜ë©´ ë°œí–‰ë©ë‹ˆë‹¤.
 */
public class BookParsingCompleteEvent {
    // ë³„ë„ì˜ ë°ì´í„°ëŠ” í•„ìš” ì—†ìŒ
    // ì´ë²¤íŠ¸ ë°œí–‰ ìì²´ë¡œ "ì™„ë£Œ"ë¥¼ ì˜ë¯¸
}
```

---

### STEP 2: DTO ì •ì˜í•˜ê¸°

CSV ë°ì´í„°ë¥¼ ë‹´ì„ DTOë¥¼ ë§Œë“­ë‹ˆë‹¤.

**BookRawData.java** (CSV ë°ì´í„°ìš© DTO)
```java
package com.nhnacademy.library.batch.init.dto;

import lombok.Data;

/**
 * CSV íŒŒì¼ì—ì„œ ì½ì€ ì›ë³¸ ë„ì„œ ë°ì´í„°
 *
 * ì—”í‹°í‹°ê°€ ì•„ë‹Œ DTOë¡œ ì •ì˜í•˜ì—¬
 * CSV êµ¬ì¡°ì™€ DB êµ¬ì¡°ì˜ ë¶„ë¦¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
 */
@Data
public class BookRawData {

    /** ë„ì„œ ID */
    private Long id;

    /** ISBN (ê³ ìœ ë²ˆí˜¸) */
    private String isbn;

    /** ë„ì„œ ì œëª© */
    private String title;

    /** ì €ìëª… */
    private String authorName;

    /** ì¶œíŒì‚¬ëª… */
    private String publisherName;

    /** ì¶œíŒì¼ */
    private String publishDate;

    /** ë„ì„œ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸° */
    private String bookContent;

    /** í‘œì§€ ì´ë¯¸ì§€ URL */
    private String imageUrl;

    // ... ê¸°íƒ€ í•„ë“œ
}
```

---

### STEP 3: CSV íŒŒì„œ êµ¬í˜„í•˜ê¸°

Apache Commons CSV ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ CSV íŒŒì¼ì„ ì½ìŠµë‹ˆë‹¤.

**CsvBookParser.java**
```java
package com.nhnacademy.library.batch.init.parser;

import com.nhnacademy.library.batch.init.dto.BookRawData;
import com.nhnacademy.library.batch.init.event.BookParsedEvent;
import com.nhnacademy.library.batch.init.event.BookParsingCompleteEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVParser;
import org.apache.commons.csv.CSVRecord;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.core.io.ClassPathResource;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;

/**
 * CSV ë„ì„œ íŒŒì„œ
 *
 * CSV íŒŒì¼ì„ ì½ì–´ì„œ ê° ë ˆì½”ë“œë³„ë¡œ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class CsvBookParser {

    private final ApplicationEventPublisher eventPublisher;

    /**
     * CSV íŒŒì¼ì„ íŒŒì‹±í•©ë‹ˆë‹¤
     *
     * @param filePath CSV íŒŒì¼ ê²½ë¡œ
     * @throws IOException íŒŒì¼ ì½ê¸° ì‹¤íŒ¨
     */
    public void parse(String filePath) throws IOException {
        log.info("CSV íŒŒì‹± ì‹œì‘: {}", filePath);

        // ClassPathì—ì„œ íŒŒì¼ ì½ê¸°
        ClassPathResource resource = new ClassPathResource(filePath);

        try (InputStreamReader reader = new InputStreamReader(
                resource.getInputStream(), StandardCharsets.UTF_8);
             CSVParser parser = CSVFormat.DEFAULT
                     .withHeader()           // ì²« ì¤„ì€ í—¤ë”ë¡œ ì²˜ë¦¬
                     .withSkipHeaderRecord()  // í—¤ë” ê±´ë„ˆëœ€ê¸°
                     .withIgnoreEmptyLines()  // ë¹ˆ ì¤„ ë¬´ì‹œ
                     .parse(reader)) {

            int count = 0;

            // ê° ë ˆì½”ë“œ ìˆœíšŒ
            for (CSVRecord record : parser) {
                BookRawData book = mapToBookRawData(record);

                // íŒŒì‹± ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰
                eventPublisher.publishEvent(new BookParsedEvent(book));

                count++;

                // 1000ê¶Œë§ˆë‹¤ ë¡œê·¸ ì¶œë ¥
                if (count % 1000 == 0) {
                    log.info("{}ê¶Œ íŒŒì‹± ì™„ë£Œ", count);
                }
            }

            log.info("ì´ {}ê¶Œ íŒŒì‹± ì™„ë£Œ", count);

            // íŒŒì‹± ì „ì²´ ì™„ë£Œ ì´ë²¤íŠ¸ ë°œí–‰
            eventPublisher.publishEvent(new BookParsingCompleteEvent());
        }
    }

    /**
     * CSV ë ˆì½”ë“œë¥¼ BookRawDataë¡œ ë³€í™˜
     *
     * @param record CSV ë ˆì½”ë“œ
     * @return BookRawData ê°ì²´
     */
    private BookRawData mapToBookRawData(CSVRecord record) {
        BookRawData book = new BookRawData();

        try {
            book.setId(Long.valueOf(record.get("ID")));
        } catch (IllegalArgumentException e) {
            book.setId(null);  // IDê°€ ì—†ìœ¼ë©´ null ì„¤ì •
        }

        book.setIsbn(record.get("ISBN"));
        book.setTitle(record.get("TITLE_NM"));
        book.setAuthorName(record.get("AUTHOR_NM"));
        book.setPublisherName(record.get("PUBLISHER_NM"));
        // ... ê¸°íƒ€ í•„ë“œ ë§¤í•‘

        return book;
    }
}
```

---

### STEP 4: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ êµ¬í˜„í•˜ê¸°

ë°œí–‰ëœ ì´ë²¤íŠ¸ë¥¼ ë°›ì•„ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³ , ë°°ì¹˜ ì €ì¥ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.

**BookParsingEventListener.java**
```java
package com.nhnacademy.library.batch.init.listener;

import com.nhnacademy.library.batch.init.dto.BookRawData;
import com.nhnacademy.library.batch.init.event.BookParsedEvent;
import com.nhnacademy.library.batch.init.event.BookParsingCompleteEvent;
import com.nhnacademy.library.batch.init.service.BookBatchService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

/**
 * ë„ì„œ íŒŒì‹± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
 *
 * íŒŒì‹±ëœ ë„ì„œ ë°ì´í„°ë¥¼ ë²„í¼ì— ëª¨ì•˜ë‹¤ê°€
 * íŒŒì‹± ì™„ë£Œ ì‹œ ë°°ì¹˜ ì €ì¥ ì„œë¹„ìŠ¤ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 */
@Slf4j
@Component
@RequiredArgsConstructor
public class BookParsingEventListener {

    /** íŒŒì‹±ëœ ë„ì„œë¥¼ ì„ì‹œë¡œ ì €ì¥í•  ë²„í¼ */
    private final List<BookRawData> buffer = new ArrayList<>();

    private final BookBatchService batchService;

    /**
     * ë„ì„œ íŒŒì‹± ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
     *
     * @param event ë„ì„œ íŒŒì‹± ì™„ë£Œ ì´ë²¤íŠ¸
     */
    @EventListener
    public void onBookParsed(BookParsedEvent event) {
        // ë²„í¼ì— ì¶”ê°€
        buffer.add(event.bookRawData());
    }

    /**
     * íŒŒì‹± ì „ì²´ ì™„ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
     *
     * @param event íŒŒì‹± ì™„ë£Œ ì´ë²¤íŠ¸
     */
    @EventListener
    public void onParsingCompleted(BookParsingCompleteEvent event) {
        log.info("íŒŒì‹± ì™„ë£Œ, ë„ì„œ {}ê¶Œ ì €ì¥ ì‹œì‘", buffer.size());

        // ë°°ì¹˜ ì €ì¥ ì„œë¹„ìŠ¤ í˜¸ì¶œ
        batchService.initializeBooks(buffer);

        // ë²„í¼ ë¹„ìš°ê¸°
        buffer.clear();

        log.info("ë„ì„œ ì €ì¥ ì™„ë£Œ");
    }
}
```

---

### STEP 5: ë°°ì¹˜ ì €ì¥ ì„œë¹„ìŠ¤ êµ¬í˜„í•˜ê¸°

ëª¨ì•„ë‘” ë°ì´í„°ë¥¼ ë°°ì¹˜ ë‹¨ìœ„ë¡œ DBì— ì €ì¥í•©ë‹ˆë‹¤.

**BookBatchService.java**
```java
package com.nhnacademy.library.batch.init.service;

import com.nhnacademy.library.batch.init.dto.BookRawData;
import com.nhnacademy.library.core.book.domain.Book;
import com.nhnacademy.library.core.book.repository.BookRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;

/**
 * ë„ì„œ ë°°ì¹˜ ì €ì¥ ì„œë¹„ìŠ¤
 *
 * ëŒ€ëŸ‰ì˜ ë„ì„œ ë°ì´í„°ë¥¼ ë°°ì¹˜ ë‹¨ìœ„ë¡œ DBì— ì €ì¥í•©ë‹ˆë‹¤.
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class BookBatchService {

    private final BookRepository bookRepository;

    /**
     * ë„ì„œ ëª©ë¡ì„ ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì €ì¥
     *
     * @param bookRawDataList ì €ì¥í•  ë„ì„œ ëª©ë¡
     */
    @Transactional
    public void initializeBooks(List<BookRawData> bookRawDataList) {
        int batchSize = 1000;  // í•œ ë²ˆì— ì €ì¥í•  ê°œìˆ˜
        int total = bookRawDataList.size();

        log.info("ë„ì„œ {}ê¶Œì„ ë°°ì¹˜ í¬ê¸° {}ë¡œ ì €ì¥ ì‹œì‘", total, batchSize);

        // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ì €ì¥
        for (int i = 0; i < total; i += batchSize) {

            // í˜„ì¬ ë°°ì¹˜ì˜ ë ì¸ë±ìŠ¤ ê³„ì‚°
            int end = Math.min(i + batchSize, total);

            // ì„œë¸Œ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
            List<BookRawData> subList = bookRawDataList.subList(i, end);

            // DTOë¥¼ ì—”í‹°í‹°ë¡œ ë³€í™˜
            List<Book> books = convertToEntities(subList);

            // ë°°ì¹˜ ì €ì¥
            bookRepository.saveAll(books);

            log.info("{} / {} ì €ì¥ ì™„ë£Œ", end, total);
        }

        log.info("ëª¨ë“  ë„ì„œ ì €ì¥ ì™„ë£Œ");
    }

    /**
     * BookRawDataë¥¼ Book ì—”í‹°í‹°ë¡œ ë³€í™˜
     *
     * @param rawDataList BookRawData ëª©ë¡
     * @return Book ì—”í‹°í‹° ëª©ë¡
     */
    private List<Book> convertToEntities(List<BookRawData> rawDataList) {
        List<Book> books = new ArrayList<>();

        for (BookRawData rawData : rawDataList) {
            Book book = new Book(
                rawData.getIsbn(),
                rawData.getTitle(),
                rawData.getAuthorName(),
                rawData.getPublisherName(),
                // ... ê¸°íƒ€ í•„ë“œ
                rawData.getBookContent()
            );
            books.add(book);
        }

        return books;
    }
}
```

---

### STEP 6: ì‹¤í–‰ ì„¤ì •

**application.properties**
```properties
# ì´ˆê¸°í™” ì„¤ì •
init.enable=true              # ì´ˆê¸°í™” ì‹¤í–‰ ì—¬ë¶€ (1íšŒ ì‹¤í–‰ í›„ false ê¶Œì¥)
init.book_file=data/init/BOOK_DB_202112.csv  # CSV íŒŒì¼ ê²½ë¡œ
init.batch_size=1000         # ë°°ì¹˜ í¬ê¸°
```

---

## 5. í•µì‹¬ ê¸°ìˆ  ìƒì„¸ ì„¤ëª…

### 5.1. Apache Commons CSV

CSV íŒŒì¼ì„ ì‰½ê²Œ ì½ì„ ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì…ë‹ˆë‹¤.

**ì¥ì :**
- ë”°ì˜´í‘œ, ì‰¼í‘œ, ê°œí–‰ ë¬¸ì ë“±ì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬
- ë‹¤ì–‘í•œ CSV í˜•ì‹ ì§€ì›
- ê°„í¸í•œ API ì œê³µ

**pom.xml ì˜ì¡´ì„±:**
```xml
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-csv</artifactId>
    <version>1.13.0</version>
</dependency>
```

### 5.2. @EventListener

Springì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì–´ë…¸í…Œì´ì…˜ì…ë‹ˆë‹¤.

**ì‚¬ìš©ë²•:**
```java
@Component
public class MyListener {

    @EventListener
    public void handleEvent(MyEvent event) {
        // ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§
    }
}
```

**íŠ¹ì§•:**
- ë©”ì„œë“œ ì´ë¦„ì€ ììœ ë¡­ê²Œ ì§€ì •
- íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ì´ë²¤íŠ¸ íƒ€ì… ì§€ì •
- í•œ ê°œì˜ ë¦¬ìŠ¤ë„ˆê°€ ì—¬ëŸ¬ ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ

### 5.3. saveAll() vs save()

| ë©”ì„œë“œ | ì„¤ëª… | ì„±ëŠ¥ |
|--------|------|------|
| save() | ë°ì´í„° 1ê°œ ì €ì¥ | ëŠë¦¼ (Në²ˆ DB ì—°ê²°) |
| saveAll() | ë°ì´í„° ì—¬ëŸ¬ ê°œ í•œ ë²ˆì— ì €ì¥ | ë¹ ë¦„ (1ë²ˆ DB ì—°ê²°) |

**ì˜ˆì‹œ:**
```java
// ëŠë¦° ë°©ì‹
for (Book book : books) {
    repository.save(book);  // 1000ë²ˆ DB ì—°ê²°
}

// ë¹ ë¥¸ ë°©ì‹
repository.saveAll(books);  // 1ë²ˆ DB ì—°ê²°
```

---

## 6. ì‹¤ìŠµ ë¯¸ì…˜

### ë¯¸ì…˜ 1: ì§ì ‘ CSV íŒŒì¼ ë§Œë“¤ì–´ë³´ê¸°

ë‹¤ìŒ ë‚´ìš©ì„ `test.csv`ë¡œ ì €ì¥í•´ ë³´ì„¸ìš”:
```csv
ISBN,TITLE,AUTHOR
9791165930377,Javaì˜ì •ì„,ë‚¨ê¶ì„±
9791162233968,ìë°”ì½”ë”©ì˜ë²•ì¹™,ê¹€ë™í˜„
```

### ë¯¸ì…˜ 2: ë°°ì¹˜ í¬ê¸° ë³€ê²½í•´ë³´ê¸°

`batchSize`ë¥¼ 100, 500, 1000ìœ¼ë¡œ ë³€ê²½í•˜ë©° ì‹¤í–‰ ì‹œê°„ì„ ì¸¡ì •í•´ ë³´ì„¸ìš”.

### ë¯¸ì…˜ 3: ë¡œê·¸ ë ˆë²¨ ì¡°ì •

`application.properties`ì— ë‹¤ìŒì„ ì¶”ê°€í•˜ê³  ë¡œê·¸ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”:
```properties
logging.level.com.nhnacademy.library.batch=DEBUG
```

---

## 7. í•™ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë‹¤ìŒ ë‚´ìš©ì„ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”:

- [ ] ë°°ì¹˜ ì²˜ë¦¬ê°€ ë¬´ì—‡ì´ê³  ì™œ í•„ìš”í•œì§€ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤
- [ ] CSV íŒŒì¼ êµ¬ì¡°ë¥¼ ì´í•´í•œë‹¤
- [ ] ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ì˜ ì¥ì ì„ ì•ˆë‹¤
- [ ] íŠ¸ëœì­ì…˜ì˜ ê°œë…ì„ ì´í•´í•œë‹¤
- [ ] ì—”í‹°í‹°ì™€ DTOì˜ ì°¨ì´ë¥¼ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤
- [ ] Apache Commons CSVë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
- [ ] @EventListenerë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
- [ ] saveAll()ë¡œ ë°°ì¹˜ ì €ì¥ì„ í•  ìˆ˜ ìˆë‹¤

---

## 8. ë‹¤ìŒ ë‹¨ê³„

ë‹¤ìŒ ë¬¸ì„œì—ì„œëŠ” **ê¸°ë³¸ ê²€ìƒ‰ ê¸°ëŠ¥**ì„ êµ¬í˜„í•©ë‹ˆë‹¤:
- LIKE ê²€ìƒ‰ìœ¼ë¡œ ë„ì„œ ì°¾ê¸°
- QueryDSLë¡œ ë™ì  ì¿¼ë¦¬ ë§Œë“¤ê¸°
- DTOë¡œ ê²€ìƒ‰ ê²°ê³¼ ì „ë‹¬í•˜ê¸°

[ë‹¤ìŒ: 02. ê¸°ë³¸ ê²€ìƒ‰ êµ¬í˜„ â†’](02.book-search-implementation.md)

---

## â“ FAQ (ìì£¼ ë¬»ëŠ” ì§ˆë¬¸)

### Q1: ë°°ì¹˜ í¬ê¸°ëŠ” ì–´ë–»ê²Œ ì •í•˜ë‚˜ìš”?

**A:** ì¼ë°˜ì ìœ¼ë¡œ 500~2000 ì‚¬ì´ë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

- **ë„ˆë¬´ ì‘ìœ¼ë©´ (100 ì´í•˜):** DB ì—°ê²° íšŸìˆ˜ê°€ ë§ì•„ì ¸ ëŠë ¤ì§‘ë‹ˆë‹¤
- **ë„ˆë¬´ í¬ë©´ (5000 ì´ìƒ):** í•œ ë²ˆì— ì²˜ë¦¬í•˜ëŠ” ë°ì´í„°ê°€ ë§ì•„ ë©”ëª¨ë¦¬ ë¶€ì¡±ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- **ê¶Œì¥:** 1000ê°œë¶€í„° ì‹œì‘í•˜ë©° ì„±ëŠ¥ì„ ì¸¡ì •í•˜ë©° ì¡°ì •

### Q2: CSV íŒŒì¼ì´ ë§¤ìš° í° ê²½ìš°(100ë§Œ ê±´ ì´ìƒ) ì–´ë–»ê²Œ í•˜ë‚˜ìš”?

**A:** Stream ë°©ì‹ìœ¼ë¡œ í•œ ì¤„ì”© ì½ìœ¼ë©´ì„œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.

í˜„ì¬ êµ¬í˜„ì€ ëª¨ë“  ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ì˜¬ë¦¬ëŠ”ë°, ëŒ€ìš©ëŸ‰ íŒŒì¼ì€:
1. í•œ ì¤„ì”© ì½ìœ¼ë©´ì„œ ì¦‰ì‹œ ì´ë²¤íŠ¸ ë°œí–‰
2. ë°°ì¹˜ í¬ê¸°ë§Œí¼ ëª¨ì´ë©´ ë°”ë¡œ ì €ì¥
3. ë²„í¼ë¥¼ ê³„ì† ë¹„ìš°ë©´ì„œ ì§„í–‰

### Q3: ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ê°€ ê¼­ í•„ìš”í•œê°€ìš”?

**A:** ê°„ë‹¨í•œ í”„ë¡œì íŠ¸ë¼ë©´ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ê°€ ìœ ìš©í•œ ê²½ìš°:
- CSV íŒŒì‹±ê³¼ DB ì €ì¥ì„ ë¶„ë¦¬í•˜ê³  ì‹¶ì„ ë•Œ
- íŒŒì‹± ì™„ë£Œ í›„ ì¶”ê°€ ì‘ì—…(ì„ë² ë”© ìƒì„± ë“±)ì„ í•˜ê³  ì‹¶ì„ ë•Œ
- ì—¬ëŸ¬ ê³³ì—ì„œ íŒŒì‹± ê²°ê³¼ë¥¼ ë°›ì•„ì•¼ í•  ë•Œ

### Q4: `saveAll()`ì´ ì‹¤ì œë¡œëŠ” ë°°ì¹˜ INSERTê°€ ì•„ë‹Œê°€ìš”?

**A:** ë§ìŠµë‹ˆë‹¤. JPAì˜ `saveAll()`ì€ ë‚´ë¶€ì ìœ¼ë¡œ `save()`ë¥¼ ì—¬ëŸ¬ ë²ˆ í˜¸ì¶œí•©ë‹ˆë‹¤.

ì§„ì •í•œ ë°°ì¹˜ INSERTë¥¼ ìœ„í•´ì„œëŠ”:
- `JdbcTemplate`ì˜ `batchUpdate()` ì‚¬ìš©
- JDBC URLì— `rewriteBatchedStatements=true` ì¶”ê°€ (MySQL)
- Hibernateì˜ `jdbc.batch_size` ì„¤ì •

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: FileNotFoundException

**ì¦ìƒ:**
```
java.io.FileNotFoundException: class path resource [data/init/BOOK_DB_202112.csv] cannot be opened
```

**ì›ì¸:** CSV íŒŒì¼ ê²½ë¡œê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.

**í•´ê²°:**
1. `src/main/resources/data/init/` í´ë” í™•ì¸
2. íŒŒì¼ì´ ì œëŒ€ë¡œ ìˆëŠ”ì§€ í™•ì¸
3. `application.properties`ì˜ `init.book_file` ê²½ë¡œ í™•ì¸

### ë¬¸ì œ 2: OutOfMemoryError

**ì¦ìƒ:**
```
java.lang.OutOfMemoryError: Java heap space
```

**ì›ì¸:** í•œ ë²ˆì— ë„ˆë¬´ ë§ì€ ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ì— ì˜¬ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.

**í•´ê²°:**
1. ë°°ì¹˜ í¬ê¸° ì¤„ì´ê¸° (1000 â†’ 500)
2. JVM í™ ë©”ëª¨ë¦¬ ì¦ê°€: `-Xmx2g`
3. Stream ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (ëŒ€ìš©ëŸ‰ì¸ ê²½ìš°)

### ë¬¸ì œ 3: ì¸ì½”ë”© ë¬¸ì œ (í•œê¸€ ê¹¨ì§)

**ì¦ìƒ:** CSV íŒŒì¼ì˜ í•œê¸€ì´ ê¹¨ì ¸ì„œ ë‚˜ì˜µë‹ˆë‹¤.

**ì›ì¸:** íŒŒì¼ ì¸ì½”ë”©ê³¼ ì½ê¸° ì¸ì½”ë”©ì´ ë‹¤ë¦…ë‹ˆë‹¤.

**í•´ê²°:**
```java
// UTF-8ì´ ì•„ë‹Œ ê²½ìš° MS949 (EUC-KR) ì‹œë„
new InputStreamReader(resource.getInputStream(), Charset.forName("MS949"))
```

### ë¬¸ì œ 4: ì¤‘ë³µ ì €ì¥

**ì¦ìƒ:** ë°°ì¹˜ë¥¼ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•˜ë©´ ë°ì´í„°ê°€ ì¤‘ë³µ ì €ì¥ë©ë‹ˆë‹¤.

**ì›ì¸:** ê¸°ë³¸ í‚¤/ìœ ë‹ˆí¬ ì œì•½ ì¡°ê±´ì´ ì—†ìŠµë‹ˆë‹¤.

**í•´ê²°:**
1. Book ì—”í‹°í‹°ì˜ ISBN í•„ë“œì— `@Column(unique = true)` ì¶”ê°€
2. `init.enable` ì‹¤í–‰ í›„ falseë¡œ ë³€ê²½
3. ë˜ëŠ” `DELETE FROM book`ë¡œ ì´ˆê¸°í™” í›„ ì‹¤í–‰

### ë¬¸ì œ 5: ì´ë²¤íŠ¸ê°€ ë°œí–‰ë˜ì§€ ì•ŠìŒ

**ì¦ìƒ:** ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ í˜¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**ì›ì¸:**
- íŒŒì„œê°€ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì§€ ì•ŠìŒ
- ë¦¬ìŠ¤ë„ˆê°€ ë¹ˆìœ¼ë¡œ ë“±ë¡ë˜ì§€ ì•ŠìŒ

**í•´ê²°:**
1. íŒŒì„œì™€ ë¦¬ìŠ¤ë„ˆì— `@Component` í™•ì¸
2. `ApplicationEventPublisher`ê°€ ì£¼ì…ë˜ì—ˆëŠ”ì§€ í™•ì¸
3. ë¡œê·¸ ë ˆë²¨ì„ DEBUGë¡œ ë³€ê²½í•˜ì—¬ ì´ë²¤íŠ¸ ë°œí–‰ í™•ì¸

---

## ğŸ“– ì°¸ê³ ìë£Œ

### ê³µì‹ ë¬¸ì„œ
- [Apache Commons CSV User Guide](https://commons.apache.org/proper/commons-csv/user-guide.html)
- [Spring Events Documentation](https://docs.spring.io/spring-framework/reference/core/beans/context-introduction.html#context-functionality-events)

### ì¶”ê°• ì˜ìƒ
- [ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜ 10ë¶„ ì´í•´í•˜ê¸°](https://www.youtube.com/watch?v=example)
- [Spring Boot ë°°ì¹˜ ì²˜ë¦¬ ì…ë¬¸](https://www.youtube.com/watch?v=example)

### ì¶”ê°€ í•™ìŠµ
- Spring Batch ì™„ë²½ ê°€ì´ë“œ (ì±…)
- ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬ ì‹¤ì „ (ì˜¨ë¼ì¸ ê°•ì˜)
