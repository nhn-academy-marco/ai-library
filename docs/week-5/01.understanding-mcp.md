# 01. MCP 이해: AI가 시스템을 사용하는 방법

## 학습 전제조건

이 문서를 학습하기 전에 다음 내용을 알고 있으면 도움이 됩니다:
- Week 1~4의 모든 문서 내용
- RAG 시스템 구현 경험
- REST API 이해
- AI 모델과 프롬프트 기초

---

## 1. 개요

지금까지 우리는 AI에게 질문을 던지고 답변을 받는 방식을 사용했습니다. 하지만 AI가 단순히 답변만 하는 것이 아니라, **직접 시스템의 도구를 사용하여 작업을 수행**하게 만들 수 있습니다.

실제 도서관 시스템에서는 **도서관정보나루 API**를 활용하여 전국 도서관의 장서 데이터를 조회할 수 있습니다. AI가 이 API를 직접 호출하여 도서관 사용자에게 더 풍부한 정보를 제공할 수 있게 만들어 봅시다.

**이 문서에서 배울 내용:**
- MCP(Model Context Protocol)가 무엇인지
- 왜 MCP가 필요한지
- AI가 도구를 사용하는 원리
- MCP의 핵심 구성 요소
- A2A(AI to AI) 통신의 가능성

> **중요: AI의 진화**
>
> 지금까지의 AI:
> - "이 책 추천해줘" → "네, 이 책들을 추천합니다"
> - ❌ 직접 시스템 조작 불가
>
> MCP를 사용한 AI:
> - "도서관 시스템에서 새로운 책 등록해줘"
> - ✅ 도구 선택 → 도서관정보나루 API 호출 → 결과 반환
> - AI가 직접 시스템을 사용

---

## 2. 핵심 개념 이해

### 2.1. MCP (Model Context Protocol)란?

AI 모델이 외부 도구와 시스템을 사용할 수 있게 해주는 **표준 프로토콜**입니다.

**비유로 이해하기:**
```
[AI without MCP]
사람: "도서관에서 '자바의 정석' 책 찾아줘"
AI: "도서관 홈페이지에 접속해서 검색하면 됩니다..."
→ AI는 답변만 줌, 직접 안 함

[AI with MCP]
사람: "도서관에서 '자바의 정석' 책 찾아줘"
AI: "도서관정보나루 API 검색 도구를 사용하겠습니다"
→ AI가 직접 시스템을 조작
→ LibraryInfoNaruApiClient.searchBooks() 호출
→ 전국 도서관 장서 검색
→ 결과 반환
```

### 2.2. 왜 MCP가 필요한가?

**문제 1: AI는 도서관 API를 직접 호출할 수 없다**
```
사용자: "내 주변 도서관에서 '자바의 정석' 대출 가능한 곳 찾아줘"

기존 방식:
- 개발자가 도서관정보나루 API 연동 코드 작성
- 별도의 검색 페이지 구현
- 사용자가 직접 검색

MCP 방식:
- AI가 도서관정보나루 API 함수 자동 선택
- 사용자 자연어 요청만으로 API 호출
- 대출 가능 도서관 목록 자동 반환
```

**문제 2: AI의 응답만으로는 정보가 부족하다**
```
사용자: "이 책 어디서 빌릴 수 있어?"

기존 RAG:
- AI: "도서관에서 빌릴 수 있습니다..."
- 텍스트 답변만 제공

MCP + 도서관정보나루 API:
- AI: "대출 가능 여부 확인 도구를 사용하겠습니다"
- LibraryInfoNaruApiClient.getLoanAvailableBooks() 실행
- 실시간 대출 가능 도서관 목록 반환
```

**문제 3: 여러 API를 조합해야 하는 복잡한 작업**
```
시나리오: 도서 검색 → 대출 가능 여부 확인 → 도서관 위치 안내

MCP 없음:
- 각 API를 별도로 호출
- 여러 페이지 이동
- 사용자가 직접 정보 통합

MCP 있음:
- AI가 필요한 API 함수 자동 선택
- 검색 → 대출 확인 → 위치 제공 순차 실행
- 한 번의 질문으로 종합 답변
```

### 2.3. Spring AI Function Calling 작동 원리

Spring AI는 **Function Calling** 메커니즘을 통해 AI가 도구를 사용할 수 있게 합니다.

```
[사용자]                 [Spring AI]              [Function]               [도서관정보나루 API]
    │                         │                          │                          │
    │  1. 자연어 요청         │                          │                          │
    │  "자바 책 검색해줘"     │                          │                          │
    ├──────────────────────>│                          │                          │
    │                         │                          │                          │
    │                         │  2. 함수 메타데이터 확인  │                          │
    │                         │  (Function Calling)       │                          │
    │                         │  → search_books_in_library│                          │
    │                         │                          │                          │
    │                         │  3. AI가 함수 선택        │                          │
    │                         │  "도서관정보나루 검색 호출"│                          │
    │                         │                          │                          │
    │                         │  4. 함수 실행 요청       │                          │
    │                         ├─────────────────────────>│                          │
    │                         │  searchBooksByTitle("자바")                        │
    │                         │                          │                          │
    │                         │                          │  5. 도서관정보나루 API  │
    │                         │                          ├─────────────────────────>│
    │                         │                          │  GET /bookSrch?title=자바│
    │                         │                          │                          │
    │                         │                          │  6. 전국 도서관 장서 반환│
    │                         │                          │<─────────────────────────┤
    │                         │                          │  [책1, 책2, 책3...]     │
    │                         │                          │                          │
    │                         │  7. 함수 결과 반환       │                          │
    │                         │<─────────────────────────┤                          │
    │                         │                          │                          │
    │                         │  8. AI가 결과 기반 답변  │                          │
    │  9. 최종 답변           │                          │                          │
    │<──────────────────────┤                          │                          │
    │  "125개 도서관에서 자바 책을 찾았습니다..."              │                          │
```

**Spring AI Function Calling이란?**
- AI 모델이 직접 자바 메서드를 호출할 수 있는 기능
- `@Function` 어노테이션으로 함수 등록
- ChatClient에 함수를 등록하면 AI가 필요시 자동 호출
- JSON 스키마를 자동으로 생성하여 AI에게 전달

### 2.4. MCP 핵심 구성 요소

**1. Tools (도구)**
```
AI가 사용할 수 있는 기능 단위

도서관 시스템 예시:
- search_books_in_library: 도서관정보나루 도서 검색
- search_book_by_isbn: ISBN으로 도서 검색
- check_loan_availability: 대출 가능 여부 확인
- get_library_info: 도서관 정보 조회
- get_reviews: 리뷰 조회
```

**2. Resources (자원)**
```
시스템의 데이터와 상태

도서관 시스템 예시:
- book://123: 특정 도서 정보
- library://seoul: 서울 지역 도서관 목록
- loan://9788960777331: 특정 ISBN 대출 정보
```

**3. Prompts (프롬프트)**
```
재사용 가능한 프롬프트 템플릿

도서관 시스템 예시:
- book_recommendation: 도서 추천 프롬프트
- library_guide: 도서관 이용 가이드
- review_analysis: 리뷰 분석 프롬프트
```

---

## 3. MCP 도구 예시

### 3.1. 도서 검색 도구

```json
{
  "name": "search_books",
  "description": "도서관 시스템에서 도서를 검색합니다",
  "inputSchema": {
    "type": "object",
    "properties": {
      "query": {
        "type": "string",
        "description": "검색어"
      },
      "searchType": {
        "type": "string",
        "enum": ["KEYWORD", "VECTOR", "HYBRID"],
        "description": "검색 방식"
      },
      "limit": {
        "type": "integer",
        "description": "최대 결과 수",
        "default": 10
      }
    },
    "required": ["query"]
  }
}
```

**사용 예시:**
```
사용자: "초보자를 위한 자바 책 찾아줘"

AI 사고 과정:
1. 사용자 의도 파악: 도서 검색
2. 도구 선택: search_books
3. 매개변수 추출:
   - query: "초보자를 위한 자바 책"
   - searchType: "HYBRID"
   - limit: 10
4. 도구 실행
5. 결과 반환
```

### 3.2. 도서 등록 도구

```json
{
  "name": "register_book",
  "description": "새로운 도서를 시스템에 등록합니다",
  "inputSchema": {
    "type": "object",
    "properties": {
      "isbn": {
        "type": "string",
        "description": "ISBN 번호"
      },
      "title": {
        "type": "string",
        "description": "도서 제목"
      },
      "author": {
        "type": "string",
        "description": "저자명"
      },
      "publisher": {
        "type": "string",
        "description": "출판사"
      }
    },
    "required": ["isbn", "title", "author"]
  }
}
```

**사용 예시:**
```
사용자: "이 책을 등록해줘: ISBN 123456, 제목 '새로운 자바', 저자 '김개발'"

AI 사고 과정:
1. 사용자 의도 파악: 도서 등록
2. 도구 선택: register_book
3. 정보 추출:
   - isbn: "123456"
   - title: "새로운 자바"
   - author: "김개발"
4. 도구 실행
5. 등록 결과 반환
```

### 3.3. 배치 실행 도구

```json
{
  "name": "trigger_embedding_batch",
  "description": "도서 임베딩 생성 배치를 실행합니다",
  "inputSchema": {
    "type": "object",
    "properties": {
      "bookIds": {
        "type": "array",
        "items": {"type": "integer"},
        "description": "임베딩을 생성할 도서 ID 목록"
      },
      "batchSize": {
        "type": "integer",
        "description": "한 번에 처리할 도서 수",
        "default": 100
      }
    },
    "required": ["bookIds"]
  }
}
```

**사용 예시:**
```
사용자: "최근 등록된 책 1000권의 임베딩 생성해줘"

AI 사고 과정:
1. 사용자 의도 파악: 임베딩 배치 실행
2. 도구 선택: trigger_embedding_batch
3. 대상 도서 조회
4. 배치 실행
5. 진행 상황 반환
```

---

## 4. MCP 활용 시나리오

### 시나리오 1: 지능형 도서 등록

```
사용자: "ISBN 9788960777331 이 책 정보로 등록해줘"

AI 동작:
1. 외부 API 도구로 도서 정보 조회
   - Google Books API
   - 알라딘 API
2. 검색 결과 파싱
3. 등록 도구로 도서 등록
4. 임베딩 배치 도구로 벡터 생성
5. 완료 메시지 반환

결과:
- 도서 등록 완료
- 벡터 임베딩 생성 완료
- 검색 가능 상태
```

### 시나리오 2: 자동 리뷰 요약

```
사용자: "리뷰가 10개 이상 달린 책들의 요약 생성해줘"

AI 동작:
1. 조회 도구로 대상 도서 검색
2. 각 도서의 리뷰 확인
3. 요약 도구로 리뷰 요약 생성
4. 저장 도구로 요약 저장
5. 진행 상황 보고

결과:
- 25권의 도서 요약 완료
- 리뷰 요약 DB 저장
- 검색 품질 향상
```

### 시나리오 3: A2A 협업

```
사용자: "매주 새로운 도서를 자동으로 등록해줘"

AI 동작:
1. 스케줄러 AI와 협업
2. 외부 API에서 새로운 도서 조회
3. 필터링 AI로 중복 확인
4. 등록 AI로 도서 등록
5. 임베딩 AI로 벡터 생성
6. 알림 AI로 사용자에게 알림

결과:
- 자동화된 파이프라인
- AI 간 협업
- 최소한의 개입
```

---

## 5. MCP 아키텍처

### 5.1. 시스템 구성

```
┌─────────────────────────────────────────────────────────────────┐
│                         AI Library Platform                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  ┌───────────────┐    ┌───────────────┐    ┌───────────────┐   │
│  │  Web Client   │    │  MCP Client   │    │  Admin Client │   │
│  └───────┬───────┘    └───────┬───────┘    └───────┬───────┘   │
│          │                    │                    │             │
│          └────────────────────┼────────────────────┘             │
│                               │                                  │
│                    ┌───────────▼────────────┐                    │
│                    │   AI Orchestrator      │                    │
│                    │   (Spring AI + MCP)    │                    │
│                    └───────────┬────────────┘                    │
│                               │                                  │
│          ┌────────────────────┼────────────────────┐             │
│          │                    │                    │             │
│  ┌───────▼────────┐  ┌───────▼────────┐  ┌───────▼────────┐   │
│  │ Search MCP     │  │  Book MCP      │  │  Batch MCP     │   │
│  │ Server         │  │  Server        │  │  Server        │   │
│  ├────────────────┤  ├────────────────┤  ├────────────────┤   │
│  │ search_books   │  │ register_book  │  │ trigger_batch  │   │
│  │ get_book_info  │  │ update_book    │  │ check_status   │   │
│  │ get_reviews    │  │ delete_book    │  │ cancel_batch   │   │
│  └───────┬────────┘  └───────┬────────┘  └───────┬────────┘   │
│          │                    │                    │             │
│          └────────────────────┼────────────────────┘             │
│                               │                                  │
│                    ┌───────────▼────────────┐                    │
│                    │   Business Services    │                    │
│                    │   - BookService        │                    │
│                    │   - ReviewService      │                    │
│                    │   - EmbeddingService   │                    │
│                    └───────────┬────────────┘                    │
│                               │                                  │
│                    ┌───────────▼────────────┐                    │
│                    │   Data Layer           │                    │
│                    │   - PostgreSQL         │                    │
│                    │   - pgvector           │                    │
│                    └────────────────────────┘                    │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 5.2. 통신 흐름

```
[MCP Protocol Flow]

1. Tool Discovery
   Client → Server: tools/list
   Server → Client: [tools]

2. Tool Execution
   Client → Server: tools/call
   {
     "name": "search_books",
     "arguments": {"query": "자바"}
   }
   Server → Client: {
     "result": [책1, 책2, 책3]
   }

3. Resource Access
   Client → Server: resources/read
   {
     "uri": "book://123"
   }
   Server → Client: {
     "contents": {...}
   }
```

---

## 6. 실습 미션

### 미션 1: Spring AI Function 설계

```java
// TODO: 도서 상세 조회 함수 설계
// 목표: AI가 도서 상세 정보를 조회할 수 있는 함수 작성

@Component
public class BookFunctions {

    /**
     * 도서 상세 정보 조회
     * @Description 도서 ID로 상세 정보를 조회합니다
     */
    @FunctionInfo(description = "도서 상세 정보를 조회합니다")
    public BookInfo getBookInfo(long bookId) {
        // 구현해보세요
    }

    public record BookInfo(
        long id,
        String isbn,
        String title,
        String author,
        String publisher,
        String description
    ) {}
}
```

### 미션 2: 시나리오 작성

```
// TODO: Spring AI Function 활용 시나리오 작성
// 목표: AI가 Function을 사용하여 해결할 수 있는 문제 시나리오 작성

시나리오: "최근 등록된 도서 중 리뷰가 많은 도서 찾기"

1. AI가 사용할 함수:
   - get_recent_books: 최근 도서 조회
   - get_book_reviews: 도서 리뷰 조회
   - summarize_reviews: 리뷰 요약

2. 작업 흐름:
   -

3. 예상 결과:
   -
```

### 미션 3: A2A 협업 설계

```
// TODO: AI Agent 간 협업 시나리오 설계
// 목표: 여러 AI Agent가 협업하여 복잡한 작업 수행

시나리오: "신간 도서 자동 등록 및 검색 반영"

참여 Agent:
1. 등록 Agent: 외부 API 조회 및 도서 등록
2. 임베딩 Agent: 벡터 임베딩 생성
3. 검색 Agent: 검색 인덱스 업데이트 확인

협업 방법:
-
```

---

## 7. 학습 체크리스트

다음 내용을 이해했는지 확인해 보세요:

- [ ] MCP가 무엇인지 설명할 수 있다
- [ ] 왜 MCP가 필요한지 이해한다
- [ ] AI가 도구를 사용하는 원리를 안다
- [ ] MCP의 핵심 구성 요소를 안다 (Tools, Resources, Prompts)
- [ ] MCP 도구 스키마를 설계할 수 있다
- [ ] A2A (AI to AI) 통신이 무엇인지 안다
- [ ] MCP 활용 시나리오를 작성할 수 있다

---

## 8. 다음 단계

다음 문서에서는 **검색 MCP 서버 구현**을 배웁니다:
- MCP 서버 구조
- 도구 등록 방법
- Spring AI와 MCP 연동

[다음: 02. 검색 MCP 서버 구현 →](02.mcp-search-server.md)
