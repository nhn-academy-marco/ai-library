# 02. 검색 Function 구현: Spring AI Function Calling

## 학습 전제조건

이 문서를 학습하기 전에 다음 내용을 알고 있으면 도움이 됩니다:
- Week 5의 MCP 개념 이해
- Week 1~2의 검색 기능 구현 경험
- Spring Boot 기초
- Java Record 이해

---

## 1. 개요

이 문서에서는 **가장 단순한 형태의 Function**부터 시작하여 점진적으로 기능을 확장해 나가겠습니다.

**학습 로드맵:**
```
Level 1 (이 문서):   단일 Function - 내부 도서 검색
Level 2 (다음 문서): 외부 API 연동 - 도서관정보나루
Level 3 (오케스트레이션): 다중 Function 조합
```

**Level 1 학습 목표:**
- Spring AI Function Calling 기초 이해
- 단일 함수 정의 및 등록
- AI가 함수를 호출하는 원리 체험
- 내부 DB와의 연동

---

## 2. Spring AI Function Calling 기초

### 2.1. Function Calling이란?

**기존 방식:**
```java
// 개발자가 직접 로직 작성
@GetMapping("/search")
public List<Book> search(@RequestParam String query) {
    return bookService.searchBooks(query);
}
```

**Function Calling 방식:**
```java
// AI가 필요할 때 자동으로 호출
@Description("도서를 검색합니다")
public Function<SearchRequest, SearchResult> searchBooks() {
    return request -> {
        return bookService.searchBooks(request.query());
    };
}
```

### 2.2. 작동 원리

```
사용자: "자바 책 찾아줘"
   ↓
AI 분석: "책 검색이 필요하네"
   ↓
AI 판단: "searchBooks 함수를 호출해야겠다"
   ↓
함수 실행: searchBooks("자바")
   ↓
결과 반환: [책1, 책2, 책3]
   ↓
AI 응답: "3권의 자바 책을 찾았습니다..."
```

---

## 3. Level 1: 단일 Function 구현

가장 단순한 형태부터 시작하겠습니다. 내부 DB에 있는 도서를 검색하는 Function 하나만 만들어 봅시다.

### STEP 1: 의존성 확인

**pom.xml** - 이미 추가되어 있어야 합니다
```xml
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-starter-model-google-genai</artifactId>
</dependency>
```

### STEP 2: 요청/응답 DTO 정의

간단한 DTO부터 시작합니다.

**BookSearchRequest.java**
```java
package com.nhnacademy.library.ai.function.dto;

import lombok.Builder;

/**
 * 도서 검색 요청 (가장 단순한 형태)
 */
@Builder
public record BookSearchRequest(
    String query,      // 검색어
    int limit         // 최대 결과 수 (기본값 10)
) {
    public static BookSearchRequest of(String query) {
        return new BookSearchRequest(query, 10);
    }
}
```

**BookSearchResult.java**
```java
package com.nhnacademy.library.ai.function.dto;

import lombok.Builder;

import java.util.List;

/**
 * 도서 검색 결과 (가장 단순한 형태)
 */
@Builder
public record BookSearchResult(
    int count,
    List<BookItem> books
) {
    @Builder
    public record BookItem(
        long id,
        String title,
        String author,
        String publisher
    ) {}
}
```

### STEP 3: 첫 번째 Function 구현

이제 첫 번째 Function을 만들어 보겠습니다.

**BookSearchFunction.java**
```java
package com.nhnacademy.library.ai.function;

import com.nhnacademy.library.ai.function.dto.BookSearchRequest;
import com.nhnacademy.library.ai.function.dto.BookSearchResult;
import com.nhnacademy.library.core.book.dto.BookSearchResponse;
import com.nhnacademy.library.core.book.service.search.BookSearchService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Description;
import org.springframework.stereotype.Component;

import java.util.function.Function;

/**
 * Level 1: 단일 도서 검색 Function
 *
 * 가장 단순한 형태의 Function 구현
 * - 내부 DB 검색만 수행
 * - 하나의 기능만 제공
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class BookSearchFunction {

    private final BookSearchService bookSearchService;

    /**
     * 도서 검색 함수
     *
     * @Description의 중요성:
     * AI가 이 설명을 읽고 언제 이 함수를 호출할지 판단합니다.
     * 가능한 명확하게 작성하세요.
     */
    @Description("도서관 시스템에서 도서를 검색합니다. " +
            "제목, 저자명으로 검색할 수 있습니다.")
    public Function<BookSearchRequest, BookSearchResult> searchBooks() {
        return request -> {
            log.info("[Function] 도서 검색 시작: query={}", request.query());

            try {
                // 1. 내부 DB 검색 실행
                var books = bookSearchService.searchBooks(
                    com.nhnacademy.library.core.book.dto.BookSearchRequest.builder()
                        .query(request.query())
                        .searchType(com.nhnacademy.library.core.book.service.search.SearchType.HYBRID)
                        .limit(request.limit())
                        .build()
                );

                // 2. 결과 변환
                var items = books.stream()
                    .map(this::toBookItem)
                    .toList();

                log.info("[Function] 검색 완료: {}권", items.size());

                return BookSearchResult.builder()
                    .count(items.size())
                    .books(items)
                    .build();

            } catch (Exception e) {
                log.error("[Function] 검색 실패", e);
                // 실패해도 빈 결과 반환
                return BookSearchResult.builder()
                    .count(0)
                    .books(java.util.List.of())
                    .build();
            }
        };
    }

    private BookSearchResult.BookItem toBookItem(BookSearchResponse book) {
        return BookSearchResult.BookItem.builder()
            .id(book.id())
            .title(book.title())
            .author(book.authorName())
            .publisher(book.publisherName())
            .build();
    }
}
```

### STEP 4: ChatClient에 함수 등록

이제 만든 함수를 ChatClient에 등록합니다.

**AiConfig.java**
```java
package com.nhnacademy.library.core.config;

import com.nhnacademy.library.ai.function.BookSearchFunction;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * AI 설정 - Level 1
 *
 * 단일 함수만 등록하는 가장 단순한 설정
 */
@Configuration
@RequiredArgsConstructor
public class AiConfig {

    private final ChatModel chatModel;
    private final BookSearchFunction bookSearchFunction;

    @Bean
    public ChatClient chatClient() {
        return ChatClient.builder(chatModel)
            // 함수 등록: 지금은 하나만
            .defaultFunctions(bookSearchFunction.searchBooks())
            .build();
    }
}
```

### STEP 5: AI 서비스 구현

**AiBookSearchService.java**
```java
package com.nhnacademy.library.ai.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.stereotype.Service;

/**
 * AI 도서 검색 서비스 - Level 1
 */
@Service
@RequiredArgsConstructor
@Slf4j
public class AiBookSearchService {

    private final ChatClient chatClient;

    /**
     * 자연어 도서 검색
     *
     * 사용자가 자연어로 질문하면:
     * 1. AI가 함수 호출 필요 여부 판단
     * 2. 필요하면 searchBooks() 함수 호출
     * 3. 결과를 바탕으로 자연어 응답 생성
     */
    public String searchBooks(String userMessage) {
        log.info("사용자 요청: {}", userMessage);

        String response = chatClient.prompt()
            .user(userMessage)
            .call()
            .content();

        log.info("AI 응답: {}", response);
        return response;
    }
}
```

### STEP 6: 컨트롤러

**AiSearchController.java**
```java
package com.nhnacademy.library.front.web;

import com.nhnacademy.library.ai.service.AiBookSearchService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

/**
 * AI 검색 컨트롤러 - Level 1
 */
@Controller
@RequiredArgsConstructor
public class AiSearchController {

    private final AiBookSearchService aiBookSearchService;

    @GetMapping("/ai/search")
    @ResponseBody
    public String search(@RequestParam String query) {
        return aiBookSearchService.searchBooks(query);
    }
}
```

---

## 4. 실행 및 테스트

### 4.1. 실행 흐름 이해

```
┌──────────┐         ┌──────────┐         ┌──────────┐         ┌──────────┐
│ 사용자   │         │ChatClient│         │ Function  │         │  내부   │
│          │         │          │         │          │         │   DB    │
└────┬─────┘         └────┬─────┘         └────┬─────┘         └────┬─────┘
     │                   │                   │                    │
     │ "자바 책"        │                   │                    │
     ├──────────────────>│                   │                    │
     │                   │                   │                    │
     │                   │ 1. 함수 확인      │                    │
     │                   │ → searchBooks    │                    │
     │                   │                   │                    │
     │                   │ 2. AI: "필요함"   │                    │
     │                   │                   │                    │
     │                   │ 3. 함수 호출      │                    │
     │                   ├──────────────────>│                    │
     │                   │ searchBooks("자바")                    │
     │                   │                   │                    │
     │                   │                   │ 4. DB 조회        │
     │                   │                   ├───────────────────>│
     │                   │                   │                    │
     │                   │                   │ 5. 결과 반환      │
     │                   │                   │<───────────────────┤
     │                   │                   │ [책1, 책2, 책3]   │
     │                   │                   │                    │
     │                   │ 6. 함수 결과      │                    │
     │                   │<──────────────────┤                    │
     │                   │                   │                    │
     │                   │ 7. AI 응답 생성  │                    │
     │ "3권을 찾았습니다"│                   │                    │
     │<──────────────────┤                   │                    │
```

### 4.2. 테스트 해보기

**테스트 1: 기본 검색**
```
GET /ai/search?query=자바

예상 응답:
"도서관 시스템에서 자바 관련 도서 3권을 찾았습니다:
1. 자바의 정석 - 남궁성
2. 이것이 자바다 - 박매일
3. 코딩 테스트를 위한 자바 - ..."
```

**테스트 2: 함수 미사용**
```
GET /ai/search?query=안녕하세요

AI 동작:
- 검색이 필요 없다고 판단
- 함수 호출 없이 바로 응답
- "안녕하세요! 도서관 AI 도우미입니다."
```

**테스트 3: 구체적 검색**
```
GET /ai/search?query=남궁성 책

AI 동작:
- searchBooks 함수 호출
- query: "남궁성"
```

---

## 5. 디버깅: AI가 함수를 호출하는지 확인

**로그를 확인해보세요:**

```log
[Function] 도서 검색 시작: query=자바
[Function] 검색 완료: 3권
```

이 로그가 보이면 AI가 함수를 성공적으로 호출한 것입니다!

---

## 6. 현재까지 구현한 것

✅ **완료:**
- 단일 Function 정의
- ChatClient에 함수 등록
- AI가 함수 자동 호출
- 내부 DB 연동

❓ **다음 단계:**
- 외부 API 연동 (Level 2)
- 여러 함수 조합 (Level 3)

---

## 7. 실습 미션

### 미션 1: 함수 설명 개선

```java
// TODO: @Description을 더 자세하게 수정해보세요

// 현재
@Description("도서관 시스템에서 도서를 검색합니다.")

// 개선해보기
// - 어떤 파라미터가 필요한지?
// - 어떤 형식으로 검색 가능한지?
// - 검색 결과는 어떻게 반환되는지?
```

### 미션 2: 함수 파라미터 확장

```java
// TODO: BookSearchRequest에 검색 타입 추가

@Builder
public record BookSearchRequest(
    String query,
    String searchType,  // "TITLE", "AUTHOR", "PUBLISHER"
    int limit
) {}
```

### 미션 3: 에러 처리 개선

```java
// TODO: 더 나은 에러 처리 구현

// 현재: 빈 결과 반환
catch (Exception e) {
    return BookSearchResult.builder()
        .count(0)
        .books(List.of())
        .build();
}

// 개선해보기
// - 에러 메시지를 결과에 포함?
// - 재시도 로직?
// - 특정 예외만 처리?
```

---

## 8. 학습 체크리스트

다음 내용을 이해했는지 확인해 보세요:

- [ ] Function Calling이 무엇인지 이해했다
- [ ] 단일 Function을 정의할 수 있다
- [ ] ChatClient에 함수를 등록할 수 있다
- [ ] AI가 함수를 자동으로 호출하는 것을 확인했다
- [ ] 내부 DB와 연동할 수 있다
- [ ] 로그를 통해 함수 호출을 확인할 수 있다

---

## 9. 다음 단계

Level 1을 완료하셨습니다! 다음 단계에서는:

**Level 2: 도서관정보나루 API 연동**
- 외부 API 클라이언트 구현
- 두 번째 Function 추가
- 외부 데이터와 내부 데이터 결합

[다음: 03. 외부 API Function 구현 →](03.mcp-external-api.md)
