# 02. 환경 구축: PostgreSQL pgvector 설정

Week 2의 두 번째 단계로, AI 검색의 핵심인 벡터 검색(Vector Search)을 위해 PostgreSQL에 `pgvector` 확장을 설정하고, 도서 데이터를 위한 벡터 컬럼을 추가하는 과정을 학습합니다.

## 1. 개요

전통적인 텍스트 검색을 넘어 '의미'를 검색하기 위해서는 데이터를 숫자의 나열인 **벡터(Vector)** 형태로 저장해야 합니다. PostgreSQL은 `pgvector`라는 확장을 통해 벡터 데이터를 효율적으로 저장하고 검색할 수 있는 기능을 제공합니다. 이 단계에서는 데이터베이스에 벡터 기능을 활성화하고 테이블 구조를 변경하는 방법을 배웁니다.

## 2. 주요 개념

### 2.1. 벡터(Vector)란?
AI 분야에서 벡터는 문장이나 단어의 **'의미적 특징'**을 숫자로 표현한 리스트입니다.
- **예시**: `[0.12, -0.5, 0.88, ...]`
- 이 숫자들이 좌표가 되어 다차원 공간에 데이터가 배치됩니다. 의미가 비슷한 데이터끼리는 공간상에서 가깝게 위치하게 됩니다.

### 2.2. pgvector 확장
PostgreSQL에서 벡터 데이터를 다룰 수 있게 해주는 도구입니다.
- 벡터 전용 데이터 타입(`vector`)을 제공합니다.
- 벡터 간의 거리를 계산하는 연산자(L2 거리, 코사인 유사도 등)를 제공합니다.
- 대량의 벡터 검색을 빠르게 해주는 전용 인덱스(`IVFFlat`, `HNSW`)를 지원합니다.

## 3. 구현 가이드 (Step-by-Step)

### 3.1. pgvector 확장 활성화
데이터베이스 접속 후 다음 명령어를 실행하여 기능을 켭니다. (서버에는 이미 설치되어 있습니다.)
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### 3.2. 벡터 컬럼 추가
도서의 본문 내용을 벡터로 변환하여 저장할 공간(`embedding`)을 `books` 테이블에 추가합니다.
```sql
ALTER TABLE books ADD COLUMN embedding vector(1024);
```
*   **1024**: 사용할 AI 모델(예: BGE-M3)이 생성하는 숫자의 개수(차원)입니다. 모델에 따라 이 숫자는 달라질 수 있습니다.
    *   OpenAI `text-embedding-3-small`: 1536차원
    *   BGE-M3: 1024차원 (본 실습에서 사용)

> **💡 Q&A: 차원 크기를 꼭 지정해야 하나요?**
>
> 1. **차원 지정의 필요성**: `vector(1024)`와 같이 크기를 지정하면, 해당 컬럼에는 반드시 1024개의 숫자를 가진 벡터만 저장될 수 있습니다. 이는 잘못된 크기의 데이터가 들어오는 것을 데이터베이스 수준에서 방지(Type Safety)해줍니다.
> 2. **지정하지 않을 경우**: `vector`라고만 선언하면 크기에 상관없이 저장할 수 있지만, 이후 성능 최적화를 위한 **인덱스(Index)** 생성 시에 제약이 생기거나 검색 성능이 떨어질 수 있습니다.
> 3. **모델과의 일치**: 반드시 사용하는 AI 모델의 출력 차원과 일치시켜야 합니다. 모델은 1024개를 주는데 DB는 1536으로 설정되어 있으면 데이터 저장 시 오류가 발생합니다.

### 3.3. 컬럼 확인
테이블 구조가 정상적으로 변경되었는지 확인합니다. 다음 쿼리를 실행하여 `embedding` 컬럼이 추가되었는지 확인해 보세요.

```sql
SELECT column_name, data_type, udt_name
FROM information_schema.columns
WHERE table_name = 'books' AND column_name = 'embedding';
```

또는 psql 터미널을 사용하는 경우 다음 명령어로 확인할 수 있습니다.
```bash
\d books
```

## 4. 학습 포인트

*   **데이터 타입의 확장**: RDBMS가 텍스트, 숫자뿐만 아니라 AI 데이터를 위한 벡터 타입까지 수용하는 과정을 이해합니다.
*   **차원(Dimension)의 개념**: 벡터의 크기(숫자의 개수)가 왜 중요한지, 그리고 사용하려는 AI 모델과 이 크기를 어떻게 맞춰야 하는지 학습합니다.
*   **스키마 진화(Schema Evolution)**: 기존 시스템을 중단하지 않고 AI 기능을 위해 데이터 구조를 어떻게 발전시키는지 경험합니다.

## 5. 심화 학습 (Study Topics)

AI 데이터를 담는 새로운 그릇, 벡터 컬럼에 대해 쉽게 알아봅시다.

### 5.1. 숫자로 그린 지도 (Embedding Space)
우리가 지도 위에서 위도와 경도로 위치를 찾듯이, AI는 단어의 뜻을 수천 개의 숫자로 표현하여 '의미 지도' 위에 점을 찍습니다.
- **비유**: 과일 가게의 과일들을 '당도', '산도', '크기'라는 숫자로 정리해두면, 비슷한 맛을 가진 과일들을 쉽게 찾을 수 있는 것과 같습니다.

### 5.2. 차원(Dimension) - 특징의 개수
벡터 뒤의 숫자(예: 1024)는 그 데이터를 설명하는 '특징'의 개수입니다.
- **비유**: 사람을 소개할 때 '이름', '나이' 2가지만 말하는 것보다 '성격', '취미', '직업' 등 더 많은 정보를 말할수록 그 사람을 더 정확히 표현할 수 있는 것과 비슷합니다. 하지만 너무 많으면 처리하는 데 시간이 오래 걸리겠죠?

## 6. 실습 모델 소개: BGE-M3

본 과정에서는 한국어 처리에 뛰어난 성능을 보이는 **BGE-M3** 모델을 사용합니다.

*   **Multi-lingual**: 한국어를 포함한 100개 이상의 언어를 지원합니다.
*   **Multi-functionality**: Dense Retrieval 뿐만 아니라 Sparse Retrieval, Multi-vector Retrieval 등 다양한 검색 방식을 동시에 지원합니다.
*   **Multi-granularity**: 짧은 문장부터 긴 문서(최대 8192 토큰)까지 효과적으로 처리합니다.
*   **Dimension**: 1024차원의 벡터를 생성합니다.

## 7. 참고 링크

*   [BGE-M3 공식 논문 및 GitHub](https://github.com/FlagOpen/FlagEmbedding)
*   [pgvector 공식 GitHub](https://github.com/pgvector/pgvector)
*   [PostgreSQL 공식 문서 - CREATE EXTENSION](https://www.postgresql.org/docs/current/sql-createextension.html)
*   [OpenAI Embedding Models Guide](https://platform.openai.com/docs/guides/embeddings)
