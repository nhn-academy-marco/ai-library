# 02. 환경 구축: PostgreSQL pgvector 설정

## 학습 전제조건

이 문서를 학습하기 전에 다음 내용을 알고 있으면 도움이 됩니다:
- PostgreSQL 데이터베이스 기초
- SQL DDL (ALTER TABLE, CREATE EXTENSION)
- Week 2의 01 문서 내용 (벡터 검색의 필요성)

---

## 1. 개요

의미 기반 검색을 하려면 데이터베이스가 **벡터(Vector)**를 저장할 수 있어야 합니다.

**이 문서에서 배울 내용:**
- pgvector 확장이 무엇인지
- 벡터 컬럼을 추가하는 방법
- 벡터 차원(Dimension)이 무엇인지
- PostgreSQL이 어떻게 AI 데이터를 다루는지

> **중요: 왜 pgvector가 필요할까요?**
>
> 일반 PostgreSQL은 텍스트, 숫자만 저장할 수 있어요.
>
> - 텍스트: "자바 프로그래밍"
> - 숫자: 12345
>
> 벡터 검색을 하려면:
> - [0.1, 0.2, 0.3, ...] 같은 숫자 리스트도 저장해야 해요
>
> pgvector가 이것을 가능하게 해줍니다!

---

## 2. 핵심 개념 이해

### 2.1. 벡터(Vector) 데이터 타입

**벡터**는 숫자들의 리스트입니다.

**예시:**
```
텍스트: "자바는 프로그래밍 언어입니다"

벡터로 변환:
[0.12, -0.5, 0.88, 0.23, ..., 0.45]
 ↑                    총 1024개의 숫자
```

**비유로 이해하기:**
```
사람을 설명하는 방법을 생각해 보세요.

[이름으로 표현]
"철수", 20세, 서울 거주

[숫자로 표현]
[172, 68, 37, ...] ← 키, 몸무게, 체온도, ...

숫자로 표현하면:
- 비슷한 사람끼리 비교하기 쉬워요
- "철수"랑 "철수"가 같은 사람인지 확인 가능
```

### 2.2. 차원(Dimension)이란?

**차원**은 벡터에 들어있는 숫자의 개수입니다.

**예시:**
```
2차원: [0.1, 0.5]  → 평면상의 좌표
3차원: [0.1, 0.5, 0.8]  → 공간상의 좌표
1024차원: [0.1, 0.5, ..., 0.8]  → 의미 공간상의 좌표
```

**비유로 이유하기:**
```
사람을 설명할 때 얼마나 많은 정보를 말할까요?

[적은 정보]
- 이름: "철수"
- 나이: 20

[많은 정보]
- 이름, 나이, 키, 몸무게
- 성격, 취미, 직업, 혈액형
- 좋아하는 음식, 싫어하는 것
- ...

정보가 많을수록:
- 사람을 더 정확하게 표현할 수 있습니다
- 하지만 처리하는 데 시간이 더 걸립니다
```

### 2.3. pgvector 확장이란?

**pgvector**는 PostgreSQL에 벡터 기능을 추가하는 확장 프로그램입니다.

**제공하는 기능:**
- `vector` 데이터 타입: 벡터 저장
- `<=>` 연산자: 코사인 유사도 계산
- `<#>` 연산자: L2 거리 계산
- 인덱스: 빠른 벡터 검색

**비유로 이해하기:**
```
PostgreSQL은 기본적으로:
- 텍스트 저장: ✅
- 숫자 저장: ✅
- 날짜 저장: ✅
- 벡터 저장: ❌

pgvector를 설치하면:
- 벡터 저장: ✅
- 벡터 검색: ✅

마치 스마트폰에 카메라 앱을 설치하면
사진 찍고 수정하는 기능이 추가되는 것과 같아요.
```

---

## 3. 구현 가이드 (Step-by-Step)

### STEP 1: pgvector 확장 활성화

먼저 PostgreSQL에 pgvector 확장을 활성화합니다.

**SQL:**
```sql
-- pgvector 확장 활성화
CREATE EXTENSION IF NOT EXISTS vector;
```

**설명:**
- `CREATE EXTENSION`: PostgreSQL 확장 설치
- `IF NOT EXISTS`: 이미 설치되어 있으면 에러 무시
- `vector`: pgvector 확장 이름

**결과 확인:**
```sql
-- 설치된 확장 확인
SELECT * FROM pg_extension WHERE extname = 'vector';
```

### STEP 2: 벡터 컬럼 추가

도서 테이블에 임베딩을 저장할 컬럼을 추가합니다.

**SQL:**
```sql
-- books 테이블에 embedding 컬럼 추가
ALTER TABLE books
ADD COLUMN embedding vector(1024);
```

**설명:**
- `ALTER TABLE`: 테이블 구조 변경
- `ADD COLUMN`: 새 컬럼 추가
- `embedding`: 컬럼 이름
- `vector(1024)`: 데이터 타입 (1024차원 벡터)

### STEP 3: 컬럼 확인

컬럼이 제대로 추가되었는지 확인합니다.

**방법 1: 정보 스키마 조회**
```sql
SELECT column_name, data_type, udt_name
FROM information_schema.columns
WHERE table_name = 'books'
  AND column_name = 'embedding';
```

**방법 2: psql 메타명령**
```bash
\d books
```

**예상 출력:**
```
                        Table "public.books"
      Column       |            Type             | ...
-------------------+-----------------------------+-----
 id                | bigint               | ...
 isbn              | character varying     | ...
 title             | text                 | ...
 embedding         | vector(1024)         | ← 새로 추가됨
```

---

## 4. 벡터 차원 선택

### 4.1. 차원 크기 결정 요인

| 모델 | 차원 | 특징 |
|------|------|------|
| BGE-M3 | 1024 | 한국어에 특화, 본 실습 사용 |
| OpenAI text-embedding-3-small | 1536 | 영어 위주, 유료 |
| OpenAI text-embedding-ada-002 | 1536 | 영어 위주, 유료 |

**비유로 이해하기:**
```
사진을 찍을 때 해상도를 결정하듯이,
벡터도 '해상도'를 결정해야 해요.

[저해상도]
- 100차원
- 빠르지만 부족한 정보
- "자바"와 "파이썬"을 구별하지 못할 수 있어요

[중해상도]
- 1024차원 (BGE-M3)
- 적절한 속도와 정확도
- 실무에서 많이 사용

[고해상도]
- 1536차원 (OpenAI)
- 많은 정보지만 느릴 수 있습니다
- 더 정확하지만 저장 공간이 많이 필요
```

### 4.2. 차원 변경 비용

**고려 사항:**
- **저장 공간**: 차원이 클수록 더 많은 공간 필요
- **검색 속도**: 차원이 클수록 계산이 느려짐
- **정확도**: 차원이 클수록 더 정확할 수 있음

**비교:**
```
100차원:
- 저장: 100개 × 4바이트 = 400바이트
- 검색: 매우 빠름

1024차원:
- 저장: 1024개 × 4바이트 = 4KB
- 검색: 빠름

1536차원:
- 저장: 1536개 × 4바이트 = 6KB
- 검색: 조금 느림
```

---

## 5. 실습 모델: BGE-M3

본 실습에서는 **BGE-M3** 모델을 사용합니다.

### 5.1. BGE-M3 소개

**특징:**
- 한국어 포함 100개 이상의 언어 지원
- 짧은 문장부터 긴 문서까지 처리
- 1024차원 벡터 생성

**장점:**
- 무료로 사용 가능
- 한국어 검색에 뛰어난 성능
- 다양한 검색 방식 지원

### 5.2. 벡터 생성 예시

**문장:**
```
"자바는 객체 지향 프로그래밍 언어입니다"
```

**벡터 (축소 예시):**
```
[0.12, -0.5, 0.88, 0.23, ..., 0.45]
 ↑               총 1024개의 숫자
```

---

## 6. 실습 미션

### 미션 1: pgvector 설치 확인

```sql
-- pgvector가 설치되어 있는지 확인
SELECT * FROM pg_available_extensions
WHERE name = 'vector';
```

### 미션 2: 벡터 컬럼 타입 확인

```sql
-- embedding 컬럼의 타입 확인
SELECT column_name, data_type, udt_name
FROM information_schema.columns
WHERE table_name = 'books'
  AND column_name = 'embedding';
```

### 미션 3: 임의의 벡터 저장 테스트

```sql
-- 테스트용 벡터 저장 (1024차원)
UPDATE books
SET embedding = '[0.1,0.2,0.3]' || string_agg(random()::text, ',')
WHERE id = 1;
```

---

## 7. 학습 체크리스트

다음 내용을 이해했는지 확인해 보세요:

- [ ] pgvector가 무엇인지 설명할 수 있다
- [ ] 벡터 데이터 타입을 이해한다
- [ ] 차원(Dimension)의 개념을 안다
- [ ] 벡터 컬럼을 추가할 수 있다
- [ ] 차원 크기가 중요한 이유를 안다

---

## 8. 다음 단계

다음 문서에서는 **임베딩 생성**을 배웁니다:
- AI 모델을 연동하는 방법
- 대량 데이터의 임베딩 생성
- 배치 처리로 효율적으로 임베딩 생성하기

[다음: 03. 임베딩 생성 →](03.embedding-generation-batch.md)
