# 03. ì™¸ë¶€ API Function êµ¬í˜„: ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ì—°ë™ (Fallback íŒ¨í„´)

## í•™ìŠµ ì „ì œì¡°ê±´

ì´ ë¬¸ì„œë¥¼ í•™ìŠµí•˜ê¸° ì „ì— ë‹¤ìŒ ë‚´ìš©ì„ ì•Œê³  ìˆìœ¼ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤:
- **Level 1 ì™„ë£Œ**: ë‹¨ì¼ Function êµ¬í˜„ ê²½í—˜
- Spring AI Function Calling ê¸°ì´ˆ
- REST API í˜¸ì¶œ ê²½í—˜
- JSON íŒŒì‹±

---

## 1. ê°œìš”

Level 1ì—ì„œëŠ” ë‚´ë¶€ DBë§Œ ê²€ìƒ‰í–ˆìŠµë‹ˆë‹¤. ì´ì œ **"ë‚´ë¶€ DB â†’ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API" ìˆœì„œë¡œ ê²€ìƒ‰**í•˜ëŠ” Fallback íŒ¨í„´ì„ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

**í•™ìŠµ ë¡œë“œë§µ:**
```
âœ“ Level 1 (ì™„ë£Œ):   ë‹¨ì¼ Function - ë‚´ë¶€ ë„ì„œ ê²€ìƒ‰
â†’ Level 2 (ì´ ë¬¸ì„œ): Fallback íŒ¨í„´ - ë‚´ë¶€ DB â†’ ì™¸ë¶€ API
  Level 3 (ë‹¤ìŒ):    ë‹¤ì¤‘ Function ì¡°í•© & ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
```

**Level 2 í•™ìŠµ ëª©í‘œ:**
- ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
- Fallback íŒ¨í„´ êµ¬í˜„ (ë‚´ë¶€ DB â†’ ì™¸ë¶€ API)
- ë°ì´í„° ì¶œì²˜ ì¶”ì 
- ìºì‹±ìœ¼ë¡œ API í˜¸ì¶œ ìµœì í™”

> **ì¤‘ìš”: Fallback íŒ¨í„´**
>
> ```
> 1. ë¨¼ì € ë‚´ë¶€ DB ê²€ìƒ‰
> 2. ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ê²€ìƒ‰
> 3. ë‘ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ ë°˜í™˜
> ```

---

## 2. ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ì´í•´

### 2.1. API ê°œìš”

**ë„ì„œê´€ì •ë³´ë‚˜ë£¨**ëŠ” í•œêµ­ë„ì„œê´€í˜‘íšŒì—ì„œ ìš´ì˜í•˜ëŠ” ì „êµ­ ë„ì„œê´€ ì •ë³´ í†µí•© ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

**ì œê³µ ê¸°ëŠ¥:**
- ì „êµ­ ë„ì„œê´€ ì¥ì„œ ê²€ìƒ‰
- ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
- ë„ì„œê´€ ìœ„ì¹˜ ì •ë³´

> **âš ï¸ API í‚¤ ë°œê¸‰ ì•ˆë‚´**
>
> ë„ì„œê´€ì •ë³´ë‚˜ë£¨ APIë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” API í‚¤ ë°œê¸‰ì´ í•„ìš”í•©ë‹ˆë‹¤:
>
> 1. **ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ì‚¬ì´íŠ¸ ì ‘ì†**: https://www.data4library.kr/
> 2. **íšŒì›ê°€ì…**: ìƒë‹¨ ë©”ë‰´ì—ì„œ íšŒì›ê°€ì… ì§„í–‰
> 3. **API ë°œê¸‰ ì‹ ì²­**: https://www.data4library.kr/apiUtilization
>    - ë¡œê·¸ì¸ í›„ "ì´ìš©ì•ˆë‚´ > API í™œìš©" ë©”ë‰´ ì ‘ì†
>    - API í‚¤ ë°œê¸‰ ì‹ ì²­ì„œ ì‘ì„± ë° ì œì¶œ
> 4. **API í‚¤ ìˆ˜ë ¹**: ìŠ¹ì¸ í›„ ë°œê¸‰ëœ API í‚¤ë¥¼ `application.properties`ì— ì„¤ì •
>
> ```properties
> library.api.url=https://www.data4library.kr/api
> library.api.key=ë°œê¸‰ë°›ì€_API_í‚¤
> ```

### 2.2. API ê¸°ë³¸ ì •ë³´

```
ê¸°ë³¸ URL: https://www.data4library.kr/api
ì¸ì¦: API í‚¤ í•„ìš” (ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ë°œê¸‰)
```

**ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸:**

| ì—”ë“œí¬ì¸íŠ¸ | ì„¤ëª… | íŒŒë¼ë¯¸í„° |
|----------|------|---------|
| `/bookSrch` | ë„ì„œ ê²€ìƒ‰ | title, isbn, isbn13, author, publisher |
| `/loanItemSrch` | ëŒ€ì¶œ ê°€ëŠ¥ ë„ì„œ ì¡°íšŒ | isbn13, region, libraryName |

### 2.3. API ì‘ë‹µ ì˜ˆì‹œ

```json
{
  "response": {
    "numFound": 125,
    "docs": [
      {
        "book": {
          "bookname": "ìë°”ì˜ ì •ì„",
          "authors": "ë‚¨ê¶ì„± ì§€ìŒ",
          "publisher": "ë„ìš°ì¶œíŒ",
          "isbn13": "9788960777331"
        },
        "loanInfo": {
          "loanAvailable": "Y",
          "loanCount": 152
        }
      }
    ]
  }
}
```

---

## 3. Level 2: Fallback íŒ¨í„´ êµ¬í˜„

### STEP 1: ì˜ì¡´ì„± í™•ì¸

**application.properties** - API ì„¤ì • ì¶”ê°€
```properties
# ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ì„¤ì •
library.api.url=https://www.data4library.kr/api
library.api.key=${LIBRARY_API_KEY:your-api-key-here}
```

### STEP 2: ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„

**LibraryInfoNaruApiClient.java**
```java
package com.nhnacademy.library.external.client;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.util.ArrayList;
import java.util.List;

/**
 * ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API í´ë¼ì´ì–¸íŠ¸
 *
 * Level 2ì—ì„œ ì¶”ê°€:
 * - ì™¸ë¶€ API í˜¸ì¶œ ê¸°ëŠ¥
 * - ìºì‹±ìœ¼ë¡œ API ë¹„ìš© ì ˆê°
 */
@Component
@Slf4j
public class LibraryInfoNaruApiClient {

    @Value("${library.api.url}")
    private String apiUrl;

    @Value("${library.api.key}")
    private String apiKey;

    private final RestTemplate restTemplate = new RestTemplate();
    private final ObjectMapper objectMapper = new ObjectMapper();

    /**
     * ì œëª©ìœ¼ë¡œ ë„ì„œ ê²€ìƒ‰
     */
    @Cacheable(value = "librarySearch", key = "#title")
    public List<LibraryBookInfo> searchBooksByTitle(String title) {
        log.info("[ë„ì„œê´€ì •ë³´ë‚˜ë£¨] ë„ì„œ ê²€ìƒ‰: title={}", title);

        try {
            String url = String.format("%s/bookSrch?title=%s&authKey=%s&format=json",
                apiUrl, title, apiKey);

            String response = restTemplate.getForObject(url, String.class);
            return parseBookSearchResponse(response);

        } catch (Exception e) {
            log.error("[ë„ì„œê´€ì •ë³´ë‚˜ë£¨] API í˜¸ì¶œ ì‹¤íŒ¨", e);
            return List.of();
        }
    }

    // ì‘ë‹µ íŒŒì‹±
    private List<LibraryBookInfo> parseBookSearchResponse(String response) {
        List<LibraryBookInfo> books = new ArrayList<>();
        try {
            JsonNode root = objectMapper.readTree(response);
            JsonNode docs = root.path("response").path("docs");

            for (JsonNode doc : docs) {
                JsonNode book = doc.path("book");
                JsonNode loanInfo = doc.path("loanInfo");

                books.add(LibraryBookInfo.builder()
                    .title(book.path("bookname").asText())
                    .authors(book.path("authors").asText())
                    .publisher(book.path("publisher").asText())
                    .isbn13(book.path("isbn13").asText())
                    .loanAvailable("Y".equals(loanInfo.path("loanAvailable").asText()))
                    .loanCount(loanInfo.path("loanCount").asInt())
                    .build());
            }
        } catch (Exception e) {
            log.error("ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨", e);
        }
        return books;
    }
}
```

**LibraryBookInfo.java** - DTO
```java
package com.nhnacademy.library.external.client;

import lombok.Builder;

@Builder
public record LibraryBookInfo(
    String title,
    String authors,
    String publisher,
    String isbn13,
    boolean loanAvailable,
    int loanCount
) {}
```

### STEP 3: Fallback Function êµ¬í˜„

ì´ì œ í•µì‹¬ì¸ Fallback íŒ¨í„´ì„ êµ¬í˜„í•©ë‹ˆë‹¤. Level 1ì˜ `BookSearchFunction`ì„ í™•ì¥í•©ë‹ˆë‹¤.

**BookSearchFunction.java** - Level 2ë¡œ ì—…ê·¸ë ˆì´ë“œ
```java
package com.nhnacademy.library.ai.function;

import com.nhnacademy.library.ai.function.dto.BookSearchRequest;
import com.nhnacademy.library.ai.function.dto.BookSearchResult;
import com.nhnacademy.library.core.book.dto.BookSearchResponse;
import com.nhnacademy.library.core.book.service.search.BookSearchService;
import com.nhnacademy.library.external.client.LibraryBookInfo;
import com.nhnacademy.library.external.client.LibraryInfoNaruApiClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.annotation.Description;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.function.Function;
import java.util.stream.Collectors;

/**
 * Level 2: Fallback íŒ¨í„´ ê²€ìƒ‰ Function
 *
 * ë‚´ë¶€ DB â†’ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ìˆœì„œë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.
 * Level 1ì˜ ë‹¨ì¼ ê²€ìƒ‰ ê¸°ëŠ¥ì„ í™•ì¥í•©ë‹ˆë‹¤.
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class BookSearchFunction {

    private final BookSearchService bookSearchService;
    private final LibraryInfoNaruApiClient libraryApiClient;

    /**
     * ë„ì„œ ê²€ìƒ‰ í•¨ìˆ˜ (Fallback íŒ¨í„´)
     *
     * 1. ë¨¼ì € ë‚´ë¶€ DB ê²€ìƒ‰
     * 2. ê²°ê³¼ê°€ ì—†ê±°ë‚˜ ë¶€ì¡±í•˜ë©´ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ê²€ìƒ‰
     * 3. ë‘ ê²°ê³¼ë¥¼ í†µí•©í•˜ì—¬ ë°˜í™˜
     */
    @Description("ë„ì„œê´€ ì‹œìŠ¤í…œì—ì„œ ë„ì„œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. " +
            "ë¨¼ì € ë‚´ë¶€ DBë¥¼ ê²€ìƒ‰í•˜ê³ , ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ APIì—ì„œ " +
            "ì „êµ­ ë„ì„œê´€ì˜ ì¥ì„œë¥¼ ê²€ìƒ‰í•˜ì—¬ ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.")
    public Function<BookSearchRequest, BookSearchResult> searchBooks() {
        return request -> {
            log.info("[Function] ë„ì„œ ê²€ìƒ‰ ì‹œì‘: query={}", request.query());

            try {
                // 1ë‹¨ê³„: ë‚´ë¶€ DB ê²€ìƒ‰
                List<BookSearchResult.BookItem> internalBooks = searchInternalDB(
                    request.query(),
                    request.limit()
                );

                log.info("[Function] ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼: {}ê¶Œ", internalBooks.size());

                // 2ë‹¨ê³„: ë‚´ë¶€ DBì— ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ê²€ìƒ‰
                List<BookSearchResult.BookItem> libraryBooks = List.of();
                if (internalBooks.isEmpty()) {
                    log.info("[Function] ë‚´ë¶€ DBì— ê²°ê³¼ ì—†ìŒ, ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ ì‹œì‘");
                    libraryBooks = searchLibraryAPI(request.query(), request.limit());
                    log.info("[Function] ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ ê²°ê³¼: {}ê¶Œ", libraryBooks.size());
                }

                // 3ë‹¨ê³„: ê²°ê³¼ í†µí•©
                List<BookSearchResult.BookItem> allBooks = new ArrayList<>();
                allBooks.addAll(internalBooks);
                allBooks.addAll(libraryBooks);

                // 4ë‹¨ê³„: ì¤‘ë³µ ì œê±° (ISBN ê¸°ì¤€)
                List<BookSearchResult.BookItem> uniqueBooks = deduplicateByIsbn(allBooks);

                // 5ë‹¨ê³„: ê²°ê³¼ ì œí•œ
                List<BookSearchResult.BookItem> finalBooks = uniqueBooks.stream()
                    .limit(request.limit())
                    .toList();

                log.info("[Function] ìµœì¢… ê²°ê³¼: {}ê¶Œ (ë‚´ë¶€ DB: {}ê¶Œ, ë„ì„œê´€ì •ë³´ë‚˜ë£¨: {}ê¶Œ)",
                    finalBooks.size(),
                    internalBooks.size(),
                    libraryBooks.size());

                return BookSearchResult.builder()
                    .count(finalBooks.size())
                    .books(finalBooks)
                    .source(buildSourceDescription(internalBooks, libraryBooks))
                    .build();

            } catch (Exception e) {
                log.error("[Function] ê²€ìƒ‰ ì‹¤íŒ¨", e);
                return BookSearchResult.builder()
                    .count(0)
                    .books(List.of())
                    .source("ê²€ìƒ‰ ì‹¤íŒ¨")
                    .build();
            }
        };
    }

    /**
     * ë‚´ë¶€ DB ê²€ìƒ‰
     */
    private List<BookSearchResult.BookItem> searchInternalDB(String query, int limit) {
        try {
            var books = bookSearchService.searchBooks(
                com.nhnacademy.library.core.book.dto.BookSearchRequest.builder()
                    .query(query)
                    .searchType(com.nhnacademy.library.core.book.service.search.SearchType.HYBRID)
                    .limit(limit)
                    .build()
            );

            return books.stream()
                .map(this::toBookItemFromInternal)
                .toList();

        } catch (Exception e) {
            log.error("[Function] ë‚´ë¶€ DB ê²€ìƒ‰ ì‹¤íŒ¨", e);
            return List.of();
        }
    }

    /**
     * ë„ì„œê´€ì •ë³´ë‚˜ë£¨ API ê²€ìƒ‰
     */
    private List<BookSearchResult.BookItem> searchLibraryAPI(String query, int limit) {
        try {
            List<LibraryBookInfo> libraryBooks = libraryApiClient.searchBooksByTitle(query);

            return libraryBooks.stream()
                .limit(limit)
                .map(this::toBookItemFromLibrary)
                .toList();

        } catch (Exception e) {
            log.error("[Function] ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ ì‹¤íŒ¨", e);
            return List.of();
        }
    }

    /**
     * ë‚´ë¶€ DB ê²°ê³¼ ë³€í™˜
     */
    private BookSearchResult.BookItem toBookItemFromInternal(BookSearchResponse book) {
        return BookSearchResult.BookItem.builder()
            .id(book.id())
            .title(book.title())
            .author(book.authorName())
            .publisher(book.publisherName())
            .source("ë‚´ë¶€ DB")
            .isbn(book.isbn())
            .loanAvailable(null)  // ë‚´ë¶€ DBëŠ” ëŒ€ì¶œ ì •ë³´ ì—†ìŒ
            .build();
    }

    /**
     * ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²°ê³¼ ë³€í™˜
     */
    private BookSearchResult.BookItem toBookItemFromLibrary(LibraryBookInfo info) {
        return BookSearchResult.BookItem.builder()
            .title(info.title())
            .author(info.authors())
            .publisher(info.publisher())
            .isbn(info.isbn13())
            .source("ë„ì„œê´€ì •ë³´ë‚˜ë£¨")
            .loanAvailable(info.loanAvailable())
            .build();
    }

    /**
     * ISBN ê¸°ë°˜ ì¤‘ë³µ ì œê±°
     * ë‚´ë¶€ DB ë°ì´í„°ë¥¼ ìš°ì„ í•©ë‹ˆë‹¤
     */
    private List<BookSearchResult.BookItem> deduplicateByIsbn(List<BookSearchResult.BookItem> books) {
        return books.stream()
            .collect(Collectors.toMap(
                book -> book.isbn() != null ? book.isbn() : book.title(), // í‚¤: ISBN ë˜ëŠ” ì œëª©
                book -> book, // ê°’: BookItem
                (existing, replacement) -> {
                    // ë‚´ë¶€ DB ìš°ì„  (source í•„ë“œë¡œ íŒë‹¨)
                    return "ë‚´ë¶€ DB".equals(existing.source()) ? existing : replacement;
                }
            ))
            .values()
            .stream()
            .toList();
    }

    /**
     * ë°ì´í„° ì¶œì²˜ ì„¤ëª… ìƒì„±
     */
    private String buildSourceDescription(List<BookSearchResult.BookItem> internalBooks,
                                          List<BookSearchResult.BookItem> libraryBooks) {
        List<String> sources = new ArrayList<>();
        if (!internalBooks.isEmpty()) {
            sources.add("ë‚´ë¶€ DB");
        }
        if (!libraryBooks.isEmpty()) {
            sources.add("ë„ì„œê´€ì •ë³´ë‚˜ë£¨");
        }
        return String.join(" + ", sources);
    }
}
```

### STEP 4: DTO ì—…ë°ì´íŠ¸

**BookSearchResult.java** - source í•„ë“œ ì¶”ê°€
```java
package com.nhnacademy.library.ai.function.dto;

import lombok.Builder;

import java.util.List;

/**
 * ë„ì„œ ê²€ìƒ‰ ê²°ê³¼ (Level 2 ì—…ë°ì´íŠ¸)
 */
@Builder
public record BookSearchResult(
    int count,
    String source,      // ë°ì´í„° ì¶œì²˜ (Level 2æ–°å¢)
    List<BookItem> books
) {
    @Builder
    public record BookItem(
        Long id,              // ë‚´ë¶€ DB ID (ë„ì„œê´€ì •ë³´ë‚˜ë£¨ëŠ” null)
        String title,
        String author,
        String publisher,
        String isbn,
        String source,        // ë°ì´í„° ì¶œì²˜ (Level 2æ–°å¢: "ë‚´ë¶€ DB" or "ë„ì„œê´€ì •ë³´ë‚˜ë£¨")
        Boolean loanAvailable // ëŒ€ì¶œ ê°€ëŠ¥ ì—¬ë¶€ (ë„ì„œê´€ì •ë³´ë‚˜ë£¨ë§Œ ì œê³µ, ë‚´ë¶€ DBëŠ” null)
    ) {}
}
```

### STEP 5: ChatClient ì„¤ì • í™•ì¸

**AiConfig.java** - ì—¬ì „íˆ í•˜ë‚˜ì˜ í•¨ìˆ˜ë§Œ ë“±ë¡
```java
package com.nhnacademy.library.core.config;

import com.nhnacademy.library.ai.function.BookSearchFunction;
import lombok.RequiredArgsConstructor;
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.model.ChatModel;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * AI ì„¤ì • - Level 2
 *
 * Fallback íŒ¨í„´ì´ ì ìš©ëœ í•˜ë‚˜ì˜ í•¨ìˆ˜ë§Œ ë“±ë¡í•©ë‹ˆë‹¤.
 * í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ë‚´ë¶€ DBì™€ ì™¸ë¶€ APIë¥¼ ëª¨ë‘ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
@Configuration
@RequiredArgsConstructor
public class AiConfig {

    private final ChatModel chatModel;
    private final BookSearchFunction bookSearchFunction;

    @Bean
    public ChatClient chatClient() {
        return ChatClient.builder(chatModel)
            // Fallback íŒ¨í„´ì´ ì ìš©ëœ ê²€ìƒ‰ í•¨ìˆ˜
            .defaultFunctions(bookSearchFunction.searchBooks())
            .build();
    }
}
```

---

## 4. ì‹¤í–‰ ë° í…ŒìŠ¤íŠ¸

### 4.1. Fallback íë¦„

```
ì‚¬ìš©ì: "ìë°” ì±… ì°¾ì•„ì¤˜"
   â†“
[1ë‹¨ê³„] ë‚´ë¶€ DB ê²€ìƒ‰
   â†“
   ê²°ê³¼: 0ê¶Œ (ì—†ìŒ)
   â†“
[2ë‹¨ê³„] ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ (Fallback)
   â†“
   ê²°ê³¼: 125ê¶Œ
   â†“
[3ë‹¨ê³„] í†µí•© ë°˜í™˜: 125ê¶Œ (ì¶œì²˜: ë„ì„œê´€ì •ë³´ë‚˜ë£¨)
```

### 4.2. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

**í…ŒìŠ¤íŠ¸ 1: ë‚´ë¶€ DBì— ìˆëŠ” ë„ì„œ**
```
GET /ai/search?query=ë“±ë¡ëœ ë„ì„œëª…

AI ë™ì‘:
1. searchInternalDB() â†’ 5ê¶Œ ë°œê²¬
2. ë‚´ë¶€ DB ê²°ê³¼ë§Œ ë°˜í™˜ (API í˜¸ì¶œ ì—†ìŒ)
3. source: "ë‚´ë¶€ DB"

ì‘ë‹µ: "5ê¶Œì„ ì°¾ì•˜ìŠµë‹ˆë‹¤ (ë‚´ë¶€ DB)"
```

**í…ŒìŠ¤íŠ¸ 2: ë‚´ë¶€ DBì— ì—†ëŠ” ë„ì„œ**
```
GET /ai/search?query=ìƒˆë¡œìš´ ì±…

AI ë™ì‘:
1. searchInternalDB() â†’ 0ê¶Œ
2. searchLibraryAPI() â†’ 50ê¶Œ (Fallback)
3. ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²°ê³¼ ë°˜í™˜
4. source: "ë„ì„œê´€ì •ë³´ë‚˜ë£¨"

ì‘ë‹µ: "50ê¶Œì„ ì°¾ì•˜ìŠµë‹ˆë‹¤ (ë„ì„œê´€ì •ë³´ë‚˜ë£¨)"
```

**í…ŒìŠ¤íŠ¸ 3: ë‘ ê³³ ëª¨ë‘ì— ìˆëŠ” ë„ì„œ**
```
GET /ai/search?query=ì¸ê¸° ì±…

AI ë™ì‘:
1. searchInternalDB() â†’ 3ê¶Œ
2. ë‚´ë¶€ DBì— ìˆìœ¼ë¯€ë¡œ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ ìƒëµ
3. ë‚´ë¶€ DB ê²°ê³¼ë§Œ ë°˜í™˜

ì‘ë‹µ: "3ê¶Œì„ ì°¾ì•˜ìŠµë‹ˆë‹¤ (ë‚´ë¶€ DB)"
```

---

## 5. Level 1ê³¼ Level 2 ë¹„êµ

| í•­ëª© | Level 1 | Level 2 (Fallback) |
|-----|---------|-------------------|
| ê²€ìƒ‰ ìˆœì„œ | ë‚´ë¶€ DBë§Œ | ë‚´ë¶€ DB â†’ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ |
| í•¨ìˆ˜ ê°œìˆ˜ | 1ê°œ | 1ê°œ (ê¸°ëŠ¥ í™•ì¥) |
| ë°ì´í„° ì¶œì²˜ ì¶”ì  | âŒ | âœ… |
| ì¤‘ë³µ ì œê±° | âŒ | âœ… |
| ê²€ìƒ‰ ë²”ìœ„ | ë„ì„œê´€ ì†Œì¥ ì¥ì„œ | ì „êµ­ ë„ì„œê´€ ì¥ì„œ |
| API í˜¸ì¶œ | ì—†ìŒ | ë‚´ë¶€ DBì— ì—†ì„ ë•Œë§Œ |

---

## 6. ì‹¤ìŠµ ë¯¸ì…˜: â­â­ Fallback íŒ¨í„´ êµ¬í˜„

**ë‚œì´ë„**: ì´ˆê¸‰ | **ì˜ˆìƒ ì‹œê°„**: 1ì‹œê°„

ì´ ì„¹ì…˜ì—ì„œ ë°°ìš´ Fallback íŒ¨í„´ì„ ì‹¤ìŠµí•´ ë³´ì„¸ìš”.

> **ğŸ“˜ ì „ì²´ ë¯¸ì…˜ ê°€ì´ë“œ**: 5ë‹¨ê³„ ë‚œì´ë„ë³„ ë¯¸ì…˜ì´ ì¤€ë¹„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
>
> **ìƒì„¸ ë¯¸ì…˜**: [05.mission-scenarios.md](./05.mission-scenarios.md#-ë¯¸ì…˜-2-ë³µìˆ˜-function-ì¡°í•©---ë„ì„œ--ë¦¬ë·°)

### ë¯¸ì…˜ ê°œìš”

```
ì‚¬ìš©ì: "ìë°” ì±… 5ê¶Œ ì¶”ì²œí•´ì¤˜, ë¦¬ë·°ë„ ì•Œë ¤ì¤˜"

AI ë™ì‘:
1. search_books Function í˜¸ì¶œ (Level 2: ë‚´ë¶€ DB â†’ ë„ì„œê´€ì •ë³´ë‚˜ë£¨)
2. get_reviews Function í˜¸ì¶œ
3. ë‘ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì¢…í•©í•˜ì—¬ ì „ë‹¬
```

### ì‹¤ìŠµ ê³¼ì •

#### STEP 1: Fallback ì¡°ê±´ ìµœì í™”

í˜„ì¬ Fallback ì¡°ê±´ì„ ê°œì„ í•´ ë³´ì„¸ìš”.

```java
// í˜„ì¬: ë‚´ë¶€ DB ê²°ê³¼ê°€ ì™„ì „íˆ ì—†ì„ ë•Œë§Œ API í˜¸ì¶œ
if (internalBooks.isEmpty()) {
    libraryBooks = searchLibraryAPI(...);
}

// ê°œì„ í•´ë³´ê¸°
// 1. ë‚´ë¶€ DB ê²°ê³¼ê°€ limit ë¯¸ë§Œì´ë©´ API í˜¸ì¶œ?
if (internalBooks.size() < request.limit() / 2) {
    libraryBooks = searchLibraryAPI(...);
}

// 2. íŠ¹ì • í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ë¬´ì¡°ê±´ API í˜¸ì¶œ?
if (request.query().contains("ì „êµ­") || request.query().contains("ë‚˜ë£¨")) {
    libraryBooks = searchLibraryAPI(...);
}

// 3. ì‚¬ìš©ì ëª…ì‹œì— ë”°ë¼ API í˜¸ì¶œ?
```

#### STEP 2: ë°ì´í„° ì¶œì²˜ ëª…í™•í™”

AIê°€ ë°ì´í„° ì¶œì²˜ë¥¼ ì‚¬ìš©ìì—ê²Œ ëª…í™•íˆ ì „ë‹¬í•˜ë„ë¡ ê°œì„ í•´ ë³´ì„¸ìš”.

```java
// BookSearchResultì— source ì •ë³´ ì¶”ê°€
@Builder
public record BookSearchResult(
    int count,
    String source,      // "ë‚´ë¶€ DB", "ë„ì„œê´€ì •ë³´ë‚˜ë£¨", "ë‚´ë¶€ DB + ë„ì„œê´€ì •ë³´ë‚˜ë£¨"
    List<BookItem> books
) {}
```

#### STEP 3: ë¡œê·¸ë¥¼ í†µí•œ Fallback ë™ì‘ í™•ì¸

```bash
# í…ŒìŠ¤íŠ¸ í›„ ë¡œê·¸ í™•ì¸
grep "Function" logs/application.log

# ì˜ˆìƒ ë¡œê·¸:
# [Function] ë„ì„œ ê²€ìƒ‰ ì‹œì‘: query=ìë°”
# [Function] ë‚´ë¶€ DB ê²€ìƒ‰ ê²°ê³¼: 0ê¶Œ
# [Function] ë‚´ë¶€ DBì— ê²°ê³¼ ì—†ìŒ, ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ ì‹œì‘
# [Function] ë„ì„œê´€ì •ë³´ë‚˜ë£¨ ê²€ìƒ‰ ê²°ê³¼: 50ê¶Œ
# [Function] ìµœì¢… ê²°ê³¼: 50ê¶Œ (ë‚´ë¶€ DB: 0ê¶Œ, ë„ì„œê´€ì •ë³´ë‚˜ë£¨: 50ê¶Œ)
```

---

## 7. í•™ìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

ë‹¤ìŒ ë‚´ìš©ì„ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”:

- [ ] ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤
- [ ] Fallback íŒ¨í„´ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤
- [ ] ë‚´ë¶€ DBì™€ ì™¸ë¶€ APIì˜ ê²€ìƒ‰ ê²°ê³¼ë¥¼ í†µí•©í•  ìˆ˜ ìˆë‹¤
- [ ] ë°ì´í„° ì¶œì²˜ë¥¼ ì¶”ì í•  ìˆ˜ ìˆë‹¤
- [ ] ì¤‘ë³µ ì œê±° ë¡œì§ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤
- [ ] ìºì‹±ìœ¼ë¡œ API ë¹„ìš©ì„ ì ˆê°í•  ìˆ˜ ìˆë‹¤

---

## 8. ì‹¤ìŠµ ì•ˆë‚´

**â­â­ ë¯¸ì…˜ 2 ì‹¤ìŠµ**

ì´ ì„¹ì…˜ì—ì„œ í•™ìŠµí•œ Fallback íŒ¨í„´ì„ ì§ì ‘ ì‹¤ìŠµí•´ ë³´ì„¸ìš”.

ìƒì„¸ ê°€ì´ë“œ: **[05.mission-scenarios.md â†’ â­â­ ë¯¸ì…˜ 2](./05.mission-scenarios.md#-ë¯¸ì…˜-2-ë³µìˆ˜-function-ì¡°í•©---ë„ì„œ--ë¦¬ë·°)**

**ì‹¤ìŠµ ê³¼ì œ:**
- [ ] ë‚´ë¶€ DB â†’ ë„ì„œê´€ì •ë³´ë‚˜ë£¨ Fallback êµ¬í˜„
- [ ] ë°ì´í„° ì¶œì²˜(source) í•„ë“œ ì¶”ê°€
- [ ] ì¤‘ë³µ ì œê±° ë¡œì§ êµ¬í˜„
- [ ] ìºì‹± ë™ì‘ í™•ì¸

---

## 9. í˜„ì¬ê¹Œì§€ êµ¬í˜„í•œ ê²ƒ

âœ… **ì™„ë£Œ:**
- ë‹¨ì¼ Function êµ¬í˜„ (Level 1)
- ì™¸ë¶€ API í´ë¼ì´ì–¸íŠ¸
- Fallback íŒ¨í„´ (Level 2)
- ë°ì´í„° ì¶œì²˜ ì¶”ì 
- ì¤‘ë³µ ì œê±°
- ìºì‹± ì ìš©

**ê´€ë ¨ ë¯¸ì…˜:**
- [â­ ë¯¸ì…˜ 1: ë‹¨ì¼ Function í˜¸ì¶œ](./05.mission-scenarios.md#-ë¯¸ì…˜-1-ë‹¨ì¼-function-è°ƒç”¨---ë„ì„œ-ê²€ìƒ‰)
- [â­â­ ë¯¸ì…˜ 2: ë³µìˆ˜ Function ì¡°í•©](./05.mission-scenarios.md#-ë¯¸ì…˜-2-ë³µìˆ˜-function-ì¡°í•©---ë„ì„œ--ë¦¬ë·°)

---

## 10. ë‹¤ìŒ ë‹¨ê³„

Level 2ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤! ë‹¤ìŒ ë‹¨ê³„ì—ì„œëŠ”:

**Level 3: ë‹¤ì¤‘ Function ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜** â†’ [04. AI ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜](04.ai-orchestration.md)

- ë¦¬ë·° ì¡°íšŒ í•¨ìˆ˜ ì¶”ê°€
- ì—¬ëŸ¬ í•¨ìˆ˜ ì—°ì† í˜¸ì¶œ
- í•¨ìˆ˜ ê°„ ë°ì´í„° ì „ë‹¬
- ë³µì¡í•œ ì‚¬ìš©ì ìš”ì²­ ì²˜ë¦¬

**ë‹¤ìŒ ì‹¤ìŠµ:**
- [â­â­â­ ë¯¸ì…˜ 3: ì¡°ê±´ë¶€ Function í˜¸ì¶œ](./05.mission-scenarios.md#-ë¯¸ì…˜-3-ì¡°ê±´ë¶€-function-í˜¸ì¶œ---ëŒ€ì¶œ-ê°€ëŠ¥-í™•ì¸) (2ì‹œê°„)

[ë‹¤ìŒ: 04. AI ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ â†’](04.ai-orchestration.md)
