# 06. κ°μΈν™” μ¶”μ² μ‹μ¤ν… μ„¤κ³„ κ³„ν

## ν•™μµ μ „μ μ΅°κ±΄

μ΄ λ¬Έμ„λ¥Ό ν•™μµν•κΈ° μ „μ— λ‹¤μ λ‚΄μ©μ„ μ•κ³  μμΌλ©΄ λ„μ›€μ΄ λ©λ‹λ‹¤:
- Step 2μ 05 λ¬Έμ„ (ν•μ΄λΈλ¦¬λ“ κ²€μƒ‰, RRF μ•κ³ λ¦¬μ¦)
- Step 3μ 03 λ¬Έμ„ (LLM νΈμ¶, Chat Completion)
- Step 4μ 03 λ¬Έμ„ (μ‹λ§¨ν‹± μΊμ‹±)
- Step 5μ 03-05 λ¬Έμ„ (ν”Όλ“λ°± μμ§‘ μ‹μ¤ν…)

---

## 1. κ°μ”

### 1.1. λ©ν‘

μ‚¬μ©μλ³„λ΅ λ„μ„ μ¶”μ²μ„ κ°μΈν™”ν•μ—¬ κ²€μƒ‰ λ§μ΅±λ„λ¥Ό λ†’μ…λ‹λ‹¤.

### 1.2. ν•µμ‹¬ μ μ•½μ‚¬ν•­

**β οΈ μ¤‘μ”: λ΅κ·ΈμΈ μ‹μ¤ν… μ—†μ**
- μ‚¬μ©μλ” λ΅κ·ΈμΈν•μ§€ μ•κ³  κ²€μƒ‰λ§ μν–‰
- μ‹λ³„μλ” Telegram `chatId`λΏ
- ν”Όλ“λ°±μ€ Telegram Botμ„ ν†µν•΄μ„λ§ μμ§‘
- **κ°μΈν™”λ” μµλ… μ‚¬μ©μλ΅μ„λ§ κ°€λ¥**

**μ μ•½μ‚¬ν•­μ μλ―Έ:**
```
[μΌλ°μ μΈ κ°μΈν™”]
μ‚¬μ©μ ID β†’ μ΄λ¦„, μ΄λ©”μΌ, λ‚μ΄, μ„±λ³„, κ΄€μ‹¬μ‚¬... β†’ κ°μΈν™”

[ν„μ¬ μ‹μ¤ν…]
chatId β†’ κ²€μƒ‰ κΈ°λ΅ + ν”Όλ“λ°± κΈ°λ΅λ§ μ΅΄μ¬ β†’ μ ν•μ  κ°μΈν™”
```

---

## 2. κ°μΈν™” μ ‘κ·Ό λ°©μ‹

### 2.1. κ°€λ¥ν• κ°μΈν™” λ°©μ‹

| λ°©μ‹ | μ„¤λ… | κµ¬ν„ λ‚μ΄λ„ | ν¨κ³Ό |
|------|------|-----------|------|
| **μ„Έμ… κΈ°λ° κ°μΈν™”** | chatIdλ΅ μµκ·Ό ν”Όλ“λ°± κΈ°λ° μ¶”μ² | β­ μ‰¬μ›€ | β­β­β­ μ¤‘κ°„ |
| **λ„μ„ κΈ°λ° μ „μ²΄ μΈκΈ°λ„** | μ „μ²΄ μ‚¬μ©μ ν”Όλ“λ°± λ°μ | β­ μ‰¬μ›€ | β­β­ λ‚®μ |
| **ν•μ΄λΈλ¦¬λ“** | μ„Έμ… + μ „μ²΄ μΈκΈ°λ„ μ΅°ν•© | β­β­ μ¤‘κ°„ | β­β­β­ λ†’μ |
| **λ²΅ν„° ν‰κ· ν™”** | μ‚¬μ©μκ°€ μΆ‹μ•„ν• λ„μ„λ“¤μ μ„λ² λ”© ν‰κ·  | β­β­β­ μ–΄λ ¤μ›€ | β­β­β­β­ λ§¤μ° λ†’μ |

### 2.2. μ¶”μ² μ ‘κ·Ό λ°©μ‹: **ν•μ΄λΈλ¦¬λ“ + λ²΅ν„° ν‰κ· ν™”**

```
[1λ‹¨κ³„: μ„Έμ… κΈ°λ° ν•„ν„°λ§]
chatIdμ μµκ·Ό ν”Όλ“λ°± β†’ μ‚¬μ©μκ°€ μΆ‹μ•„ν• λ„μ„ λ©λ΅ μ¶”μ¶

[2λ‹¨κ³„: μ„ νΈ λ²΅ν„° κ³„μ‚°]
μΆ‹μ•„ν• λ„μ„λ“¤μ μ„λ² λ”© ν‰κ·  β†’ μ‚¬μ©μ μ„ νΈ λ²΅ν„° μƒμ„±

[3λ‹¨κ³„: κ°μΈν™”λ μ¬μ •λ ¬]
μ›λ κ²€μƒ‰ κ²°κ³Ό + μ„ νΈ λ²΅ν„° μ μ‚¬λ„ β†’ κ°μΈν™”λ μμ„

[4λ‹¨κ³„: μ „μ²΄ μΈκΈ°λ„ λ³΄μ •]
ν”Όλ“λ°± μ μκ°€ λ†’μ€ λ„μ„ β†’ λ¶€μ¤νΈ μ μ©
```

---

## 3. λ°μ΄ν„° νλ¦„

### 3.1. ν„μ¬ μ‹μ¤ν… κµ¬μ΅°

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  Book Entity (μ΄λ―Έ μ„λ² λ”© λ³΄μ )                              β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”‚
β”‚  β”‚  id, title, author, publisher, ...                   β”‚  β”‚
β”‚  β”‚  embedding (float[1024]) β† BGE-M3 λ²΅ν„°              β”‚  β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                            β–²
                            β”‚ ν”Όλ“λ°±
                            β”‚
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚  SearchFeedback Entity (ν”Όλ“λ°± λ°μ΄ν„°)                      β”‚
β”‚  β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”‚
β”‚  β”‚  chatId (Long)         β†’ μ‚¬μ©μ μ‹λ³„μ                β”‚  β”‚
β”‚  β”‚  query (String)        β†’ κ²€μƒ‰μ–΄                       β”‚  β”‚
β”‚  β”‚  bookId (Long)         β†’ λ„μ„ ID                     β”‚  β”‚
β”‚  β”‚  type (FeedbackType)   β†’ GOOD(+1) or BAD(-1)        β”‚  β”‚
β”‚  β”‚  createdAt (OffsetDateTime)                          β”‚  β”‚
β”‚  β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”  β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### 3.2. κ°μΈν™” νμ΄ν”„λΌμΈ

```
[μ‚¬μ©μ κ²€μƒ‰]
   β”‚
   β–Ό
[1. μΌλ° ν•μ΄λΈλ¦¬λ“ κ²€μƒ‰]
   β†’ BookSearchResult (μ›λ κ²°κ³Ό)
   β”‚
   β–Ό
[2. chatIdλ΅ ν”Όλ“λ°± μ΅°ν]
   β†’ FeedbackService.getUserFeedback(chatId)
   β†’ μΆ‹μ•„ν• λ„μ„ ID λ©λ΅ μ¶”μ¶ (GOOD ν”Όλ“λ°±λ§)
   β”‚
   β–Ό
[3. μ„ νΈ λ²΅ν„° κ³„μ‚°]
   β†’ BookRepository.findEmbeddingsByIds(bookIds)
   β†’ μ„λ² λ”© ν‰κ·  κ³„μ‚°
   β†’ μ‚¬μ©μ μ„ νΈ λ²΅ν„° μƒμ„±
   β”‚
   β–Ό
[4. κ°μΈν™” μ¬μ •λ ¬]
   β†’ κ° λ„μ„λ³„ μ„ νΈ λ²΅ν„°μ™€μ μ μ‚¬λ„ κ³„μ‚°
   β†’ RRF μ μ + μ„ νΈ μ μ‚¬λ„ = μµμΆ… μ μ
   β”‚
   β–Ό
[5. κ°μΈν™”λ κ²°κ³Ό λ°ν™]
   β†’ BookSearchResult (κ°μΈν™”λ¨)
```

---

## 4. κµ¬ν„ κ³„ν

### Phase 1: λ„μ„ κΈ°λ° ν”Όλ“λ°± μ μν™” (2-3μ‹κ°„)

**λ©ν‘:** κ° λ„μ„λ³„ ν”Όλ“λ°± μ μλ¥Ό κ³„μ‚°ν•μ—¬ κ²€μƒ‰ κ²°κ³Όμ— λ°μ

**κµ¬ν„ λ‚΄μ©:**

```java
/**
 * λ„μ„λ³„ ν”Όλ“λ°± μ μ μ„λΉ„μ¤
 */
@Service
public class BookFeedbackScoreService {

    /**
     * λ„μ„λ³„ ν”Όλ“λ°± μ μ κ³„μ‚°
     *
     * μ μ = (GOOD - BAD) / μ „μ²΄ ν”Όλ“λ°± μ
     * λ²”μ„: -1.0 ~ 1.0
     */
    public Map<Long, Double> calculateBookFeedbackScores(List<Long> bookIds) {
        Map<Long, Double> scores = new HashMap<>();

        for (Long bookId : bookIds) {
            // 1. ν•΄λ‹Ή λ„μ„μ μ „μ²΄ ν”Όλ“λ°± μ΅°ν
            List<SearchFeedback> feedbacks =
                feedbackRepository.findByBookId(bookId);

            if (feedbacks.isEmpty()) {
                scores.put(bookId, 0.0);
                continue;
            }

            // 2. μ μ κ³„μ‚°
            long goodCount = feedbacks.stream()
                .filter(f -> f.getType() == FeedbackType.GOOD)
                .count();

            long badCount = feedbacks.stream()
                .filter(f -> f.getType() == FeedbackType.BAD)
                .count();

            double score = (double)(goodCount - badCount) / feedbacks.size();
            scores.put(bookId, score);
        }

        return scores;
    }
}
```

**κ²€μƒ‰ κ²°κ³Όμ— μ μ©:**

```java
// BookSearchResult μƒμ„± μ‹
Map<Long, Double> feedbackScores = bookFeedbackScoreService
    .calculateBookFeedbackScores(bookIds);

// κ° λ„μ„μ μ μμ— ν”Όλ“λ°± λ³΄λ„μ¤ μ¶”κ°€
double finalScore = rrfScore + (feedbackScore.get(bookId) * 0.1);
// ν”Όλ“λ°± μ μμ 10%λ¥Ό λ³΄λ„μ¤λ΅ λ°μ
```

---

### Phase 2: μ‚¬μ©μ μ„ νΈ λ²΅ν„° κ³„μ‚° (3-4μ‹κ°„)

**λ©ν‘:** μ‚¬μ©μκ°€ μΆ‹μ•„ν• λ„μ„λ“¤μ μ„λ² λ”© ν‰κ· μΌλ΅ μ„ νΈλ„λ¥Ό λ²΅ν„°ν™”

**κµ¬ν„ λ‚΄μ©:**

```java
/**
 * κ°μΈν™” μ¶”μ² μ„λΉ„μ¤
 */
@Service
public class PersonalizationService {

    private final FeedbackService feedbackService;
    private final BookRepository bookRepository;

    // μ‚¬μ©μκ°€ μµμ†ν• μ΄λ§νΌμ ν”Όλ“λ°±μ„ λ‚¨κ²¨μ•Ό κ°μΈν™” μ μ©
    private static final int MIN_FEEDBACK_COUNT = 3;

    // μµκ·Ό Nκ°μ ν”Όλ“λ°±λ§ λ°μ (μµμ‹  μ„ νΈλ„ λ°μ)
    private static final int MAX_FEEDBACK_COUNT = 20;

    /**
     * μ‚¬μ©μ μ„ νΈ λ²΅ν„° κ³„μ‚°
     *
     * @param chatId Telegram μ‚¬μ©μ ID
     * @return μ„ νΈ λ²΅ν„° (1024 μ°¨μ›) or null (ν”Όλ“λ°± λ¶€μ΅±)
     */
    public float[] calculateUserPreferenceVector(Long chatId) {
        log.info("μ„ νΈ λ²΅ν„° κ³„μ‚° μ‹μ‘: chatId={}", chatId);

        // 1. μ‚¬μ©μμ GOOD ν”Όλ“λ°±λ§ μ΅°ν
        List<SearchFeedback> feedbacks = feedbackService.getUserFeedback(chatId);

        List<Long> likedBookIds = feedbacks.stream()
            .filter(f -> f.getType() == FeedbackType.GOOD)
            .map(SearchFeedback::getBookId)
            .distinct()
            .limit(MAX_FEEDBACK_COUNT)  // μµκ·Ό 20κ°λ§
            .collect(Collectors.toList());

        // 2. ν”Όλ“λ°±μ΄ μ¶©λ¶„ν•μ§€ μ•μΌλ©΄ null λ°ν™
        if (likedBookIds.size() < MIN_FEEDBACK_COUNT) {
            log.info("ν”Όλ“λ°± λ¶€μ΅±: chatId={}, count={}",
                     chatId, likedBookIds.size());
            return null;
        }

        // 3. λ„μ„ μ„λ² λ”© μ΅°ν
        List<float[]> embeddings = bookRepository
            .findEmbeddingsByIds(likedBookIds);

        if (embeddings.isEmpty()) {
            log.warn("μ„λ² λ”©μ„ μ°Ύμ„ μ μ—†μ: chatId={}", chatId);
            return null;
        }

        // 4. ν‰κ·  λ²΅ν„° κ³„μ‚°
        float[] preferenceVector = calculateAverageVector(embeddings);

        log.info("μ„ νΈ λ²΅ν„° κ³„μ‚° μ™„λ£: chatId={}, likedBooks={}",
                 chatId, likedBookIds.size());

        return preferenceVector;
    }

    /**
     * λ²΅ν„° ν‰κ·  κ³„μ‚°
     *
     * @param embeddings λ²΅ν„° λ¦¬μ¤νΈ
     * @return ν‰κ·  λ²΅ν„°
     */
    private float[] calculateAverageVector(List<float[]> embeddings) {
        int size = embeddings.get(0).length;  // 1024
        float[] average = new float[size];

        // λ¨λ“  λ²΅ν„°μ ν•© κ³„μ‚°
        for (float[] embedding : embeddings) {
            for (int i = 0; i < size; i++) {
                average[i] += embedding[i];
            }
        }

        // ν‰κ·  κ³„μ‚°
        for (int i = 0; i < size; i++) {
            average[i] /= embeddings.size();
        }

        return average;
    }

    /**
     * μ‚¬μ©μλ³„ κ°μΈν™”λ κ²€μƒ‰
     *
     * @param chatId Telegram μ‚¬μ©μ ID
     * @param query κ²€μƒ‰μ–΄
     * @param pageable νμ΄μ§•
     * @return κ°μΈν™”λ κ²€μƒ‰ κ²°κ³Ό
     */
    public BookSearchResult personalizedSearch(
            Long chatId,
            String query,
            Pageable pageable
    ) {
        log.info("κ°μΈν™” κ²€μƒ‰: chatId={}, query={}", chatId, query);

        // 1. μΌλ° κ²€μƒ‰ μ‹¤ν–‰
        BookSearchRequest request = new BookSearchRequest(
            query, null, SearchType.HYBRID, null, false
        );
        BookSearchResult originalResult =
            bookSearchService.searchBooks(pageable, request);

        // 2. μ‚¬μ©μ μ„ νΈ λ²΅ν„° κ³„μ‚°
        float[] preferenceVector = calculateUserPreferenceVector(chatId);

        if (preferenceVector == null) {
            // κ°μΈν™” λ¶κ°€: μ›λ κ²°κ³Ό λ°ν™
            log.info("κ°μΈν™” λ¶κ°€: ν”Όλ“λ°± λ¶€μ΅±, chatId={}", chatId);
            return originalResult;
        }

        // 3. κ°μΈν™” μ¬μ •λ ¬
        List<BookSearchResponse> personalizedBooks =
            rerankWithPreference(preferenceVector, originalResult.getBooks().getContent());

        // 4. κ²°κ³Ό λ°ν™
        return BookSearchResult.builder()
            .books(new PageImpl<>(
                personalizedBooks,
                pageable,
                originalResult.getBooks().getTotalElements()
            ))
            .aiResponse(originalResult.getAiResponse())
            .build();
    }

    /**
     * μ„ νΈλ„ κΈ°λ° μ¬μ •λ ¬
     *
     * @param preferenceVector μ„ νΈ λ²΅ν„°
     * @param books κ²€μƒ‰ κ²°κ³Ό
     * @return μ¬μ •λ ¬λ λ„μ„ λ©λ΅
     */
    private List<BookSearchResponse> rerankWithPreference(
            float[] preferenceVector,
            List<BookSearchResponse> books
    ) {
        // 1. κ° λ„μ„λ³„ μ„ νΈλ„ μ μ‚¬λ„ κ³„μ‚°
        Map<Long, Double> preferenceScores = new HashMap<>();

        for (BookSearchResponse book : books) {
            if (book.getEmbedding() != null) {
                double similarity = cosineSimilarity(
                    preferenceVector,
                    book.getEmbedding()
                );
                preferenceScores.put(book.getId(), similarity);
            }
        }

        // 2. μ›λ RRF μ μ + μ„ νΈλ„ μ μ μ΅°ν•©
        // μ„ νΈλ„μ 30%λ§ λ°μ (κΈ°μ΅΄ κ²€μƒ‰ κ²°κ³Ό μ΅΄μ¤‘)
        final double PREFERENCE_WEIGHT = 0.3;

        return books.stream()
            .sorted((a, b) -> {
                double scoreA = (a.getRrfScore() != null ? a.getRrfScore() : 0) +
                               (preferenceScores.getOrDefault(a.getId(), 0.0) * PREFERENCE_WEIGHT);
                double scoreB = (b.getRrfScore() != null ? b.getRrfScore() : 0) +
                               (preferenceScores.getOrDefault(b.getId(), 0.0) * PREFERENCE_WEIGHT);
                return Double.compare(scoreB, scoreA);  // λ‚΄λ¦Όμ°¨μ
            })
            .collect(Collectors.toList());
    }

    /**
     * μ½”μ‚¬μΈ μ μ‚¬λ„ κ³„μ‚°
     */
    private double cosineSimilarity(float[] v1, float[] v2) {
        double dotProduct = 0.0;
        double norm1 = 0.0;
        double norm2 = 0.0;

        for (int i = 0; i < v1.length; i++) {
            dotProduct += v1[i] * v2[i];
            norm1 += v1[i] * v1[i];
            norm2 += v2[i] * v2[i];
        }

        return dotProduct / (Math.sqrt(norm1) * Math.sqrt(norm2));
    }
}
```

**BookRepositoryμ— μ„λ² λ”© μ΅°ν μ¶”κ°€:**

```java
public interface BookRepository extends JpaRepository<Book, Long> {

    /**
     * λ„μ„ ID λ©λ΅μΌλ΅ μ„λ² λ”© μ΅°ν
     *
     * @param bookIds λ„μ„ ID λ©λ΅
     * @return μ„λ² λ”© λ¦¬μ¤νΈ
     */
    @Query("SELECT b.embedding FROM Book b WHERE b.id IN :bookIds")
    List<float[]> findEmbeddingsByIds(@Param("bookIds") List<Long> bookIds);
}
```

---

### Phase 3: Telegram Bot μ—°λ™ (1μ‹κ°„)

**λ©ν‘:** κΈ°μ΅΄ κ²€μƒ‰ λ…λ Ήμ–΄λ¥Ό κ°μΈν™” κ²€μƒ‰μΌλ΅ λ³€κ²½

**κµ¬ν„ λ‚΄μ©:**

```java
// LibraryTelegramBot.java μμ •

private void handleSearch(Update update, String keyword) {
    Long chatId = update.getMessage().getChatId();
    log.info("[Telegram] κ°μΈν™” κ²€μƒ‰ μ‹μ‘: keyword={}, chatId={}", keyword, chatId);

    try {
        // 1. μµκ·Ό κ²€μƒ‰μ–΄ μ €μ¥
        callbackQueryHandler.setRecentQuery(chatId, keyword);

        // 2. κ°μΈν™” κ²€μƒ‰ μ‹¤ν–‰
        Pageable pageable = PageRequest.of(0, 5);
        BookSearchResult result = personalizationService.personalizedSearch(
            chatId, keyword, pageable
        );

        // 3. κ²°κ³Όμ— κ°μΈν™” μ—¬λ¶€ ν‘μ‹
        if (isPersonalized(result)) {
            // AI μ‘λ‹µμ— κ°μΈν™” λ©”μ‹μ§€ μ¶”κ°€
            addPersonalizationMessage(result);
        }

        // 4. μ‘λ‹µ μ „μ†΅
        sendSearchResult(chatId, keyword, result);

    } catch (Exception e) {
        log.error("[Telegram] κ²€μƒ‰ μ‹¤ν¨: keyword={}, chatId={}", keyword, chatId, e);
        sendSimpleMessage(chatId, "κ²€μƒ‰ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.");
    }
}

private boolean isPersonalized(BookSearchResult result) {
    // κ²°κ³Όμ— κ°μΈν™”κ°€ μ μ©λμ—λ”μ§€ ν™•μΈ
    // (μ: ν”λκ·Έ ν•„λ“ μ¶”κ°€)
    return result.isPersonalized();
}

private void addPersonalizationMessage(BookSearchResult result) {
    // AI μ‘λ‹µμ— κ°μΈν™” μ•λ‚΄ μ¶”κ°€
    String message = "π’ νμ›λ‹μ μ·¨ν–¥μ„ λ°μν• μ¶”μ²μ…λ‹λ‹¤!";
    result.setAiResponse(result.getAiResponse() + "\n\n" + message);
}
```

---

## 5. κΈ°λ€ ν¨κ³Ό

### 5.1. μ„±λ¥ μ§€ν‘

```
[κ°μΈν™” μ „]
κ²€μƒ‰μ–΄: "μλ°”"
κ²°κ³Ό: μΌλ°μ μΈ μΈκΈ° μλ°” λ„μ„λ“¤

[κ°μΈν™” ν›„]
κ²€μƒ‰μ–΄: "μλ°”" + μ‚¬μ©μκ°€ "μ›Ή κ°λ°" κ΄€λ ¨ λ„μ„λ¥Ό μΆ‹μ•„ν•¨
κ²°κ³Ό: μ¤ν”„λ§, μ›Ή ν”„λ μ„μ›ν¬ κ΄€λ ¨ μλ°” λ„μ„ μƒμ„ λ…Έμ¶
```

### 5.2. μΈ΅μ • λ°©λ²•

1. **A/B ν…μ¤νΈ**
   - Aκ·Έλ£Ή: μΌλ° κ²€μƒ‰
   - Bκ·Έλ£Ή: κ°μΈν™” κ²€μƒ‰
   - λΉ„κµ: ν”Όλ“λ°± μ μ, μ¬κ²€μƒ‰λ¥ 

2. **λ©”νΈλ¦­**
   - κΈμ • ν”Όλ“λ°± λΉ„μ¨ (goodRatio)
   - κ²€μƒ‰ λ§μ΅±λ„ (feedbackScore)
   - μ¬κ²€μƒ‰λ¥  (κ°™μ€ μ‚¬μ©μκ°€ λ‹¤μ‹ κ²€μƒ‰ν•λ” λΉ„μ¨)

---

## 6. ν•κ³„μ κ³Ό λ€μ•

### 6.1. Telegram chatIdμ ν•κ³„

```
[λ¬Έμ ]
- μ‚¬μ©μκ°€ Botμ„ μ‚­μ  ν›„ μ¬μ„¤μΉν•λ©΄ chatIdκ°€ λ³€κ²½λ¨
- μ—¬λ¬ κΈ°κΈ°μ—μ„ μ‚¬μ©ν•λ©΄ chatIdκ°€ λ‹¤λ¦„
- μΉκµ¬μ—κ² ν•Έλ“ν°μ„ λΉλ ¤μ£Όλ©΄ λ‹¤λ¥Έ μ‚¬λμΌλ΅ μΈμ‹λ¨

[ν•΄κ²° λ°©λ²•]
1. λ‹¨κΈ° μ„Έμ…μΌλ΅λ§ ν™μ© (μµκ·Ό 1~2μ£Ό)
2. μ¥κΈ° μ €μ¥μ€ μμ  (μ£ΌκΈ°μ  μ •λ¦¬)
3. μµλ…μ„± μ΅΄μ¤‘ (κ°μΈμ •λ³΄ μμ§‘ μµμ†ν™”)
```

### 6.2. μ½λ“ μ¤νƒ€νΈ λ¬Έμ 

```
[λ¬Έμ ]
- μ‹ κ· μ‚¬μ©μλ” ν”Όλ“λ°±μ΄ μ—†μ–΄ κ°μΈν™” λ¶κ°€

[ν•΄κ²° λ°©λ²•]
1. ν”Όλ“λ°± 3κ° μ΄μƒ μ‹ κ°μΈν™” μ‹μ‘
2. κ·Έ μ „μ—λ” μ „μ²΄ μΈκΈ°λ„ λ°μ
3. "κ²€μƒ‰ ν›„ ν”Όλ“λ°±μ„ λ‚¨κ²¨μ£Όμ„Έμ”!" μ•λ‚΄ λ©”μ‹μ§€
```

### 6.3. ν™•μ¥μ„±

```
[ν–¥ν›„ κ°μ„ ]
1. λ΅κ·ΈμΈ μ‹μ¤ν… λ„μ… μ‹ μκµ¬μ μΈ user_idλ΅ λ§μ΄κ·Έλ μ΄μ…
2. λ„μ„ μΉ΄ν…κ³ λ¦¬, νƒκ·Έ μ •λ³΄ ν™μ©
3. ν‘μ—… ν•„ν„°λ§ (λΉ„μ·ν• μ·¨ν–¥μ μ‚¬μ©μ μ¶”μ²)
```

---

## 7. κµ¬ν„ μμ„

### 1μ£Όμ°¨: κΈ°λ° κµ¬μ¶•
- [ ] BookFeedbackScoreService κµ¬ν„
- [ ] λ„μ„λ³„ ν”Όλ“λ°± μ μ μΊμ‹±
- [ ] κ²€μƒ‰ κ²°κ³Όμ— ν”Όλ“λ°± μ μ λ°μ

### 2μ£Όμ°¨: κ°μΈν™” μ„λΉ„μ¤
- [ ] PersonalizationService κµ¬ν„
- [ ] BookRepositoryμ— μ„λ² λ”© μ΅°ν μ¶”κ°€
- [ ] μ„ νΈ λ²΅ν„° κ³„μ‚° λ΅μ§ κµ¬ν„

### 3μ£Όμ°¨: Bot μ—°λ™
- [ ] LibraryTelegramBotμ— κ°μΈν™” κ²€μƒ‰ μ—°λ™
- [ ] κ°μΈν™” μ—¬λ¶€ ν‘μ‹ λ©”μ‹μ§€ μ¶”κ°€
- [ ] μ—λ¬ μ²λ¦¬ λ° λ΅κΉ…

### 4μ£Όμ°¨: ν…μ¤νΈ λ° μµμ ν™”
- [ ] λ‹¨μ„ ν…μ¤νΈ μ‘μ„±
- [ ] ν†µν•© ν…μ¤νΈ
- [ ] μ„±λ¥ μµμ ν™” (μΊμ‹±, λΉ„λ™κΈ°)
- [ ] A/B ν…μ¤νΈ μ„¤κ³„

---

## 8. ν•™μµ μ²΄ν¬λ¦¬μ¤νΈ

λ‹¤μ λ‚΄μ©μ„ μ΄ν•΄ν–λ”μ§€ ν™•μΈν•΄ λ³΄μ„Έμ”:

- [ ] λ΅κ·ΈμΈ μ—†λ” μµλ… κ°μΈν™”μ ν•κ³„λ¥Ό μ•λ‹¤
- [ ] λ²΅ν„° ν‰κ· ν™”λ΅ μ‚¬μ©μ μ„ νΈλ¥Ό ν‘ν„ν•  μ μλ‹¤
- [ ] μ½”μ‚¬μΈ μ μ‚¬λ„λ΅ μ¬μ •λ ¬ν•  μ μλ‹¤
- [ ] μ½λ“ μ¤νƒ€νΈ λ¬Έμ μ™€ ν•΄κ²° λ°©λ²•μ„ μ•λ‹¤
- [ ] Telegram chatIdμ νΉμ„±μ„ μ΄ν•΄ν•λ‹¤
- [ ] κ°μΈν™” κ²€μƒ‰ νμ΄ν”„λΌμΈμ„ κµ¬ν„ν•  μ μλ‹¤

---

## 9. μ°Έκ³  μλ£

- [Vector Embeddings for Recommendations](https://www.pinecone.io/learn/vector-recommendations/)
- [Collaborative Filtering vs Content-Based](https://www.datasciencecentral.com/collaborative-filtering-vs-content-based-recommendations/)
- [Cold Start Problem in Recommender Systems](https://arxiv.org/abs/1907.01155)
- [Cosine Similarity for Recommendations](https://www.sciencedirect.com/science/article/pii/S1877050920316842)

---

## 10. λ‹¤μ λ‹¨κ³„

μ΄ λ¬Έμ„λ¥Ό ν•™μµν• ν›„:
1. Phase 1λ¶€ν„° μμ°¨μ μΌλ΅ κµ¬ν„
2. κ° Phase μ™„λ£ ν›„ ν…μ¤νΈ
3. μ‹¤μ  μ‚¬μ© λ°μ΄ν„°λ΅ ν¨κ³Ό μΈ΅μ •
4. μ μ§„μ μΌλ΅ κ°μ„ 

[κµ¬ν„ μ‹μ‘: Phase 1 β†’](./02.personalization-implementation.md)

**μ°Έκ³ : μ΄ λ¬Έμ„λ” Step 5μ—μ„ μμ§‘ν• ν”Όλ“λ°± λ°μ΄ν„°λ¥Ό ν™μ©ν•λ” λ°©λ²•μ„ λ‹¤λ£Ήλ‹λ‹¤. Step 5κ°€ μ™„λ£λμ§€ μ•μ•λ‹¤λ©΄ λ¨Όμ € [Step 5](../step-5/)λ¥Ό μ™„λ£ν•μ„Έμ”.**
